<!DOCTYPE html>
<html lang="ru" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="buyLinksTitle">Купить ссылки - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/modern-table.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        /* Progress modal width override */
        #progressModal .modal-dialog {
            max-width: 720px !important;
            width: 720px !important;
        }

        /* Add bottom padding to body when sticky bar is active */
        body.sticky-bar-active {
            padding-bottom: 80px;
        }

        /* Content dropdown - show full text without truncation */
        .content-dropdown {
            min-width: 250px !important;
            max-width: 400px !important;
            width: auto !important;
        }

        .content-dropdown option {
            white-space: normal !important;
            overflow: visible !important;
            text-overflow: clip !important;
            padding: 8px 12px;
        }

        /* Table styles from placements-manager.html */
        .links-table {
            width: 100%;
            border-collapse: collapse;
        }

        .links-table thead {
            background: #f9fafb;
        }

        .links-table th {
            padding: 10px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        .links-table th.text-center {
            text-align: center;
        }

        .links-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }

        .links-table tbody tr:hover {
            background: #f9fafb;
        }

        .links-table td {
            padding: 10px 8px;
            font-size: 13px;
            color: #374151;
            white-space: nowrap;
        }

        .links-table td.text-center {
            text-align: center;
        }

        /* SEO Metrics columns - голубой фон */
        .seo-metric-th,
        .seo-metric-td {
            background: #eff6ff !important;
        }

        .seo-metric-th {
            color: #1d4ed8 !important;
            font-weight: 600 !important;
        }

        /* Metric colors */
        .metric-green { color: #15803d; font-weight: 600; }
        .metric-blue { color: #2563eb; font-weight: 600; }
        .metric-orange { color: #c2410c; font-weight: 600; }
        .metric-gray { color: #9ca3af; }

        /* Pagination wrapper */
        .pagination-wrapper {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .pagination-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-left span {
            font-size: 14px;
            color: #4b5563;
        }

        .pagination-left select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .pagination-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-info {
            font-size: 14px;
            color: #4b5563;
            margin-right: 16px;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled):not(.active) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        .pagination-arrow {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-arrow:hover:not(:disabled) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination-arrow:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #pageNumbers, #bottomPageNumbers {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* ===== Block Headers - GRAY style (React reference: bg-gray-50) ===== */
        .placements-card-header.header-settings,
        .placements-card-header.header-calendar {
            background: #f9fafb;
            border-bottom: 2px solid #e5e7eb;
            padding: 16px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .placements-card-header .header-icon {
            width: 20px;
            height: 20px;
            color: #6b7280;
            font-size: 20px;
        }

        .placements-header-text h5 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: #111827;
        }

        .placements-header-text p {
            display: none; /* No subtitle in React reference */
        }

        /* Form labels with asterisk */
        .placements-form-label {
            display: block;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            margin-bottom: 8px;
        }

        .placements-form-label .required {
            color: #ef4444;
            margin-left: 2px;
        }

        /* Custom radio buttons (circular style from React) */
        .placements-radio-modern {
            display: flex;
            gap: 16px;
        }

        .placements-radio-option {
            position: relative;
        }

        .placements-radio-option input[type="radio"] {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .placements-radio-option label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            color: #374151;
        }

        .placements-radio-option label:hover {
            border-color: #d1d5db;
            background: #f9fafb;
        }

        .placements-radio-option input[type="radio"]:checked + label {
            border-color: #8b5cf6;
            background: #faf5ff;
        }

        .placements-radio-option.green-style input[type="radio"]:checked + label {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        /* Custom radio circle indicator */
        .radio-circle {
            width: 20px;
            height: 20px;
            border: 2px solid #d1d5db;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .placements-radio-option input[type="radio"]:checked + label .radio-circle {
            border-color: #8b5cf6;
            border-width: 6px;
        }

        .placements-radio-option.green-style input[type="radio"]:checked + label .radio-circle {
            border-color: #22c55e;
            border-width: 6px;
        }

        /* ===== Slider Container - Orange gradient background (React reference) ===== */
        .slider-container {
            margin-top: 24px;
            padding: 20px;
            background: linear-gradient(to bottom right, #fff7ed, #fffbeb, #fefce8);
            border: 2px solid #fed7aa;
            border-radius: 16px;
        }

        .slider-title {
            display: block;
            font-size: 14px;
            font-weight: 700;
            color: #111827;
            margin-bottom: 16px;
        }

        /* Slider wrapper */
        .slider-wrapper {
            position: relative;
            padding-bottom: 16px;
        }

        /* Slider labels row: min | badge | max */
        .slider-labels-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 8px;
        }

        .slider-min-label,
        .slider-max-label {
            font-size: 12px;
            font-weight: 600;
            color: #6b7280;
        }

        /* Badge "Выбрано: X дней" */
        .slider-badge {
            background: linear-gradient(to right, #f97316, #ea580c);
            color: white;
            padding: 6px 16px;
            border-radius: 9999px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 4px 6px -1px rgba(249, 115, 22, 0.3);
            white-space: nowrap;
        }

        /* Slider track with gradient (orange to red) */
        .slider-track-wrapper {
            position: relative;
            height: 10px;
            border-radius: 9999px;
            background: linear-gradient(to right, #fdba74, #fb923c, #f97316, #ea580c, #dc2626);
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .slider-input {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 10px;
            -webkit-appearance: none;
            appearance: none;
            background: transparent;
            cursor: pointer;
            z-index: 2;
        }

        .slider-input::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #f97316;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            cursor: grab;
            margin-top: -7px;
        }

        .slider-input::-webkit-slider-thumb:active {
            cursor: grabbing;
            transform: scale(1.1);
        }

        .slider-input::-moz-range-thumb {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: white;
            border: 3px solid #f97316;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.15);
            cursor: grab;
        }

        /* Zone cards grid */
        .zone-cards {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .zone-card {
            padding: 12px;
            border-radius: 12px;
            text-align: center;
            transition: all 0.2s;
            cursor: default;
        }

        /* Zone card: Быстро (green) */
        .zone-card.fast {
            background: white;
            border: 2px solid #d1fae5;
        }
        .zone-card.fast.active {
            background: #dcfce7;
            border-color: #22c55e;
            box-shadow: 0 0 0 3px rgba(34, 197, 94, 0.2);
        }
        .zone-card.fast .zone-icon {
            color: #22c55e;
        }

        /* Zone card: Средне (orange) */
        .zone-card.medium {
            background: white;
            border: 2px solid #fed7aa;
        }
        .zone-card.medium.active {
            background: #fff7ed;
            border-color: #f97316;
            box-shadow: 0 0 0 3px rgba(249, 115, 22, 0.2);
        }
        .zone-card.medium .zone-icon {
            color: #f97316;
        }

        /* Zone card: Долго (red) */
        .zone-card.slow {
            background: white;
            border: 2px solid #fecaca;
        }
        .zone-card.slow.active {
            background: #fef2f2;
            border-color: #ef4444;
            box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.2);
        }
        .zone-card.slow .zone-icon {
            color: #ef4444;
        }

        .zone-card .zone-icon {
            font-size: 24px;
            margin-bottom: 4px;
        }

        .zone-card .zone-name {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin: 4px 0 2px 0;
        }

        .zone-card .zone-range {
            font-size: 12px;
            color: #6b7280;
        }

        /* Blue info block (React reference) */
        .info-block {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 16px;
            background: #eff6ff;
            border-radius: 12px;
            border: 1px solid #bfdbfe;
            margin-top: 20px;
        }

        .info-block-icon {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #3b82f6;
            font-size: 18px;
            flex-shrink: 0;
        }

        .info-block-text {
            font-size: 13px;
            color: #1e40af;
            line-height: 1.5;
        }

        .info-block-text strong {
            font-weight: 600;
        }

        /* ===== List Management Section (React reference) ===== */
        .list-management-section {
            padding: 24px;
            border-top: 1px solid #e5e7eb;
        }

        .list-management-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 16px;
        }

        @media (min-width: 768px) {
            .list-management-grid {
                grid-template-columns: 1fr 1fr;
            }
        }

        /* Card wrapper */
        .list-card {
            background: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px;
        }

        /* Card header with icon */
        .list-card-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }

        .list-card-icon {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .list-card-icon.whitelist {
            background: linear-gradient(135deg, #dcfce7, #bbf7d0);
        }

        .list-card-icon.whitelist i {
            color: #16a34a;
            font-size: 20px;
        }

        .list-card-icon.blacklist {
            background: linear-gradient(135deg, #fee2e2, #fecaca);
        }

        .list-card-icon.blacklist i {
            color: #dc2626;
            font-size: 20px;
        }

        .list-card-title {
            font-size: 16px;
            font-weight: 600;
            color: #111827;
        }

        .list-card-badge {
            font-size: 12px;
            font-weight: 500;
            padding: 2px 8px;
            border-radius: 9999px;
            margin-left: 8px;
        }

        .list-card-badge.whitelist {
            background: #dcfce7;
            color: #166534;
        }

        .list-card-badge.blacklist {
            background: #fee2e2;
            color: #991b1b;
        }

        /* Description text */
        .list-card-description {
            font-size: 13px;
            color: #6b7280;
            margin-bottom: 16px;
        }

        /* Gradient add button */
        .list-add-btn {
            width: 100%;
            padding: 10px 16px;
            border-radius: 12px;
            border: none;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-bottom: 12px;
        }

        .list-add-btn.whitelist {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(34, 197, 94, 0.3);
        }

        .list-add-btn.whitelist:hover:not(:disabled) {
            background: linear-gradient(135deg, #16a34a, #15803d);
        }

        .list-add-btn.blacklist {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 4px 6px -1px rgba(239, 68, 68, 0.3);
        }

        .list-add-btn.blacklist:hover:not(:disabled) {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
        }

        .list-add-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Action buttons row */
        .list-action-row {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .list-action-btn {
            padding: 8px 12px;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            background: white;
            font-size: 13px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .list-action-btn:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .list-action-btn i {
            font-size: 14px;
        }

        /* Items list */
        .list-items-container {
            margin-top: 12px;
            max-height: 200px;
            overflow-y: auto;
            display: none;
        }

        .list-items-container.show {
            display: block;
        }

        /* ===== Sortable Headers (React reference style) ===== */
        .sortable-th {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .sortable-th:hover {
            background: #f5f3ff !important;
        }

        .sortable-th .sort-icon {
            margin-left: 4px;
            font-size: 12px;
            color: #9ca3af; /* text-gray-400 */
            vertical-align: middle;
        }

        .sortable-th.sort-asc .sort-icon,
        .sortable-th.sort-desc .sort-icon {
            color: #9333ea; /* text-purple-600 */
        }

        .sortable-th.sort-asc .sort-icon::before {
            content: "↑";
        }

        .sortable-th.sort-desc .sort-icon::before {
            content: "↓";
        }

        .sortable-th:not(.sort-asc):not(.sort-desc) .sort-icon::before {
            content: "⇅";
        }

        /* ===== Modern Import Modal (React reference) ===== */
        #importListModal .modal-dialog {
            max-width: 640px;
        }

        #importListModal .modal-content {
            border: none;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        #importListModal .modal-header {
            border: none;
            padding: 20px 24px;
        }

        #importListModal .modal-header.whitelist-header {
            background: linear-gradient(135deg, #22c55e, #10b981);
        }

        #importListModal .modal-header.blacklist-header {
            background: linear-gradient(135deg, #ef4444, #f43f5e);
        }

        #importListModal .modal-header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
        }

        #importListModal .modal-title-wrapper {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        #importListModal .modal-title {
            color: white;
            font-weight: 700;
            font-size: 18px;
            margin: 0;
        }

        #importListModal .modal-title i {
            font-size: 22px;
        }

        #importListModal .modal-close-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            border-radius: 8px;
            padding: 6px;
            cursor: pointer;
            transition: all 0.2s;
            color: white;
        }

        #importListModal .modal-close-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        #importListModal .modal-body {
            padding: 24px;
        }

        #importListModal .import-description {
            font-size: 14px;
            color: #4b5563;
            margin-bottom: 16px;
        }

        #importListModal .import-description code {
            color: #db2777;
            font-weight: 600;
            background: transparent;
        }

        #importListModal .import-textarea {
            width: 100%;
            height: 256px;
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 14px;
            font-family: monospace;
            color: #374151;
            resize: none;
            transition: border-color 0.2s;
        }

        #importListModal .import-textarea:focus {
            outline: none;
            border-color: #8b5cf6;
        }

        #importListModal .import-info-block {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            margin-top: 16px;
            padding: 12px;
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: 8px;
        }

        #importListModal .import-info-block i {
            color: #2563eb;
            font-size: 16px;
            flex-shrink: 0;
            margin-top: 2px;
        }

        #importListModal .import-info-block p {
            font-size: 14px;
            color: #1d4ed8;
            margin: 0;
        }

        #importListModal .modal-footer {
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            padding: 16px 24px;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        #importListModal .btn-modal-cancel {
            padding: 10px 20px;
            background: white;
            border: 2px solid #d1d5db;
            border-radius: 12px;
            font-weight: 600;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        #importListModal .btn-modal-cancel:hover {
            background: #f9fafb;
        }

        #importListModal .btn-modal-import {
            padding: 10px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2);
        }

        #importListModal .btn-modal-import.whitelist-btn {
            background: linear-gradient(135deg, #22c55e, #10b981);
        }

        #importListModal .btn-modal-import.whitelist-btn:hover {
            background: linear-gradient(135deg, #16a34a, #059669);
        }

        #importListModal .btn-modal-import.blacklist-btn {
            background: linear-gradient(135deg, #ef4444, #f43f5e);
        }

        #importListModal .btn-modal-import.blacklist-btn:hover {
            background: linear-gradient(135deg, #dc2626, #e11d48);
        }

        /* ===== Sticky Action Bar (React reference) ===== */
        .sticky-action-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            border-top: 1px solid #e5e7eb;
            box-shadow: 0 -4px 6px -1px rgba(0, 0, 0, 0.1);
            z-index: 50;
            padding: 12px 24px;
        }

        .sticky-action-bar .action-buttons {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }

        .sticky-action-btn {
            display: flex !important;
            align-items: center !important;
            gap: 8px !important;
            padding: 8px 16px !important;
            background: white !important;
            border: 1px solid #d1d5db !important;
            border-radius: 8px !important;
            font-size: 14px !important;
            font-weight: 600 !important;
            color: #374151 !important;
            cursor: pointer !important;
            transition: all 0.2s !important;
        }

        .sticky-action-btn:hover:not(:disabled) {
            background: #f9fafb !important;
        }

        .sticky-action-btn:disabled {
            opacity: 0.5 !important;
            cursor: not-allowed !important;
        }

        .sticky-action-btn i {
            font-size: 16px !important;
            color: #6b7280 !important;
        }

        .sticky-action-btn.whitelist i {
            color: #6b7280 !important;
        }

        .sticky-action-btn.blacklist i {
            color: #6b7280 !important;
        }

        .sticky-action-btn.purchase i {
            color: #6b7280 !important;
        }

        .action-badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 2px 8px;
            background: #f3f4f6;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            font-weight: 700;
            color: #374151;
            min-width: 20px;
        }
    </style>
</head>
<body>
    <!-- Content will be wrapped by sidebar.js -->

    <div class="container-fluid">
        <!-- Unified Card: Project Selection + Publication Settings (React reference structure) -->
        <div class="placements-card">
            <!-- Section 1: Выбор проекта (with border-b) -->
            <div class="placements-unified-section section-with-border">
                <h3 class="placements-section-title">
                    <i class="bi bi-gear"></i>
                    <span data-i18n="projectSelection">Выбор проекта</span>
                </h3>
                <div style="max-width: 40%;">
                    <label for="projectSelect" class="placements-form-label"><span data-i18n="selectProject">Выберите проект</span> <span class="required">*</span></label>
                    <select class="placements-select" id="projectSelect">
                        <option value="" data-i18n="selectProjectPlaceholder">Выберите проект...</option>
                    </select>
                </div>
            </div>

            <!-- Section 2: Тип контента (with border-b) -->
            <div class="placements-unified-section section-with-border">
                <h3 class="placements-section-title">
                    <i class="bi bi-gear"></i>
                    <span data-i18n="contentType">Тип контента</span>
                </h3>
                <label class="placements-form-label"><span data-i18n="contentType">Тип контента</span> <span class="required">*</span></label>
                <div class="custom-radio-group">
                    <label class="custom-radio-label radio-blue">
                        <input type="radio" name="contentType" id="typeLinks" value="links">
                        <div class="radio-circle"></div>
                        <span data-i18n="mainPage">Main page</span>
                    </label>
                    <label class="custom-radio-label radio-purple">
                        <input type="radio" name="contentType" id="typeArticles" value="articles">
                        <div class="radio-circle"></div>
                        <span data-i18n="articles">Статьи</span>
                    </label>
                </div>
            </div>

            <!-- Section 3: Настройки публикации (with border-b for 4-section layout) -->
            <div class="placements-unified-section section-with-border">
                <h3 class="placements-section-title">
                    <i class="bi bi-calendar-event"></i>
                    <span data-i18n="publicationSettings">Настройки публикации</span>
                </h3>
                <label class="placements-form-label" data-i18n="publicationDate">Дата публикации</label>
                <div class="custom-radio-group vertical">
                    <label class="custom-radio-label radio-green">
                        <input type="radio" name="publishType" id="publishImmediate" value="immediate" checked>
                        <div class="radio-circle"></div>
                        <span data-i18n="publishImmediately">Опубликовать сразу</span>
                    </label>
                    <label class="custom-radio-label radio-orange">
                        <input type="radio" name="publishType" id="publishDistributed" value="distributed">
                        <div class="radio-circle"></div>
                        <span data-i18n="delayedPublication">Отложенная публикация (период)</span>
                    </label>
                </div>

                <!-- Slider container (hidden by default) -->
                <div id="distributedPeriodDiv" style="display: none;">
                    <div class="slider-container">
                        <label class="slider-title" data-i18n="distributionPeriod">Период распределения:</label>

                        <!-- Slider with labels and badge -->
                        <div class="slider-wrapper">
                            <div class="slider-track-wrapper">
                                <input type="range" class="slider-input" id="distributionPeriod"
                                       min="5" max="90" value="30" step="1">
                            </div>
                            <div class="slider-labels-row">
                                <span class="slider-min-label">5 <span data-i18n="days">дней</span></span>
                                <span class="slider-badge"><span data-i18n="selected">Выбрано</span>: <span id="selectedDays">30</span> <span data-i18n="days">дней</span></span>
                                <span class="slider-max-label">90 <span data-i18n="days">дней</span></span>
                            </div>
                        </div>

                        <!-- Zone cards -->
                        <div class="zone-cards">
                            <div class="zone-card fast active" id="zoneFast">
                                <div class="zone-icon"><i class="bi bi-lightning-charge-fill"></i></div>
                                <div class="zone-name" data-i18n="fast">Быстро</div>
                                <div class="zone-range">5-30 <span data-i18n="days">дней</span></div>
                            </div>
                            <div class="zone-card medium" id="zoneMedium">
                                <div class="zone-icon"><i class="bi bi-speedometer2"></i></div>
                                <div class="zone-name" data-i18n="medium">Средне</div>
                                <div class="zone-range">31-60 <span data-i18n="days">дней</span></div>
                            </div>
                            <div class="zone-card slow" id="zoneSlow">
                                <div class="zone-icon"><i class="bi bi-hourglass-split"></i></div>
                                <div class="zone-name" data-i18n="slow">Долго</div>
                                <div class="zone-range">61-90 <span data-i18n="days">дней</span></div>
                            </div>
                        </div>
                    </div>

                    <!-- Blue info block -->
                    <div class="info-block">
                        <div class="info-block-icon">
                            <i class="bi bi-info-circle-fill"></i>
                        </div>
                        <div class="info-block-text">
                            <strong data-i18n="recommendation">Рекомендация</strong>: <span data-i18n="distributionRecommendation">Распределение публикаций на 30-60 дней создает наиболее естественный профиль ссылок для поисковых систем.</span>
                        </div>
                    </div>

                    <div id="distributionPreview" class="placements-preview" style="display: none; margin-top: 16px;">
                        <i class="bi bi-info-circle"></i> <span id="distributionPreviewText"></span>
                    </div>
                </div>
            </div>

            <!-- Section 4: Доступные сайты (inside unified card, no border) -->
            <div class="placements-unified-section" id="sitesTableDiv" style="display: none;">
                <h3 class="placements-section-title">
                    <i class="bi bi-globe2" style="color: #22c55e;"></i>
                    <span data-i18n="availableSites">Доступные сайты</span>
                </h3>

                <!-- Active filters info -->
                <div class="mb-3">
                    <span id="activeFiltersInfo"></span>
                </div>

                <!-- Filters Row (React style) -->
                <div class="sites-filter-row">
                    <label class="custom-checkbox-label">
                        <input type="checkbox" id="hideAlreadyPurchasedCheckbox" checked>
                        <div class="checkbox-box">
                            <svg viewBox="0 0 24 24"><path d="M5 13l4 4L19 7"></path></svg>
                        </div>
                        <span data-i18n="hidePurchased">Скрыть купленные</span>
                    </label>
                    <div class="sites-filter-right">
                        <label data-i18n="geoFilter">Фильтр по GEO:</label>
                        <select class="geo-filter-select" id="geoFilter">
                            <option value="" data-i18n="allRegions">Все регионы</option>
                        </select>
                    </div>
                </div>

                <div class="placements-table-wrapper">
                        <table class="links-table">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllSites" onclick="toggleAllSites()">
                                    </th>
                                    <th data-i18n="site">Сайт</th>
                                    <th data-i18n="content">Контент</th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="dr" onclick="sortByColumn('dr')">DR <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="da" onclick="sortByColumn('da')">DA <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="tf" onclick="sortByColumn('tf')">TF <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="cf" onclick="sortByColumn('cf')">CF <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="ref_domains" onclick="sortByColumn('ref_domains')">RD <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="rd_main" onclick="sortByColumn('rd_main')">RDm <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="norm" onclick="sortByColumn('norm')">Norm <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="keywords" onclick="sortByColumn('keywords')">KW <span class="sort-icon"></span></th>
                                    <th class="text-center seo-metric-th sortable-th" data-sort="traffic" onclick="sortByColumn('traffic')">Traf <span class="sort-icon"></span></th>
                                    <th class="text-center">GEO</th>
                                    <th class="text-center" data-i18n="siteType">Тип</th>
                                    <th class="text-center" data-i18n="slots">Слоты</th>
                                    <th class="text-center" data-i18n="price">Цена</th>
                                    <th class="text-center" data-i18n="status">Статус</th>
                                    <th class="text-center" data-i18n="visibility">Видимость</th>
                                </tr>
                            </thead>
                            <tbody id="sitesTableBody">
                                <tr>
                                    <td colspan="18" class="text-center text-muted py-4" data-i18n="selectProjectAndContentType">
                                        Выберите проект и тип контента выше
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>

                    <!-- Bottom pagination -->
                    <div class="pagination-wrapper" id="bottomPaginationNav" style="display: none;">
                        <div class="pagination-left">
                            <span data-i18n="show">Показать:</span>
                            <select id="bottomItemsPerPage" onchange="changeBottomItemsPerPage(this.value)">
                                <option value="100" selected>100</option>
                                <option value="300">300</option>
                                <option value="500">500</option>
                            </select>
                            <span data-i18n="recordsPerPage">записей на странице</span>
                        </div>
                        <div class="pagination-right">
                            <span class="pagination-info" id="bottomPaginationInfo"></span>
                            <div class="pagination-buttons" id="bottomPaginationControls">
                                <!-- Pagination buttons will be inserted here -->
                            </div>
                        </div>
                    </div>

                    <!-- List Management Section (React style) -->
                    <div class="list-management-section" id="listManagementSection">
                        <div class="list-management-grid">
                            <!-- Whitelist Card -->
                            <div class="list-card">
                                <div class="list-card-header">
                                    <div class="list-card-icon whitelist">
                                        <i class="bi bi-check-circle-fill"></i>
                                    </div>
                                    <span class="list-card-title" data-i18n="whitelistTitle">Whitelist</span>
                                    <span class="list-card-badge whitelist" id="whitelistTotal">0</span>
                                </div>
                                <p class="list-card-description" data-i18n="whitelistDesc">Добавьте сайты в белый список для быстрого доступа</p>
                                <button type="button" class="list-add-btn whitelist" id="addToWhitelistBtn" onclick="addSelectedToWhitelist()" disabled>
                                    <i class="bi bi-plus-circle"></i>
                                    <span data-i18n="addSelected">Добавить выбранные</span>
                                    <span id="whitelistCount">(0)</span>
                                </button>
                                <div class="list-action-row">
                                    <button type="button" class="list-action-btn" onclick="importWhitelist()">
                                        <i class="bi bi-upload"></i> <span data-i18n="import">Импорт</span>
                                    </button>
                                    <button type="button" class="list-action-btn" onclick="toggleWhitelistView()">
                                        <i class="bi bi-eye"></i> <span data-i18n="showList">Показать</span>
                                    </button>
                                    <button type="button" class="list-action-btn" onclick="clearWhitelist()">
                                        <i class="bi bi-trash"></i> <span data-i18n="clear">Очистить</span>
                                    </button>
                                </div>
                                <div id="whitelistItems" class="list-items-container"></div>
                            </div>

                            <!-- Blacklist Card -->
                            <div class="list-card">
                                <div class="list-card-header">
                                    <div class="list-card-icon blacklist">
                                        <i class="bi bi-x-circle-fill"></i>
                                    </div>
                                    <span class="list-card-title" data-i18n="blacklistTitle">Blacklist</span>
                                    <span class="list-card-badge blacklist" id="blacklistTotal">0</span>
                                </div>
                                <p class="list-card-description" data-i18n="blacklistDescription">Скройте нежелательные сайты из списка</p>
                                <button type="button" class="list-add-btn blacklist" id="addToBlacklistBtn" onclick="addSelectedToBlacklist()" disabled>
                                    <i class="bi bi-plus-circle"></i>
                                    <span data-i18n="addSelected">Добавить выбранные</span>
                                    <span id="blacklistCount">(0)</span>
                                </button>
                                <div class="list-action-row">
                                    <button type="button" class="list-action-btn" onclick="importBlacklist()">
                                        <i class="bi bi-upload"></i> <span data-i18n="import">Импорт</span>
                                    </button>
                                    <button type="button" class="list-action-btn" onclick="toggleBlacklistView()">
                                        <i class="bi bi-eye"></i> <span data-i18n="showList">Показать</span>
                                    </button>
                                    <button type="button" class="list-action-btn" onclick="clearBlacklist()">
                                        <i class="bi bi-trash"></i> <span data-i18n="clear">Очистить</span>
                                    </button>
                                </div>
                                <div id="blacklistItems" class="list-items-container"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Bottom purchase button -->
                    <div class="text-center mt-4 mb-4" id="bottomPurchaseDiv" style="display: none;">
                        <button type="button" class="btn btn-dark btn-lg" onclick="createPlacement()" id="bottomPurchaseBtn" disabled style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: none; border-radius: 0.75rem;">
                            <i class="bi bi-cart-check-fill"></i> <span data-i18n="purchaseSelected">Купить</span>
                            <span class="badge bg-light text-dark ms-2" id="bottomPurchaseBadge">0</span>
                            <span class="badge bg-light text-dark ms-1" id="bottomPurchaseTotalBadge">$0.00</span>
                        </button>
                    </div>
            </div>
            <!-- End of Section 3: Доступные сайты -->

        </div>
        <!-- End of Unified Card -->

        <!-- Sticky Action Bar (React reference design) -->
        <div id="stickyActionBar" class="sticky-action-bar">
            <div class="action-buttons">
                <button type="button" class="sticky-action-btn whitelist" id="stickyWhitelistBtn" onclick="addSelectedToWhitelist()" disabled>
                    <i class="bi bi-check-circle-fill"></i>
                    <span data-i18n="whitelistTitle">Whitelist</span>
                    <span class="action-badge" id="whitelistBadge">0</span>
                </button>
                <button type="button" class="sticky-action-btn purchase" id="stickyPurchaseBtn" onclick="createPlacement()" disabled>
                    <i class="bi bi-cart-check-fill"></i>
                    <span data-i18n="purchaseSelected">Купить</span>
                    <span class="action-badge" id="purchaseBadge">0</span>
                    <span class="action-badge" id="purchaseTotalBadge">$0.00</span>
                </button>
                <button type="button" class="sticky-action-btn blacklist" id="stickyBlacklistBtn" onclick="addSelectedToBlacklist()" disabled>
                    <i class="bi bi-x-circle-fill"></i>
                    <span data-i18n="blacklistTitle">Blacklist</span>
                    <span class="action-badge" id="blacklistBadge">0</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Import List Modal (React reference design) -->
    <div class="modal fade" id="importListModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header whitelist-header" id="importModalHeader">
                    <div class="modal-header-content">
                        <div class="modal-title-wrapper">
                            <i class="bi bi-check-circle-fill" id="importModalIcon"></i>
                            <h5 class="modal-title" id="importListModalTitle">Import Whitelist Domains</h5>
                        </div>
                        <button type="button" class="modal-close-btn" data-bs-dismiss="modal">
                            <i class="bi bi-x-lg"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body">
                    <p class="import-description">
                        Enter domains (one per line). Format: <code>site.com</code> or <code>https://site.com</code>
                    </p>
                    <textarea class="import-textarea" id="importDomainsText" placeholder="example.com&#10;https://another-site.com&#10;third-site.org"></textarea>
                    <div class="import-info-block">
                        <i class="bi bi-info-circle-fill"></i>
                        <p>Only domains that exist in the system will be added.</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn-modal-cancel" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn-modal-import whitelist-btn" id="importModalBtn" onclick="processImportedDomains()">Import</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Progress Modal for Async Batch Placements - Redesigned -->
    <div class="modal fade" id="progressModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered" style="max-width: 720px;">
            <div class="modal-content" style="border-radius: 24px; overflow: hidden; border: none; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);">
                <!-- Gradient Header -->
                <div class="modal-header border-0 py-4 px-4" style="background: linear-gradient(135deg, #2563eb 0%, #7c3aed 100%);">
                    <div class="d-flex align-items-center gap-3">
                        <div class="d-flex align-items-center justify-content-center" style="width: 48px; height: 48px; background: rgba(255,255,255,0.2); backdrop-filter: blur(8px); border-radius: 16px;">
                            <i class="bi bi-stars text-white" style="font-size: 24px;"></i>
                        </div>
                        <div>
                            <h5 class="modal-title text-white fw-bold mb-0" style="font-size: 18px;" data-i18n="bulkPurchase">Массовая покупка</h5>
                            <p class="text-white-50 mb-0" style="font-size: 13px;" data-i18n="processingPlacements">Обработка размещений...</p>
                        </div>
                    </div>
                </div>

                <div class="modal-body px-4 py-4">
                    <!-- Status and Progress -->
                    <div class="mb-4">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div class="d-flex align-items-center gap-2">
                                <i class="bi bi-clock text-purple" style="font-size: 18px;"></i>
                                <span id="progressStatus" class="fw-semibold" style="color: #111827;" data-i18n="startingPurchase">Начинаем покупку...</span>
                            </div>
                            <div class="d-flex align-items-center gap-1 px-3 py-1" style="background: #f3e8ff; border-radius: 20px; border: 1px solid #e9d5ff;">
                                <i class="bi bi-graph-up-arrow" style="color: #9333ea; font-size: 12px;"></i>
                                <span id="progressPercent" class="fw-bold" style="color: #9333ea; font-size: 14px;">0%</span>
                            </div>
                        </div>
                        <div class="progress" style="height: 10px; border-radius: 10px; background: #e5e7eb;">
                            <div id="progressBar" class="progress-bar" role="progressbar" style="width: 0%; background: linear-gradient(90deg, #3b82f6, #8b5cf6); border-radius: 10px; transition: width 0.3s ease;"></div>
                        </div>
                    </div>

                    <!-- Stats Cards -->
                    <div class="row g-3 mb-4">
                        <div class="col-4">
                            <div class="text-center p-3" style="background: #f9fafb; border: 2px solid #e5e7eb; border-radius: 16px;">
                                <div class="d-flex align-items-center justify-content-center mb-2" style="width: 44px; height: 44px; background: #374151; border-radius: 12px; margin: 0 auto;">
                                    <i class="bi bi-globe2 text-white" style="font-size: 20px;"></i>
                                </div>
                                <div id="progressTotal" class="fw-bold" style="font-size: 28px; color: #111827;">0</div>
                                <div class="text-uppercase fw-semibold" style="font-size: 10px; color: #6b7280; letter-spacing: 0.5px;" data-i18n="total">ВСЕГО</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3" style="background: #f0fdf4; border: 2px solid #bbf7d0; border-radius: 16px;">
                                <div class="d-flex align-items-center justify-content-center mb-2" style="width: 44px; height: 44px; background: #22c55e; border-radius: 12px; margin: 0 auto;">
                                    <i class="bi bi-check-circle text-white" style="font-size: 20px;"></i>
                                </div>
                                <div id="progressSuccessful" class="fw-bold" style="font-size: 28px; color: #16a34a;">0</div>
                                <div class="text-uppercase fw-semibold" style="font-size: 10px; color: #6b7280; letter-spacing: 0.5px;" data-i18n="successful">УСПЕШНО</div>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="text-center p-3" style="background: #fef2f2; border: 2px solid #fecaca; border-radius: 16px;">
                                <div class="d-flex align-items-center justify-content-center mb-2" style="width: 44px; height: 44px; background: #ef4444; border-radius: 12px; margin: 0 auto;">
                                    <i class="bi bi-exclamation-circle text-white" style="font-size: 20px;"></i>
                                </div>
                                <div id="progressFailed" class="fw-bold" style="font-size: 28px; color: #dc2626;">0</div>
                                <div class="text-uppercase fw-semibold" style="font-size: 10px; color: #6b7280; letter-spacing: 0.5px;" data-i18n="errors">ОШИБКИ</div>
                            </div>
                        </div>
                    </div>

                    <!-- Success Message (hidden by default, shown when complete) -->
                    <div id="progressResults" class="p-3 mb-3" style="background: #f0fdf4; border: 1px solid #bbf7d0; border-radius: 12px; display: none;">
                        <div class="d-flex align-items-start gap-2">
                            <i class="bi bi-check-circle-fill" style="color: #22c55e; font-size: 18px; margin-top: 2px;"></i>
                            <div>
                                <div class="fw-semibold" data-i18n="allPlacementsProcessed" style="color: #166534;">Все размещения обработаны!</div>
                                <div id="progressResultsList" style="color: #15803d; font-size: 14px;"></div>
                            </div>
                        </div>
                    </div>

                    <!-- Error Messages -->
                    <div id="progressErrors" class="p-3" style="background: #fef2f2; border: 1px solid #fecaca; border-radius: 12px; display: none;">
                        <div class="d-flex align-items-start gap-2">
                            <i class="bi bi-exclamation-triangle-fill" style="color: #dc2626; font-size: 18px; margin-top: 2px;"></i>
                            <div style="flex: 1;">
                                <div class="fw-semibold" data-i18n="errorsLabel" style="color: #991b1b;">Ошибки:</div>
                                <ul id="progressErrorsList" class="mb-0 ps-3" style="color: #b91c1c; font-size: 14px;"></ul>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Footer with centered button -->
                <div class="modal-footer border-0 justify-content-center py-4" style="background: #f9fafb;">
                    <button type="button" class="btn px-5 py-2" id="cancelJobBtn" onclick="cancelCurrentJob()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px;">
                        <i class="bi bi-x-lg me-2"></i><span data-i18n="cancelPurchase">Отменить покупку</span>
                    </button>
                    <button type="button" class="btn px-5 py-2" id="closeProgressBtn" onclick="closeProgressModal()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; display: none;">
                        <i class="bi bi-check-lg me-2"></i><span data-i18n="done">Готово</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/translations.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script>
        // Initialize sidebar navigation with i18n
        const lang = getLang();
        SidebarNav.init({
            activePage: 'purchase',
            pageTitle: lang === 'en' ? 'Buy Links' : 'Покупка ссылок',
            pageSubtitle: lang === 'en' ? 'Select sites for placement' : 'Выберите сайты для размещения',
            pageIcon: 'cart-check-fill',
            pageIconGradient: 'gradient-purple-pink'
        });

        // Apply translations
        if (typeof applyTranslations === 'function') {
            applyTranslations();
        }

        let projects = [];
        let sites = [];
        let projectLinks = [];
        let projectArticles = [];
        let progressModal;
        let currentJobId = null;
        let pollInterval = null;
        let selectedContentType = null;
        let siteAssignments = {}; // { siteId: { contentId, contentName } }
        let nextContentIndex = 0; // Round-robin index for auto-assignment
        let sitesPerPage = 100; // Default sites per page
        let currentPage = 1;
        let filteredSites = []; // Sites after filtering by project placements
        let whitelist = new Set(); // Set of site IDs in whitelist (stored but not auto-applied)
        let blacklist = new Set(); // Set of site IDs in blacklist (stored but not auto-applied)
        let whitelistActive = false; // Whether to apply whitelist filter
        let blacklistActive = false; // Whether to apply blacklist filter
        let hideAlreadyPurchased = true; // Whether to hide already purchased sites (default: active)
        let selectedGeo = ''; // GEO filter value (empty = show all)
        let selectedSitesForList = new Set(); // Track selected sites (not for placement, but for list operations)
        let currentImportTarget = 'whitelist'; // 'whitelist' or 'blacklist'
        let importListModal;
        let hasAvailableContent = false; // Whether project has links/articles to purchase
        let userPricing = null; // Pricing data with user's discount
        let currentSortColumn = null; // Current sort column (dr, da, tf, cf, etc.)
        let currentSortDirection = 'desc'; // Sort direction: 'asc' or 'desc'

        /**
         * Mask URL for premium sites (DR >= 20 OR DA >= 30)
         * Admins and Gold tier (discount >= 20%) see all URLs
         * Format: elearning-reviews.org → elear***ws.org
         */
        function maskUrl(url, dr, da) {
            const currentUser = getCurrentUser();
            const userDiscount = userPricing?.link?.discount || 0;
            const isAdminUser = currentUser?.role === 'admin';

            // Admins and Gold+ users (discount >= 20%) see all URLs
            if (isAdminUser || userDiscount >= 20) {
                return url;
            }

            // Only mask premium sites (DR >= 20 OR DA >= 30)
            if (dr < 20 && da < 30) {
                return url;
            }

            // Handle subdomains: sub.domain.com -> take only main domain part
            const parts = url.split('.');
            if (parts.length < 2) return url; // Invalid format, return as is

            const domain = parts.pop(); // org, com, ru
            const name = parts.pop(); // main domain name (e.g., 'domain' from 'sub.domain.com')

            // Very short names (3 chars or less): show first + ***
            if (name.length <= 3) {
                return name.slice(0, 1) + '***.' + domain;
            }

            // Short names (4-6 chars): show first 2 + *** + last 1
            if (name.length <= 6) {
                return name.slice(0, 2) + '***' + name.slice(-1) + '.' + domain;
            }

            // Normal names (7+ chars): show first 4 + *** + last 2
            return name.slice(0, 4) + '***' + name.slice(-2) + '.' + domain;
        }

        /**
         * Get metric color class based on value thresholds
         * High values (>=50) = green, Medium (>=20) = blue, Low (<20) = gray
         */
        function getMetricColorClass(value, isRating = true) {
            if (!isRating) return 'metric-gray';
            if (value >= 50) return 'metric-green';
            if (value >= 20) return 'metric-blue';
            return 'metric-gray';
        }

        /**
         * Sort sites table by SEO metric column
         * Toggles between ascending and descending order
         */
        function sortByColumn(column) {
            // Toggle direction if same column, otherwise default to desc
            if (currentSortColumn === column) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortColumn = column;
                currentSortDirection = 'desc'; // High values first by default
            }

            // Sort filteredSites array
            filteredSites.sort((a, b) => {
                const aVal = parseFloat(a[column]) || 0;
                const bVal = parseFloat(b[column]) || 0;

                if (currentSortDirection === 'asc') {
                    return aVal - bVal;
                } else {
                    return bVal - aVal;
                }
            });

            // Update header icons
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
                if (th.dataset.sort === column) {
                    th.classList.add(currentSortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
                }
            });

            // Reset to first page and re-render
            currentPage = 1;
            renderSitesTable();
        }

        /**
         * Reset sort state when loading new sites
         */
        function resetSort() {
            currentSortColumn = null;
            currentSortDirection = 'desc';
            document.querySelectorAll('.sortable-th').forEach(th => {
                th.classList.remove('sort-asc', 'sort-desc');
            });
        }

        document.addEventListener('DOMContentLoaded', async () => {
            progressModal = new bootstrap.Modal(document.getElementById('progressModal'));
            importListModal = new bootstrap.Modal(document.getElementById('importListModal'));

            document.getElementById('projectSelect').addEventListener('change', onProjectSelectedNew);
            document.getElementById('typeLinks').addEventListener('change', onContentTypeSelected);
            document.getElementById('typeArticles').addEventListener('change', onContentTypeSelected);

            // Add event listener for hide already purchased checkbox
            document.getElementById('hideAlreadyPurchasedCheckbox').addEventListener('change', async (e) => {
                hideAlreadyPurchased = e.target.checked;
                currentPage = 1; // Reset to first page

                // Re-load sites with filter if project and content type are selected
                const projectId = document.getElementById('projectSelect').value;
                if (projectId && selectedContentType) {
                    await loadSitesForPlacement(projectId, selectedContentType);
                }
            });

            // Add event listener for GEO filter dropdown
            document.getElementById('geoFilter').addEventListener('change', async (e) => {
                selectedGeo = e.target.value;
                currentPage = 1; // Reset to first page

                // Re-load sites with filter if project and content type are selected
                const projectId = document.getElementById('projectSelect').value;
                if (projectId && selectedContentType) {
                    await loadSitesForPlacement(projectId, selectedContentType);
                }
            });

            // Add event listeners for publication type radio buttons
            document.getElementById('publishImmediate').addEventListener('change', () => {
                document.getElementById('distributedPeriodDiv').style.display = 'none';
                updateCreateButtonState();
            });
            document.getElementById('publishDistributed').addEventListener('change', () => {
                document.getElementById('distributedPeriodDiv').style.display = 'block';
                updateDistributionPreview();
                updateCreateButtonState();
            });

            // Add event listener for distribution period slider (input event for real-time update)
            document.getElementById('distributionPeriod').addEventListener('input', (e) => {
                const value = parseInt(e.target.value);
                document.getElementById('selectedDays').textContent = value;

                // Update zone cards - highlight active zone based on value
                const zoneFast = document.getElementById('zoneFast');
                const zoneMedium = document.getElementById('zoneMedium');
                const zoneSlow = document.getElementById('zoneSlow');

                // Remove active class from all zones
                zoneFast.classList.remove('active');
                zoneMedium.classList.remove('active');
                zoneSlow.classList.remove('active');

                // Add active class to current zone
                if (value <= 30) {
                    zoneFast.classList.add('active');
                } else if (value <= 60) {
                    zoneMedium.classList.add('active');
                } else {
                    zoneSlow.classList.add('active');
                }

                updateDistributionPreview();
            });

            // Load projects and sites - auto-selection happens in loadProjects()
            await Promise.all([loadProjects(), loadSites(), loadPricing()]);

            // Load whitelist/blacklist from localStorage but DON'T apply filters
            loadListsFromStorage();
        });

        // Update GEO filter dropdown options from loaded sites
        function updateGeoFilterOptions() {
            const geoFilter = document.getElementById('geoFilter');
            const currentValue = geoFilter.value;

            // Collect unique GEO values from all sites
            const uniqueGeos = [...new Set(sites.map(site => site.geo || 'EN'))];

            // Sort alphabetically
            uniqueGeos.sort();

            // Rebuild options, preserving current selection
            geoFilter.innerHTML = '<option value="">Все регионы</option>' +
                uniqueGeos.map(geo =>
                    `<option value="${geo}" ${geo === currentValue ? 'selected' : ''}>${geo}</option>`
                ).join('');
        }

        async function loadPricing() {
            try {
                const response = await fetch('/api/billing/pricing', {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('token')}` }
                });
                if (!response.ok) throw new Error('Failed to load pricing');
                const result = await response.json();
                userPricing = result.data;
            } catch (error) {
                console.error('Failed to load pricing:', error);
                // Fallback to base prices without discount
                userPricing = {
                    link: { finalPrice: 25.00 },
                    article: { finalPrice: 15.00 }
                };
            }
        }

        async function loadProjects() {
            try {
                projects = await ProjectsAPI.getAll();
                populateProjectFilter();

                // Auto-select project: last selected or first project
                if (projects.length > 0) {
                    setTimeout(async () => {
                        const projectSelect = document.getElementById('projectSelect');
                        const typeLinks = document.getElementById('typeLinks');

                        // Проверить сохранённый проект в localStorage
                        const lastProjectId = localStorage.getItem('lastSelectedProjectId');
                        let selectedProjectId = projects[0].id; // По умолчанию первый проект

                        // Если сохранённый проект существует в списке, используем его
                        if (lastProjectId && projects.find(p => p.id === parseInt(lastProjectId))) {
                            selectedProjectId = parseInt(lastProjectId);
                        }

                        projectSelect.value = selectedProjectId;
                        typeLinks.checked = true;
                        selectedContentType = 'links';

                        // Load project data first
                        const projectData = await ProjectsAPI.get(selectedProjectId);
                        projectLinks = projectData.links || [];
                        projectArticles = projectData.articles || [];

                        // Then load sites table
                        await loadSitesForPlacement(selectedProjectId, 'links');
                    }, 100);
                }
            } catch (error) {
                showNotification('Failed to load projects: ' + error.message, 'error');
            }
        }

        async function loadSites() {
            try {
                // Use marketplace endpoint to get public sites + user's own sites
                sites = await SitesAPI.getMarketplace();
            } catch (error) {
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function populateProjectFilter() {
            const select = document.getElementById('projectSelect');
            select.innerHTML = '<option value="">Select project...</option>' +
                projects.map(p => `<option value="${p.id}">${escapeHtml(p.name)}</option>`).join('');
        }


        async function onProjectSelectedNew() {
            const projectId = document.getElementById('projectSelect').value;

            if (!projectId) {
                document.getElementById('sitesTableDiv').style.display = 'none';
                return;
            }

            // Сохранить выбранный проект в localStorage
            localStorage.setItem('lastSelectedProjectId', projectId);

            try {
                // Load project data
                const projectData = await ProjectsAPI.get(projectId);
                projectLinks = projectData.links || [];
                projectArticles = projectData.articles || [];

                // Auto-select Links and load sites
                document.getElementById('typeLinks').checked = true;
                selectedContentType = 'links';

                // Reset round-robin index
                nextContentIndex = 0;

                // Load sites table
                await loadSitesForPlacement(projectId, 'links');

                // Show sites table
                document.getElementById('sitesTableDiv').style.display = 'block';
            } catch (error) {
                showNotification('Failed to load project: ' + error.message, 'error');
            }
        }

        async function onContentTypeSelected() {
            selectedContentType = document.querySelector('input[name="contentType"]:checked')?.value;

            if (!selectedContentType) {
                document.getElementById('sitesTableDiv').style.display = 'none';
                return;
            }

            const projectId = document.getElementById('projectSelect').value;
            if (!projectId) return;

            // Reset round-robin index when content type changes
            nextContentIndex = 0;

            // Show sites table and load data
            document.getElementById('sitesTableDiv').style.display = 'block';
            await loadSitesForPlacement(projectId, selectedContentType);
        }

        async function loadSitesForPlacement(projectId, contentType) {
            try {
                // Get placements for this specific project with high limit to ensure we get ALL of them
                const placementsResponse = await fetch(`/api/placements?project_id=${projectId}&limit=500`, {
                    headers: { 'Authorization': `Bearer ${getAuthToken()}` }
                });
                const placementsData = await placementsResponse.json();
                const projectPlacements = placementsData.data || placementsData; // Extract data array if paginated

                console.log('Project placements loaded:', projectPlacements.length);
                console.log('Project ID:', projectId);

                console.log('Project placements:', projectPlacements);

                // Build map of sites with their content status (links and articles)
                // CRITICAL: Mark sites that already have placements for this project
                const sitesStatus = new Map();
                for (const placement of projectPlacements) {
                    if (!sitesStatus.has(placement.site_id)) {
                        sitesStatus.set(placement.site_id, { hasLinks: false, hasArticles: false });
                    }
                    const status = sitesStatus.get(placement.site_id);
                    // Use placement.type for reliable detection (link_count/article_count might be 0 in some cases)
                    if (placement.type === 'link' || placement.link_count > 0) status.hasLinks = true;
                    if (placement.type === 'article' || placement.article_count > 0) status.hasArticles = true;
                }

                // Get available content
                const availableContent = contentType === 'links' ? projectLinks : projectArticles;

                // Show warning if no content, but don't block site loading
                hasAvailableContent = availableContent.length > 0;
                if (!hasAvailableContent) {
                    showNotification(`Сначала добавьте ${contentType === 'links' ? 'ссылки' : 'гест-посты'} в проект`, 'warning');
                }

                // Apply whitelist/blacklist filtering ONLY if activated
                let sitesToShow = sites;

                // FIRST: Filter out sites that are not available for purchase
                sitesToShow = sitesToShow.filter(site => site.available_for_purchase !== false);

                // If whitelist is ACTIVE and not empty, show ONLY whitelist sites
                if (whitelistActive && whitelist.size > 0) {
                    sitesToShow = sitesToShow.filter(site => whitelist.has(site.id));
                }

                // If blacklist is ACTIVE and not empty, exclude blacklist sites
                if (blacklistActive && blacklist.size > 0) {
                    sitesToShow = sitesToShow.filter(site => !blacklist.has(site.id));
                }

                // If hideAlreadyPurchased is active, filter out already purchased sites
                if (hideAlreadyPurchased) {
                    sitesToShow = sitesToShow.filter(site => {
                        const status = sitesStatus.get(site.id) || { hasLinks: false, hasArticles: false };
                        const alreadyPurchased = status.hasLinks || status.hasArticles;
                        return !alreadyPurchased; // Exclude already purchased sites
                    });
                }

                // If GEO filter is active, filter by GEO value
                if (selectedGeo) {
                    sitesToShow = sitesToShow.filter(site => (site.geo || 'EN') === selectedGeo);
                }

                // Update GEO filter dropdown with available values
                updateGeoFilterOptions();

                // Prepare filtered sites with their status
                // NEW LOGIC: Red = already purchased (link OR article), cannot buy again
                filteredSites = sitesToShow.map(site => {
                    const status = sitesStatus.get(site.id) || { hasLinks: false, hasArticles: false };
                    const siteType = site.site_type || 'wordpress';

                    // Check if this site already has ANY placement for this project
                    const alreadyPurchased = status.hasLinks || status.hasArticles;

                    // Check if site type is incompatible with selected content type
                    const incompatibleType = (siteType === 'static_php' && contentType === 'articles');

                    // Check if site disallows articles (new check for allow_articles flag)
                    const articlesDisabled = (contentType === 'articles' && site.allow_articles === false);

                    // Determine status class and badge
                    let statusClass, statusBadge, isDisabled, disableReason;

                    if (alreadyPurchased) {
                        // Site already has placement for this project - mark red and disable
                        statusClass = 'table-danger';
                        statusBadge = '<span class="badge bg-danger">Уже куплено</span>';
                        isDisabled = true;
                        disableReason = 'Уже куплено';
                    } else if (incompatibleType) {
                        // Static PHP site cannot have articles
                        statusClass = 'table-warning';
                        statusBadge = '<span class="badge bg-warning">Только ссылки</span>';
                        isDisabled = true;
                        disableReason = 'Статичные сайты поддерживают только ссылки';
                    } else if (articlesDisabled) {
                        // Site owner disabled article placements
                        statusClass = 'table-secondary';
                        statusBadge = '<span class="badge bg-secondary">Статьи отключены</span>';
                        isDisabled = true;
                        disableReason = 'Владелец сайта отключил размещение гест-постов';
                    } else {
                        // Site available for purchase
                        statusClass = '';
                        statusBadge = '<span class="badge bg-success">Доступно</span>';
                        isDisabled = false;
                        disableReason = '';
                    }

                    return { ...site, statusClass, statusBadge, isDisabled, disableReason, siteType };
                });

                // Reset assignments and round-robin index
                siteAssignments = {};
                nextContentIndex = 0;
                resetSort(); // Reset sort state when loading new sites

                // Hide sticky action bar on project/type change
                const actionBar = document.getElementById('stickyActionBar');
                if (actionBar) {
                    actionBar.classList.remove('show');
                    document.body.classList.remove('sticky-bar-active');
                }

                // Reset to first page and render
                currentPage = 1;
                renderSitesTable();

                // Show the table
                document.getElementById('sitesTableDiv').style.display = 'block';

            } catch (error) {
                console.error('Error loading sites for placement:', error);
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function renderSitesTable() {
            // Update active filters info
            updateActiveFiltersInfo();

            if (filteredSites.length === 0) {
                const tbody = document.getElementById('sitesTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr><td colspan="18" class="text-center text-warning">
                            No sites match current filters. Try clearing whitelist/blacklist.
                        </td></tr>
                    `;
                }
                return;
            }

            const contentType = selectedContentType;
            const availableContent = contentType === 'links' ? projectLinks : projectArticles;

            // Calculate pagination
            const totalSites = filteredSites.length;
            const totalPages = Math.ceil(totalSites / sitesPerPage);
            const startIndex = (currentPage - 1) * sitesPerPage;
            const endIndex = Math.min(startIndex + sitesPerPage, totalSites);
            const pageSites = filteredSites.slice(startIndex, endIndex);

            // Update sites count info
            const sitesCountEl = document.getElementById('sitesCountInfo');
            if (sitesCountEl) {
                sitesCountEl.textContent = `${t('showing')} ${startIndex + 1}-${endIndex} ${t('of')} ${totalSites} ${t('sitesLabel')}`;
            }

            // Build dropdown options for available content with usage counters
            // FILTER OUT EXHAUSTED CONTENT - only show items with usage_count < usage_limit
            const contentOptions = availableContent
                .filter(item => {
                    const usageCount = item.usage_count || 0;
                    const usageLimit = item.usage_limit || (contentType === 'articles' ? 1 : 999);
                    return usageCount < usageLimit; // Only show available items
                })
                .map(item => {
                    const displayName = contentType === 'links'
                        ? escapeHtml(item.anchor_text)
                        : escapeHtml(item.title);
                    const usageCount = item.usage_count || 0;
                    const usageLimit = item.usage_limit || (contentType === 'articles' ? 1 : 999);
                    const counter = `${usageCount}/${usageLimit}`;

                    // Validate ID is integer to prevent XSS
                    const safeId = parseInt(item.id);
                    if (isNaN(safeId)) {
                        console.error('Invalid item ID:', item.id);
                        return '';
                    }

                    return `<option value="${safeId}">${displayName} (${escapeHtml(counter)})</option>`;
                }).join('');

            // Render table rows for current page
            const tbody = document.getElementById('sitesTableBody');
            if (!tbody) return; // Element not found, exit early
            tbody.innerHTML = pageSites.map(site => {
                const dropdownHtml = site.isDisabled
                    ? '-'
                    : `<select class="form-select form-select-sm content-dropdown" id="content_${site.id}" style="display: none;">
                           <option value="">Select ${contentType === 'links' ? 'link' : 'article'}...</option>
                           ${contentOptions}
                       </select>`;

                // Site type badge
                const siteType = site.siteType || 'wordpress';
                const siteTypeBadge = siteType === 'wordpress'
                    ? '<span class="badge bg-secondary ms-1"><i class="bi bi-wordpress"></i> WP</span>'
                    : '<span class="badge bg-success ms-1"><i class="bi bi-filetype-php"></i> PHP</span>';

                // Visibility badge
                const visibilityBadge = site.is_public
                    ? `<span class="badge bg-info ms-1"><i class="bi bi-globe"></i> ${t('publicSite')}</span>`
                    : `<span class="badge bg-secondary ms-1"><i class="bi bi-lock-fill"></i> ${t('privateSite')}</span>`;

                // Disable reason tooltip
                const tooltipAttr = site.disableReason
                    ? `title="${escapeHtml(site.disableReason)}" data-bs-toggle="tooltip"`
                    : '';

                // Clean URL - remove https:// and trailing slash
                const cleanUrl = site.site_url.replace(/^https?:\/\//, '').replace(/\/$/, '');

                // DR value with color coding
                const drValue = site.dr || 0;
                const drClass = drValue >= 50 ? 'text-success fw-bold' : drValue >= 20 ? 'text-primary' : 'text-muted';

                // DA value with color coding
                const daValue = site.da || 0;
                const daClass = daValue >= 50 ? 'text-success fw-bold' : daValue >= 20 ? 'text-primary' : 'text-muted';

                // TF value with color coding (Majestic Trust Flow, 0-100)
                const tfValue = site.tf || 0;
                const tfClass = tfValue >= 50 ? 'text-success fw-bold' : tfValue >= 20 ? 'text-primary' : 'text-muted';

                // CF value with color coding (Majestic Citation Flow, 0-100)
                const cfValue = site.cf || 0;
                const cfClass = cfValue >= 50 ? 'text-success fw-bold' : cfValue >= 20 ? 'text-primary' : 'text-muted';

                // Ref Domains, RD Main, Norm values
                const refDomainsValue = site.ref_domains || 0;
                const rdMainValue = site.rd_main || 0;
                const normValue = site.norm || 0;

                // Keywords and Traffic values (Ahrefs)
                const keywordsValue = site.keywords || 0;
                const trafficValue = site.traffic || 0;

                // GEO value (country code, default EN)
                const geoValue = site.geo || 'EN';

                // Price based on content type (with user's discount)
                // SPECIAL: $0.10 for user's own sites
                const currentUser = getCurrentUser();
                const isOwnSite = site.user_id === currentUser?.id;
                const price = isOwnSite
                    ? 0.10
                    : parseFloat(contentType === 'links'
                        ? (userPricing?.link?.finalPrice || 25)
                        : (userPricing?.article?.finalPrice || 15));

                // Slot availability display (dynamic based on content type)
                let slotsDisplay = '';
                let slotsClass = 'text-muted';
                if (contentType === 'links') {
                    // Main X/Y - used/total on main page
                    const usedLinks = site.used_links || 0;
                    const maxLinks = site.max_links || 0;
                    slotsDisplay = `Main ${usedLinks}/${maxLinks}`;
                    // Color coding: green if < 50% used, yellow if 50-80%, red if > 80%
                    if (maxLinks > 0) {
                        const usagePercent = (usedLinks / maxLinks) * 100;
                        slotsClass = usagePercent < 50 ? 'text-success' : usagePercent < 80 ? 'text-warning' : 'text-danger';
                    }
                } else {
                    // Articles X/Y - bought/remaining
                    const usedArticles = site.used_articles || 0;
                    const maxArticles = site.max_articles || 0;
                    const remaining = maxArticles - usedArticles;
                    slotsDisplay = `Art ${usedArticles}/${remaining}`;
                    // Color coding based on remaining slots
                    if (maxArticles > 0) {
                        const usagePercent = (usedArticles / maxArticles) * 100;
                        slotsClass = usagePercent < 50 ? 'text-success' : usagePercent < 80 ? 'text-warning' : 'text-danger';
                    }
                }

                return `
                    <tr class="${site.statusClass}">
                        <td>
                            <input type="checkbox" class="site-checkbox"
                                   data-site-id="${site.id}"
                                   onchange="onSiteCheckboxChange(${site.id}, this.checked)"
                                   ${site.isDisabled ? 'disabled' : ''}
                                   ${tooltipAttr}>
                        </td>
                        <td>
                            ${escapeHtml(maskUrl(cleanUrl, drValue, daValue))}
                        </td>
                        <td id="assigned_${site.id}">${dropdownHtml}</td>
                        <td class="seo-metric-td text-center ${getMetricColorClass(drValue)}">${drValue}</td>
                        <td class="seo-metric-td text-center ${getMetricColorClass(daValue)}">${daValue}</td>
                        <td class="seo-metric-td text-center ${getMetricColorClass(tfValue)}">${tfValue}</td>
                        <td class="seo-metric-td text-center ${getMetricColorClass(cfValue)}">${cfValue}</td>
                        <td class="seo-metric-td text-center metric-gray">${refDomainsValue}</td>
                        <td class="seo-metric-td text-center metric-gray">${rdMainValue}</td>
                        <td class="seo-metric-td text-center metric-gray">${normValue}</td>
                        <td class="seo-metric-td text-center metric-gray">${keywordsValue}</td>
                        <td class="seo-metric-td text-center metric-gray">${trafficValue}</td>
                        <td class="text-muted text-center">${geoValue}</td>
                        <td class="text-center">${siteTypeBadge}</td>
                        <td class="${slotsClass} text-nowrap text-center"><small>${slotsDisplay}</small></td>
                        <td class="text-success fw-bold text-center">$${typeof price === 'number' ? price.toFixed(2) : price}</td>
                        <td class="text-center">${site.statusBadge}</td>
                        <td class="text-center">${visibilityBadge}</td>
                    </tr>
                `;
            }).join('');

            // Initialize Bootstrap tooltips for disabled sites
            const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
            tooltipTriggerList.map(function (tooltipTriggerEl) {
                return new bootstrap.Tooltip(tooltipTriggerEl);
            });

            // Render pagination controls
            renderPagination(totalPages);
        }

        function renderPagination(totalPages) {
            const paginationDiv = document.getElementById('paginationControls');
            const bottomPaginationNav = document.getElementById('bottomPaginationNav');
            const bottomPaginationDiv = document.getElementById('bottomPaginationControls');
            const bottomPaginationInfo = document.getElementById('bottomPaginationInfo');

            if (totalPages <= 1) {
                if (paginationDiv) paginationDiv.innerHTML = '';
                if (bottomPaginationNav) bottomPaginationNav.style.display = 'none';
                return;
            }

            // Show bottom pagination
            if (bottomPaginationNav) bottomPaginationNav.style.display = 'flex';

            // Update info text
            const startIndex = (currentPage - 1) * sitesPerPage + 1;
            const endIndex = Math.min(currentPage * sitesPerPage, filteredSites.length);
            if (bottomPaginationInfo) {
                bottomPaginationInfo.textContent = `${t('showing')} ${startIndex}–${endIndex} ${t('of')} ${filteredSites.length}`;
            }

            // Build pagination buttons for new format
            let paginationHTML = '';

            // Previous button
            paginationHTML += `
                <button class="pagination-arrow" onclick="changePage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>
                    <i class="bi bi-chevron-left"></i>
                </button>
            `;

            // Page numbers (show max 5 pages around current)
            const maxVisible = 5;
            let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));
            let endPage = Math.min(totalPages, startPage + maxVisible - 1);

            if (endPage - startPage < maxVisible - 1) {
                startPage = Math.max(1, endPage - maxVisible + 1);
            }

            paginationHTML += '<div id="pageNumbers">';

            if (startPage > 1) {
                paginationHTML += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    paginationHTML += `<span style="color: #9ca3af;">...</span>`;
                }
            }

            for (let i = startPage; i <= endPage; i++) {
                paginationHTML += `
                    <button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>
                `;
            }

            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    paginationHTML += `<span style="color: #9ca3af;">...</span>`;
                }
                paginationHTML += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            paginationHTML += '</div>';

            // Next button
            paginationHTML += `
                <button class="pagination-arrow" onclick="changePage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>
                    <i class="bi bi-chevron-right"></i>
                </button>
            `;

            // Set pagination in both places
            if (paginationDiv) paginationDiv.innerHTML = paginationHTML;
            if (bottomPaginationDiv) bottomPaginationDiv.innerHTML = paginationHTML;
        }

        function changePage(page) {
            if (page < 1 || page > Math.ceil(filteredSites.length / sitesPerPage)) {
                return;
            }
            currentPage = page;
            renderSitesTable();
        }

        function changeBottomItemsPerPage(value) {
            sitesPerPage = parseInt(value);
            currentPage = 1;

            renderSitesTable();
        }

        function onSiteCheckboxChange(siteId, isChecked) {
            const dropdown = document.getElementById(`content_${siteId}`);

            if (isChecked) {
                // Track selected site for list operations
                selectedSitesForList.add(siteId);

                // Show dropdown
                dropdown.style.display = 'block';

                // Auto-select next available content using round-robin
                const allContent = selectedContentType === 'links' ? projectLinks : projectArticles;

                // FILTER OUT EXHAUSTED CONTENT before round-robin selection
                const availableContent = allContent.filter(item => {
                    const usageCount = item.usage_count || 0;
                    const usageLimit = item.usage_limit || (selectedContentType === 'articles' ? 1 : 999);
                    return usageCount < usageLimit;
                });

                if (availableContent.length > 0) {
                    // Get next content using round-robin (cycle through available content)
                    const selectedContent = availableContent[nextContentIndex % availableContent.length];
                    nextContentIndex++;

                    // Set dropdown value
                    dropdown.value = selectedContent.id;

                    // Store assignment
                    const contentName = selectedContentType === 'links'
                        ? selectedContent.anchor_text
                        : selectedContent.title;

                    siteAssignments[siteId] = {
                        contentId: selectedContent.id,
                        contentName: contentName
                    };
                } else {
                    // Нет доступного контента - снять выбор с сайта
                    const checkbox = document.querySelector(`.site-checkbox[data-site-id="${siteId}"]`);
                    if (checkbox) {
                        checkbox.checked = false;
                    }
                    selectedSitesForList.delete(siteId);
                    dropdown.style.display = 'none';
                    showNotification('Нет доступных анкоров для этого сайта', 'warning');
                    return;
                }

                // Add change listener to track manual selection changes
                dropdown.onchange = function() {
                    const contentId = parseInt(this.value);
                    if (contentId) {
                        const availableContent = selectedContentType === 'links' ? projectLinks : projectArticles;
                        const selectedContent = availableContent.find(c => c.id === contentId);

                        if (selectedContent) {
                            const contentName = selectedContentType === 'links'
                                ? selectedContent.anchor_text
                                : selectedContent.title;

                            siteAssignments[siteId] = {
                                contentId: contentId,
                                contentName: contentName
                            };
                        }
                    } else {
                        delete siteAssignments[siteId];
                    }

                    // Update create button state
                    updateCreateButtonState();
                };
            } else {
                // Remove from selected sites for list operations
                selectedSitesForList.delete(siteId);

                // Hide dropdown and remove assignment
                dropdown.style.display = 'none';
                dropdown.value = '';
                delete siteAssignments[siteId];
            }

            // Update create button state and list button counts
            updateCreateButtonState();
            updateListButtonCounts();

            // Update distribution preview if distributed mode is active
            if (document.getElementById('publishDistributed').checked) {
                updateDistributionPreview();
            }
        }

        function updateCreateButtonState() {
            // Enable button only if all checked sites have content selected
            const checkedSites = document.querySelectorAll('.site-checkbox:checked');
            let allHaveContent = checkedSites.length > 0;

            checkedSites.forEach(checkbox => {
                const siteId = parseInt(checkbox.dataset.siteId);
                if (!siteAssignments[siteId]) {
                    allHaveContent = false;
                }
            });

            // Update sticky action bar
            const selectedCount = checkedSites.length;
            const actionBar = document.getElementById('stickyActionBar');
            const purchaseBtn = document.getElementById('stickyPurchaseBtn');
            const whitelistBtn = document.getElementById('stickyWhitelistBtn');
            const blacklistBtn = document.getElementById('stickyBlacklistBtn');
            const purchaseBadge = document.getElementById('purchaseBadge');
            const whitelistBadge = document.getElementById('whitelistBadge');
            const blacklistBadge = document.getElementById('blacklistBadge');

            // Get bottom purchase button elements
            const bottomPurchaseDiv = document.getElementById('bottomPurchaseDiv');
            const bottomPurchaseBtn = document.getElementById('bottomPurchaseBtn');
            const bottomPurchaseBadge = document.getElementById('bottomPurchaseBadge');

            // Get total price badges
            const purchaseTotalBadge = document.getElementById('purchaseTotalBadge');
            const bottomPurchaseTotalBadge = document.getElementById('bottomPurchaseTotalBadge');

            if (selectedCount > 0) {
                // Show sticky bar and add body padding
                if (actionBar) actionBar.classList.add('show');
                document.body.classList.add('sticky-bar-active');

                // Show bottom purchase button
                if (bottomPurchaseDiv) bottomPurchaseDiv.style.display = 'block';

                // Calculate total price - check each site's ownership for pricing
                const currentUser = getCurrentUser();
                const standardPrice = parseFloat(selectedContentType === 'links'
                    ? (userPricing?.link?.finalPrice || 25)
                    : (userPricing?.article?.finalPrice || 15));

                let totalPrice = 0;
                Object.keys(siteAssignments).forEach(siteIdStr => {
                    const siteId = parseInt(siteIdStr);
                    const site = sites.find(s => s.id === siteId);
                    if (site) {
                        // $0.10 for own sites, standard price for others
                        const isOwnSite = site.user_id === currentUser?.id;
                        totalPrice += isOwnSite ? 0.10 : standardPrice;
                    }
                });

                // Update all badges
                if (purchaseBadge) purchaseBadge.textContent = selectedCount;
                if (whitelistBadge) whitelistBadge.textContent = selectedCount;
                if (blacklistBadge) blacklistBadge.textContent = selectedCount;
                if (bottomPurchaseBadge) bottomPurchaseBadge.textContent = selectedCount;

                // Update total price badges - с 2 десятичными знаками
                if (purchaseTotalBadge) purchaseTotalBadge.textContent = `$${totalPrice.toFixed(2)}`;
                if (bottomPurchaseTotalBadge) bottomPurchaseTotalBadge.textContent = `$${totalPrice.toFixed(2)}`;

                // Enable/disable buttons based on content assignment AND project content availability
                const isEnabled = allHaveContent && hasAvailableContent;
                if (purchaseBtn) purchaseBtn.disabled = !isEnabled;
                if (bottomPurchaseBtn) bottomPurchaseBtn.disabled = !isEnabled;
                if (whitelistBtn) whitelistBtn.disabled = false;
                if (blacklistBtn) blacklistBtn.disabled = false;
            } else {
                // Hide sticky bar and remove body padding
                if (actionBar) actionBar.classList.remove('show');
                document.body.classList.remove('sticky-bar-active');

                // Hide bottom purchase button
                if (bottomPurchaseDiv) bottomPurchaseDiv.style.display = 'none';

                // Reset buttons
                if (purchaseBtn) purchaseBtn.disabled = true;
                if (bottomPurchaseBtn) bottomPurchaseBtn.disabled = true;
                if (whitelistBtn) whitelistBtn.disabled = true;
                if (blacklistBtn) blacklistBtn.disabled = true;

                // Reset total price badges
                if (purchaseTotalBadge) purchaseTotalBadge.textContent = '$0.00';
                if (bottomPurchaseTotalBadge) bottomPurchaseTotalBadge.textContent = '$0.00';
            }
        }

        function updateListButtonCounts() {
            const count = selectedSitesForList.size;
            const whitelistCount = document.getElementById('whitelistCount');
            const blacklistCount = document.getElementById('blacklistCount');

            if (whitelistCount) whitelistCount.textContent = count;
            if (blacklistCount) blacklistCount.textContent = count;

            const addToWhitelistBtn = document.getElementById('addToWhitelistBtn');
            const addToBlacklistBtn = document.getElementById('addToBlacklistBtn');
            const listActionsDiv = document.getElementById('listActionsDiv');

            if (count > 0) {
                if (addToWhitelistBtn) addToWhitelistBtn.disabled = false;
                if (addToBlacklistBtn) addToBlacklistBtn.disabled = false;
                if (listActionsDiv) listActionsDiv.style.display = 'block';
            } else {
                if (addToWhitelistBtn) addToWhitelistBtn.disabled = true;
                if (addToBlacklistBtn) addToBlacklistBtn.disabled = true;
            }
        }

        function toggleAllSites() {
            const selectAll = document.getElementById('selectAllSites').checked;
            const checkboxes = document.querySelectorAll('.site-checkbox:not(:disabled)');

            if (selectAll) {
                // Проверяем количество доступного контента
                const allContent = selectedContentType === 'links' ? projectLinks : projectArticles;
                const availableContent = allContent.filter(item => {
                    const usageCount = item.usage_count || 0;
                    const usageLimit = item.usage_limit || (selectedContentType === 'articles' ? 1 : 999);
                    return usageCount < usageLimit;
                });

                const sitesCount = checkboxes.length;

                if (availableContent.length === 0) {
                    showNotification('Нет доступных анкоров для назначения', 'error');
                    document.getElementById('selectAllSites').checked = false;
                    return;
                }

                if (availableContent.length < sitesCount) {
                    showNotification(`Внимание: анкоров (${availableContent.length}) меньше чем сайтов (${sitesCount}). Выбраны только первые ${availableContent.length} сайтов.`, 'warning');
                }

                // Сбрасываем round-robin индекс перед массовым выбором
                nextContentIndex = 0;

                let selectedCount = 0;
                checkboxes.forEach(cb => {
                    // Выбираем только если есть доступный контент
                    if (selectedCount < availableContent.length) {
                        if (!cb.checked) {
                            cb.checked = true;
                            onSiteCheckboxChange(parseInt(cb.dataset.siteId), true);
                            selectedCount++;
                        }
                    }
                });
            } else {
                // Снимаем выбор со всех
                checkboxes.forEach(cb => {
                    if (cb.checked) {
                        cb.checked = false;
                        onSiteCheckboxChange(parseInt(cb.dataset.siteId), false);
                    }
                });
            }
        }

        async function createPlacement() {
            const projectId = parseInt(document.getElementById('projectSelect').value);
            if (!projectId) {
                showNotification('Please select a project', 'error');
                return;
            }

            if (!selectedContentType) {
                showNotification('Please select content type (Links or Articles)', 'error');
                return;
            }

            // Check if project has content
            const availableContent = selectedContentType === 'links' ? projectLinks : projectArticles;
            if (availableContent.length === 0) {
                showNotification(`У проекта нет ${selectedContentType === 'links' ? 'ссылок' : 'гест-постов'}. Добавьте контент в проекте сначала.`, 'error');
                return;
            }

            if (Object.keys(siteAssignments).length === 0) {
                showNotification('Please select at least one site', 'error');
                return;
            }

            console.log('Creating placement with assignments:', siteAssignments);

            // Extract and validate scheduled publication date
            const publishType = document.querySelector('input[name="publishType"]:checked').value;
            let distributedDates = [];

            if (publishType === 'distributed') {
                const periodDays = parseInt(document.getElementById('distributionPeriod').value);
                const totalSites = Object.keys(siteAssignments).length;

                // Validate period (already in days, max 90)
                if (periodDays > 90) {
                    showNotification('Период распределения не может превышать 90 дней', 'error');
                    return;
                }

                // Calculate distributed dates
                distributedDates = calculateDistributedDates(totalSites, periodDays);
                console.log(`📅 Distributed ${totalSites} sites over ${periodDays} days:`, distributedDates);
            }

            // Build placement purchases with specific assignments
            const purchases = [];
            let dateIndex = 0;
            for (const [siteId, assignment] of Object.entries(siteAssignments)) {
                const purchaseData = {
                    projectId: projectId,
                    siteId: parseInt(siteId),
                    type: selectedContentType === 'links' ? 'link' : 'article',
                    contentIds: [assignment.contentId]
                };

                // Add scheduled date for distributed publication
                if (publishType === 'distributed' && distributedDates.length > 0) {
                    purchaseData.scheduledDate = distributedDates[dateIndex++];
                }

                purchases.push(purchaseData);
            }

            try {
                // Show progress modal for batch processing
                const totalPurchases = purchases.length;
                showPurchaseProgressModal(totalPurchases);

                console.log(`⚡ Starting batch purchase: ${totalPurchases} placements via single API call...`);
                const startTime = performance.now();

                // Use new batch endpoint - all purchases processed in parallel on server
                // This is 5-10x faster than individual requests
                const result = await BillingAPI.batchPurchase(purchases);

                const successful = result.data?.successful || 0;
                const failed = result.data?.failed || 0;
                const errors = (result.data?.errors || []).map(e => ({
                    site_id: e.siteId,
                    error: e.error
                }));

                // Update progress to 100%
                updatePurchaseProgress(100, successful, failed, totalPurchases, null);

                const endTime = performance.now();
                const serverDuration = result.data?.durationMs || 0;
                console.log(`✅ Completed in ${((endTime - startTime) / 1000).toFixed(2)}s (server: ${serverDuration}ms)`);

                // Complete progress modal
                completePurchaseProgress(successful, failed, errors);

                // Log detailed errors to console
                if (errors.length > 0) {
                    const errorDetails = errors.map(e => {
                        const site = filteredSites.find(s => s.id === e.site_id);
                        const siteName = site ? site.site_name : `ID ${e.site_id}`;
                        return `• ${siteName}: ${e.error}`;
                    }).join('\n');

                    console.error('=== ОШИБКИ РАЗМЕЩЕНИЙ ===');
                    console.error(errorDetails);
                    console.error('========================');
                }

                // Clear site selections but keep project and content type selected
                siteAssignments = {};
                nextContentIndex = 0;

                // Uncheck all site checkboxes
                document.querySelectorAll('.site-checkbox:checked').forEach(cb => {
                    cb.checked = false;
                });

                // Clear content dropdowns
                document.querySelectorAll('.content-select').forEach(select => {
                    select.style.display = 'none';
                });

                // Reload sites table to show updated availability (purchased sites marked as unavailable)
                const projectId = document.getElementById('projectSelect').value;
                if (projectId && selectedContentType) {
                    await loadSitesForPlacement(projectId, selectedContentType);
                }
            } catch (error) {
                // Critical error (not purchase failure, but system error)
                console.error('Critical error in createPlacements:', error);
                progressModal.hide();
                showNotification('Критическая ошибка при создании размещений: ' + error.message, 'error');
            }
        }

        // REMOVED: createPlacementAsync - Old batch async system no longer supported
        // Billing system processes purchases individually through BillingAPI.purchase

        function showProgressModal(job) {
            // Reset progress UI
            document.getElementById('progressStatus').textContent = 'Queued...';
            document.getElementById('progressPercent').textContent = '0%';
            document.getElementById('progressBar').style.width = '0%';
            document.getElementById('progressTotal').textContent = job.total_sites || 0;
            document.getElementById('progressSuccessful').textContent = '0';
            document.getElementById('progressFailed').textContent = '0';
            document.getElementById('progressResults').style.display = 'none';
            document.getElementById('progressErrors').style.display = 'none';
            document.getElementById('cancelJobBtn').style.display = 'block';
            document.getElementById('closeProgressBtn').style.display = 'none';

            progressModal.show();
        }

        function startJobPolling(jobId) {
            // Clear any existing poll
            if (pollInterval) {
                clearInterval(pollInterval);
            }

            // Poll every 2 seconds
            pollInterval = setInterval(async () => {
                await updateJobStatus(jobId);
            }, 2000);

            // Initial check
            updateJobStatus(jobId);
        }

        async function updateJobStatus(jobId) {
            try {
                const response = await fetch(`/api/placements/job/${jobId}`, {
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to fetch job status');
                }

                const status = await response.json();

                // Update progress bar
                const percent = status.progress?.percent || 0;
                document.getElementById('progressPercent').textContent = `${Math.round(percent)}%`;
                document.getElementById('progressBar').style.width = `${percent}%`;

                // Update status text
                const stage = status.progress?.stage || status.status;
                document.getElementById('progressStatus').textContent = stage;

                // Update counts
                document.getElementById('progressTotal').textContent = status.total_sites || 0;
                document.getElementById('progressSuccessful').textContent = status.successful || 0;
                document.getElementById('progressFailed').textContent = status.failed || 0;

                // Handle completion
                if (status.status === 'completed' || status.status === 'failed') {
                    clearInterval(pollInterval);
                    pollInterval = null;

                    // Show results
                    if (status.results && status.results.length > 0) {
                        displayResults(status.results);
                    }

                    // Show errors
                    if (status.errors && status.errors.length > 0) {
                        displayErrors(status.errors);
                    }

                    // Update button
                    document.getElementById('cancelJobBtn').style.display = 'none';
                    document.getElementById('closeProgressBtn').style.display = 'block';

                    // Change progress bar color
                    const progressBar = document.getElementById('progressBar');
                    progressBar.classList.remove('progress-bar-animated', 'progress-bar-striped');
                    if (status.status === 'completed') {
                        progressBar.classList.add('bg-success');
                        showNotification(`Batch placement completed: ${status.successful} successful, ${status.failed} failed`);
                    } else {
                        progressBar.classList.add('bg-danger');
                        showNotification('Batch placement failed', 'error');
                    }

                    // Just notify completion
                }
            } catch (error) {
                console.error('Error polling job status:', error);
            }
        }

        function displayResults(results) {
            const resultsList = document.getElementById('progressResultsList');
            resultsList.innerHTML = results.map(r => {
                const icon = r.success ? '✅' : '❌';
                const className = r.success ? 'text-success' : 'text-danger';
                return `
                    <div class="border-bottom pb-2 mb-2">
                        <span class="${className}">${icon}</span>
                        <strong>Site ID ${r.site_id}</strong>
                        ${r.site_name ? `(${escapeHtml(r.site_name)})` : ''}
                        - ${r.links_placed || 0} links, ${r.articles_placed || 0} articles
                    </div>
                `;
            }).join('');
            document.getElementById('progressResults').style.display = 'block';
        }

        function displayErrors(errors) {
            const errorsList = document.getElementById('progressErrorsList');
            errorsList.innerHTML = errors.map(e => `
                <li>Site ID ${e.site_id}: ${escapeHtml(e.error)}</li>
            `).join('');
            document.getElementById('progressErrors').style.display = 'block';
        }

        async function cancelCurrentJob() {
            if (!currentJobId) return;

            if (!confirm('Are you sure you want to cancel this job?')) return;

            try {
                const response = await fetch(`/api/placements/job/${currentJobId}/cancel`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${getAuthToken()}`
                    }
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to cancel job');
                }

                clearInterval(pollInterval);
                pollInterval = null;
                progressModal.hide();
                showNotification('Job cancelled successfully');
            } catch (error) {
                showNotification('Failed to cancel job: ' + error.message, 'error');
            }
        }

        function closeProgressModal() {
            clearInterval(pollInterval);
            pollInterval = null;
            currentJobId = null;
            progressModal.hide();
        }

        // === Purchase Progress Functions (Batch Processing) ===

        let purchaseCancelled = false; // Flag to cancel batch processing

        function showPurchaseProgressModal(total) {
            // Reset cancel flag
            purchaseCancelled = false;

            // Reset progress UI
            document.getElementById('progressStatus').textContent = 'Начинаем покупку...';
            document.getElementById('progressPercent').textContent = '0%';
            const progressBar = document.getElementById('progressBar');
            progressBar.style.width = '0%';
            progressBar.style.background = 'linear-gradient(90deg, #3b82f6, #8b5cf6)'; // Reset to default gradient
            document.getElementById('progressTotal').textContent = total;
            document.getElementById('progressSuccessful').textContent = '0';
            document.getElementById('progressFailed').textContent = '0';
            document.getElementById('progressResults').style.display = 'none';
            document.getElementById('progressErrors').style.display = 'none';
            document.getElementById('cancelJobBtn').style.display = 'block';
            document.getElementById('closeProgressBtn').style.display = 'none';

            // Update cancel button to cancel purchases
            document.getElementById('cancelJobBtn').onclick = () => {
                if (confirm('Отменить оставшиеся покупки?')) {
                    purchaseCancelled = true;
                    document.getElementById('progressStatus').textContent = 'Отменено пользователем...';
                }
            };

            progressModal.show();
        }

        function updatePurchaseProgress(percent, successful, failed, total, currentSiteName) {
            document.getElementById('progressPercent').textContent = `${percent}%`;
            document.getElementById('progressBar').style.width = `${percent}%`;
            document.getElementById('progressTotal').textContent = total;
            document.getElementById('progressSuccessful').textContent = successful;
            document.getElementById('progressFailed').textContent = failed;
            document.getElementById('progressStatus').textContent = currentSiteName
                ? `Обрабатываем: ${currentSiteName}...`
                : `Обработано ${successful + failed} из ${total}...`;
        }

        function completePurchaseProgress(successful, failed, errors) {
            const progressBar = document.getElementById('progressBar');
            const total = successful + failed;

            if (failed === 0) {
                // All successful - show green progress bar and success message
                progressBar.style.background = 'linear-gradient(90deg, #22c55e, #16a34a)';
                document.getElementById('progressStatus').textContent = 'Покупка завершена!';

                // Show success results block
                const resultsDiv = document.getElementById('progressResults');
                resultsDiv.style.display = 'block';
                document.getElementById('progressResultsList').textContent = `Успешно куплено ${successful} из ${total} размещений.`;
            } else if (successful === 0) {
                // All failed - show red progress bar
                progressBar.style.background = 'linear-gradient(90deg, #ef4444, #dc2626)';
                document.getElementById('progressStatus').textContent = 'Все покупки провалены';
            } else {
                // Mixed results - show yellow/orange progress bar
                progressBar.style.background = 'linear-gradient(90deg, #f59e0b, #d97706)';
                document.getElementById('progressStatus').textContent = `Завершено: ${successful} успешно, ${failed} провалено`;

                // Show partial success message
                const resultsDiv = document.getElementById('progressResults');
                resultsDiv.style.display = 'block';
                document.getElementById('progressResultsList').textContent = `Успешно куплено ${successful} из ${total} размещений.`;
            }

            // Show errors if any
            if (errors && errors.length > 0) {
                displayErrors(errors);
            }

            // Switch buttons
            document.getElementById('cancelJobBtn').style.display = 'none';
            document.getElementById('closeProgressBtn').style.display = 'block';
        }

        // Whitelist/Blacklist Functions

        function loadListsFromStorage() {
            const storedWhitelist = localStorage.getItem('sitesWhitelist');
            const storedBlacklist = localStorage.getItem('sitesBlacklist');

            if (storedWhitelist) {
                whitelist = new Set(JSON.parse(storedWhitelist));
            }
            if (storedBlacklist) {
                blacklist = new Set(JSON.parse(storedBlacklist));
            }

            // Load but DON'T activate filters
            whitelistActive = false;
            blacklistActive = false;

            updateListTotals();
        }

        function saveListsToStorage() {
            localStorage.setItem('sitesWhitelist', JSON.stringify([...whitelist]));
            localStorage.setItem('sitesBlacklist', JSON.stringify([...blacklist]));
            updateListTotals();
        }

        function updateListTotals() {
            document.getElementById('whitelistTotal').textContent = whitelist.size;
            document.getElementById('blacklistTotal').textContent = blacklist.size;
        }

        function addSelectedToWhitelist() {
            // Get checked sites from placement checkboxes
            const checkedSites = document.querySelectorAll('.site-checkbox:checked');
            const siteIds = Array.from(checkedSites).map(cb => parseInt(cb.dataset.siteId));

            if (siteIds.length === 0) {
                showNotification('No sites selected', 'warning');
                return;
            }

            siteIds.forEach(siteId => {
                whitelist.add(siteId);
                blacklist.delete(siteId); // Remove from blacklist if exists
            });
            saveListsToStorage();
            showNotification(`Added ${siteIds.length} sites to whitelist`, 'success');
            renderWhitelistView();

            // Uncheck all sites and hide sticky bar
            checkedSites.forEach(cb => cb.checked = false);
            updateCreateButtonState();

            // Refresh sites table to apply filter
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function addSelectedToBlacklist() {
            // Get checked sites from placement checkboxes
            const checkedSites = document.querySelectorAll('.site-checkbox:checked');
            const siteIds = Array.from(checkedSites).map(cb => parseInt(cb.dataset.siteId));

            if (siteIds.length === 0) {
                showNotification('No sites selected', 'warning');
                return;
            }

            siteIds.forEach(siteId => {
                blacklist.add(siteId);
                whitelist.delete(siteId); // Remove from whitelist if exists
            });
            saveListsToStorage();
            showNotification(`Added ${siteIds.length} sites to blacklist`, 'success');
            renderBlacklistView();

            // Uncheck all sites and hide sticky bar
            checkedSites.forEach(cb => cb.checked = false);
            updateCreateButtonState();

            // Refresh sites table to apply filter
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function importWhitelist() {
            currentImportTarget = 'whitelist';
            // Update modal styling for whitelist
            const header = document.getElementById('importModalHeader');
            const icon = document.getElementById('importModalIcon');
            const btn = document.getElementById('importModalBtn');
            header.classList.remove('blacklist-header');
            header.classList.add('whitelist-header');
            icon.classList.remove('bi-x-circle-fill');
            icon.classList.add('bi-check-circle-fill');
            btn.classList.remove('blacklist-btn');
            btn.classList.add('whitelist-btn');
            document.getElementById('importListModalTitle').textContent = 'Import Whitelist Domains';
            document.getElementById('importDomainsText').value = '';
            importListModal.show();
        }

        function importBlacklist() {
            currentImportTarget = 'blacklist';
            // Update modal styling for blacklist
            const header = document.getElementById('importModalHeader');
            const icon = document.getElementById('importModalIcon');
            const btn = document.getElementById('importModalBtn');
            header.classList.remove('whitelist-header');
            header.classList.add('blacklist-header');
            icon.classList.remove('bi-check-circle-fill');
            icon.classList.add('bi-x-circle-fill');
            btn.classList.remove('whitelist-btn');
            btn.classList.add('blacklist-btn');
            document.getElementById('importListModalTitle').textContent = 'Import Blacklist Domains';
            document.getElementById('importDomainsText').value = '';
            importListModal.show();
        }

        function processImportedDomains() {
            const text = document.getElementById('importDomainsText').value;
            const lines = text.split('\n').map(line => line.trim()).filter(line => line);

            // Extract domains from URLs or use as-is
            const domains = lines.map(line => {
                try {
                    const url = new URL(line.startsWith('http') ? line : `https://${line}`);
                    return url.hostname;
                } catch {
                    return line.replace(/^https?:\/\//, '').replace(/\/$/, '');
                }
            });

            // Find matching sites in our system
            const matchedSiteIds = [];
            domains.forEach(domain => {
                const matchedSite = sites.find(site => {
                    const siteUrl = site.site_url.replace(/^https?:\/\//, '').replace(/\/$/, '');
                    return siteUrl === domain || siteUrl.includes(domain) || domain.includes(siteUrl);
                });
                if (matchedSite) {
                    matchedSiteIds.push(matchedSite.id);
                }
            });

            if (matchedSiteIds.length === 0) {
                showNotification('No matching sites found in the system', 'error');
                return;
            }

            // Add to appropriate list
            if (currentImportTarget === 'whitelist') {
                matchedSiteIds.forEach(id => {
                    whitelist.add(id);
                    blacklist.delete(id);
                });
                renderWhitelistView();
            } else {
                matchedSiteIds.forEach(id => {
                    blacklist.add(id);
                    whitelist.delete(id);
                });
                renderBlacklistView();
            }

            saveListsToStorage();
            showNotification(`Imported ${matchedSiteIds.length} sites to ${currentImportTarget}`, 'success');
            importListModal.hide();

            // Refresh sites table to apply filter
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function toggleWhitelistView() {
            // Toggle filter activation (don't show/hide the list below)
            whitelistActive = !whitelistActive;

            // Toggle items container visibility
            const container = document.getElementById('whitelistItems');
            if (container) {
                container.classList.toggle('show');
                if (container.classList.contains('show')) {
                    renderWhitelistView();
                }
            }

            // Update button text (for old list block if still exists)
            const btn = event?.target?.closest('button');
            if (btn && btn.classList.contains('btn-outline-success') || btn?.classList.contains('btn-success')) {
                if (whitelistActive) {
                    btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide (' + whitelist.size + ')';
                    btn.classList.remove('btn-outline-success');
                    btn.classList.add('btn-success');
                } else {
                    btn.innerHTML = '<i class="bi bi-eye"></i> Show (' + whitelist.size + ')';
                    btn.classList.remove('btn-success');
                    btn.classList.add('btn-outline-success');
                }
            }

            // Refresh sites table
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function toggleBlacklistView() {
            // Toggle filter activation (don't show/hide the list below)
            blacklistActive = !blacklistActive;

            // Toggle items container visibility
            const container = document.getElementById('blacklistItems');
            if (container) {
                container.classList.toggle('show');
                if (container.classList.contains('show')) {
                    renderBlacklistView();
                }
            }

            // Update button text (for old list block if still exists)
            const btn = event?.target?.closest('button');
            if (btn && btn.classList.contains('btn-outline-danger') || btn?.classList.contains('btn-danger')) {
                if (blacklistActive) {
                    btn.innerHTML = '<i class="bi bi-eye-slash"></i> Hide (' + blacklist.size + ')';
                    btn.classList.remove('btn-outline-danger');
                    btn.classList.add('btn-danger');
                } else {
                    btn.innerHTML = '<i class="bi bi-eye"></i> Show (' + blacklist.size + ')';
                    btn.classList.remove('btn-danger');
                    btn.classList.add('btn-outline-danger');
                }
            }

            // Refresh sites table
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function renderWhitelistView() {
            const container = document.getElementById('whitelistItems');
            if (whitelist.size === 0) {
                container.innerHTML = '<p class="text-muted text-center p-3">No sites in whitelist</p>';
                return;
            }

            const whitelistSites = sites.filter(site => whitelist.has(site.id));
            container.innerHTML = whitelistSites.map(site => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(site.site_name)}</strong><br>
                        <small class="text-muted">${escapeHtml(site.site_url)}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromWhitelist(${site.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function renderBlacklistView() {
            const container = document.getElementById('blacklistItems');
            if (blacklist.size === 0) {
                container.innerHTML = '<p class="text-muted text-center p-3">No sites in blacklist</p>';
                return;
            }

            const blacklistSites = sites.filter(site => blacklist.has(site.id));
            container.innerHTML = blacklistSites.map(site => `
                <div class="list-group-item d-flex justify-content-between align-items-center">
                    <div>
                        <strong>${escapeHtml(site.site_name)}</strong><br>
                        <small class="text-muted">${escapeHtml(site.site_url)}</small>
                    </div>
                    <button class="btn btn-sm btn-danger" onclick="removeFromBlacklist(${site.id})">
                        <i class="bi bi-trash"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFromWhitelist(siteId) {
            whitelist.delete(siteId);
            saveListsToStorage();
            renderWhitelistView();
            showNotification('Removed from whitelist', 'success');

            // Refresh sites table to apply filter
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function removeFromBlacklist(siteId) {
            blacklist.delete(siteId);
            saveListsToStorage();
            renderBlacklistView();
            showNotification('Removed from blacklist', 'success');

            // Refresh sites table to apply filter
            const projectId = document.getElementById('projectSelect').value;
            if (projectId && selectedContentType) {
                loadSitesForPlacement(projectId, selectedContentType);
            }
        }

        function clearWhitelist() {
            if (whitelist.size === 0) {
                showNotification('Whitelist is already empty', 'info');
                return;
            }

            if (confirm(`Clear all ${whitelist.size} sites from whitelist?`)) {
                whitelist.clear();
                saveListsToStorage();
                renderWhitelistView();
                showNotification('Whitelist cleared', 'success');

                // Refresh sites table to apply filter
                const projectId = document.getElementById('projectSelect').value;
                if (projectId && selectedContentType) {
                    loadSitesForPlacement(projectId, selectedContentType);
                }
            }
        }

        function clearBlacklist() {
            if (blacklist.size === 0) {
                showNotification('Blacklist is already empty', 'info');
                return;
            }

            if (confirm(`Clear all ${blacklist.size} sites from blacklist?`)) {
                blacklist.clear();
                saveListsToStorage();
                renderBlacklistView();
                showNotification('Blacklist cleared', 'success');

                // Refresh sites table to apply filter
                const projectId = document.getElementById('projectSelect').value;
                if (projectId && selectedContentType) {
                    loadSitesForPlacement(projectId, selectedContentType);
                }
            }
        }

        function updateActiveFiltersInfo() {
            const infoSpan = document.getElementById('activeFiltersInfo');
            if (!infoSpan) return; // Element doesn't exist, skip update

            const filters = [];

            if (whitelistActive && whitelist.size > 0) {
                filters.push(`<span class="badge bg-success">Whitelist Active: ${whitelist.size} sites</span>`);
            }
            if (blacklistActive && blacklist.size > 0) {
                filters.push(`<span class="badge bg-danger">Blacklist Active: ${blacklist.size} sites</span>`);
            }

            if (filters.length > 0) {
                infoSpan.innerHTML = filters.join(' ');
            } else {
                infoSpan.innerHTML = '';
            }
        }

        /**
         * Calculate evenly distributed dates over a period
         * @param {number} totalSites - Number of sites to distribute
         * @param {number} periodDays - Period in days
         * @returns {Array<string>} Array of ISO date strings
         */
        function calculateDistributedDates(totalSites, periodDays) {
            const now = new Date();
            const daysBetween = periodDays / totalSites;

            const dates = [];
            for (let i = 0; i < totalSites; i++) {
                const date = new Date(now);
                // Start from day 1 (i+1) to ensure all dates are in the future
                // For 2 sites over 5 days: site 1 = day 2.5, site 2 = day 5
                date.setDate(date.getDate() + Math.round((i + 1) * daysBetween));
                dates.push(date.toISOString());
            }

            return dates;
        }

        /**
         * Update the distribution preview text
         */
        function updateDistributionPreview() {
            const selectedCount = selectedSitesForList.size;
            const periodDays = parseInt(document.getElementById('distributionPeriod').value);
            const previewDiv = document.getElementById('distributionPreview');
            const previewText = document.getElementById('distributionPreviewText');

            if (selectedCount === 0) {
                previewDiv.style.display = 'none';
                return;
            }

            const daysBetween = (periodDays / selectedCount).toFixed(1);

            previewText.textContent = `${selectedCount} ${selectedCount === 1 ? 'сайт' : selectedCount < 5 ? 'сайта' : 'сайтов'} / ${periodDays} ${periodDays === 1 ? 'день' : periodDays < 5 ? 'дня' : 'дней'} = публикация каждые ${daysBetween} ${daysBetween == 1 ? 'день' : 'дня/дней'}`;
            previewDiv.style.display = 'block';
        }

        // Listen for language changes to update dynamic content
        window.addEventListener('languageChanged', () => {
            renderSitesTable();
        });

    </script>
</body>
</html>
