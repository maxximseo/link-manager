<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–æ–∏ —Å—Å—ã–ª–∫–∏ - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/modern-table.css">
    <style>
        /* Tabs styling - visual separation between tabs and content */
        .card > .nav-tabs {
            margin-bottom: 0;
            border-bottom: 1px solid #dee2e6;  /* Border under tabs */
            border-top: none;  /* Remove top border */
            background: #f8f9fa;  /* Light gray background for tab area */
            padding: 0.5rem 1rem 0 1rem;  /* Padding around tabs */
        }

        /* Active tab styling */
        .card > .nav-tabs .nav-link.active {
            background: white;  /* White background for active tab */
            border-bottom-color: white;  /* Hide bottom border on active tab */
        }

        /* Inactive tabs styling */
        .card > .nav-tabs .nav-link {
            background: transparent;  /* Transparent background for inactive tabs */
        }

        /* Tab content area with white background */
        .tab-content {
            background: white;
        }

        /* Remove borders from inner cards in tab panes */
        .tab-content > .tab-pane > .card {
            border: none;  /* Remove all borders - outer card provides them */
            border-radius: 0;  /* Remove border radius */
            box-shadow: none;  /* Remove any shadow */
            background: transparent;  /* Transparent background */
            transform: none !important;  /* DISABLE hover movement */
        }

        /* Disable hover effects on inner cards */
        .tab-content > .tab-pane > .card:hover {
            transform: none !important;
            box-shadow: none !important;
        }

        /* Ensure card-body has proper padding */
        .tab-content > .tab-pane > .card > .card-body {
            padding: 1.5rem;
        }

        /* Outer card border styling to match sites.html */
        .container > .card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }

        /* Table1 —Å—Ç–∏–ª—å —Ç–µ–ø–µ—Ä—å –≤ modern-table.css */

        /* Extra small buttons - 3x smaller than btn-sm */
        .btn-xs {
            padding: 0.15rem 0.3rem;
            font-size: 0.65rem;
            line-height: 1.2;
            border-radius: 0.2rem;
        }

        .btn-xs .bi {
            font-size: 0.7rem;
        }

        /* Sortable column headers */
        .sortable-header {
            cursor: pointer;
            user-select: none;
            position: relative;
            padding-right: 1.5rem !important;
        }

        .sortable-header:hover {
            background-color: rgba(0, 0, 0, 0.05);
        }

        .sortable-header .sort-icon {
            position: absolute;
            right: 0.5rem;
            top: 50%;
            transform: translateY(-50%);
            opacity: 0.3;
            transition: opacity 0.2s;
        }

        .sortable-header.sorted .sort-icon {
            opacity: 1;
        }
    </style>
</head>
<body>
    <!-- Navbar Container (injected by navbar.js) -->
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>üîó –ú–æ–∏ —Å—Å—ã–ª–∫–∏</h1>
            <div>
                <button class="btn btn-light border me-2" style="background: white !important; color: #333 !important;" onclick="toggleFiltersPanel()" id="filtersToggleBtn">
                    <i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã
                </button>
                <div class="btn-group me-2">
                    <button class="btn btn-light border dropdown-toggle" style="background: white !important; color: #333 !important;" type="button" id="columnsDropdown" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        <i class="bi bi-layout-three-columns"></i> –ö–æ–ª–æ–Ω–∫–∏
                    </button>
                    <div class="dropdown-menu dropdown-menu-end p-3" style="width: 280px; max-height: 400px; overflow-y: auto;" aria-labelledby="columnsDropdown">
                        <h6 class="dropdown-header px-0">–ü–æ–∫–∞–∑–∞—Ç—å/—Å–∫—Ä—ã—Ç—å –∫–æ–ª–æ–Ω–∫–∏</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-id" checked onchange="toggleColumn('id')">
                            <label class="form-check-label" for="col-id">ID</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-project" checked onchange="toggleColumn('project')">
                            <label class="form-check-label" for="col-project">–ü—Ä–æ–µ–∫—Ç</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-site" checked onchange="toggleColumn('site')">
                            <label class="form-check-label" for="col-site">–ü–ª–æ—â–∞–¥–∫–∞</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-published" checked onchange="toggleColumn('published')">
                            <label class="form-check-label" for="col-published">–û–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-expires" checked onchange="toggleColumn('expires')">
                            <label class="form-check-label" for="col-expires">–ò—Å—Ç–µ–∫–∞–µ—Ç</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-price" checked onchange="toggleColumn('price')">
                            <label class="form-check-label" for="col-price">–¶–µ–Ω–∞</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-autorenewal" checked onchange="toggleColumn('autorenewal')">
                            <label class="form-check-label" for="col-autorenewal">–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ</label>
                        </div>
                        <hr class="my-2">
                        <h6 class="dropdown-header px-0">SEO –º–µ—Ç—Ä–∏–∫–∏</h6>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-dr" checked onchange="toggleColumn('dr')">
                            <label class="form-check-label" for="col-dr">DR</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-da" checked onchange="toggleColumn('da')">
                            <label class="form-check-label" for="col-da">DA</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-tf" onchange="toggleColumn('tf')">
                            <label class="form-check-label" for="col-tf">TF</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-cf" onchange="toggleColumn('cf')">
                            <label class="form-check-label" for="col-cf">CF</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-rd" onchange="toggleColumn('rd')">
                            <label class="form-check-label" for="col-rd">RD</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-rdm" onchange="toggleColumn('rdm')">
                            <label class="form-check-label" for="col-rdm">RDm</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-norm" onchange="toggleColumn('norm')">
                            <label class="form-check-label" for="col-norm">Norm</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-kw" onchange="toggleColumn('kw')">
                            <label class="form-check-label" for="col-kw">KW</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-traf" onchange="toggleColumn('traf')">
                            <label class="form-check-label" for="col-traf">Traf</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-geo" onchange="toggleColumn('geo')">
                            <label class="form-check-label" for="col-geo">GEO</label>
                        </div>
                        <hr class="my-2">
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-sitetype" onchange="toggleColumn('sitetype')">
                            <label class="form-check-label" for="col-sitetype">–¢–∏–ø —Å–∞–π—Ç–∞</label>
                        </div>
                        <div class="form-check mb-2">
                            <input class="form-check-input" type="checkbox" id="col-type" checked onchange="toggleColumn('type')">
                            <label class="form-check-label" for="col-type">–¢–∏–ø</label>
                        </div>
                        <hr class="my-2">
                        <div class="d-flex gap-2">
                            <button class="btn btn-sm btn-outline-primary flex-fill" onclick="showAllColumns()">–í—Å–µ</button>
                            <button class="btn btn-sm btn-outline-secondary flex-fill" onclick="hideOptionalColumns()">–ú–∏–Ω–∏–º—É–º</button>
                        </div>
                    </div>
                </div>
                <button class="btn btn-light border" style="background: white !important; color: #333 !important;" onclick="exportPlacements('csv')">
                    <i class="bi bi-download"></i> –≠–∫—Å–ø–æ—Ä—Ç CSV
                </button>
            </div>
        </div>

        <!-- Filters Bar -->
        <div class="card mb-3">
            <div class="card-body">
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">–§–∏–ª—å—Ç—Ä –ø–æ –ø—Ä–æ–µ–∫—Ç—É</label>
                        <select class="form-select" id="projectFilter" onchange="applyFilters()">
                            <option value="">–í—Å–µ –ø—Ä–æ–µ–∫—Ç—ã</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–¢–∏–ø</label>
                        <select class="form-select" id="typeFilter" onchange="applyFilters()">
                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                            <option value="link">–°—Å—ã–ª–∫–∏</option>
                            <option value="article">–ì–µ—Å—Ç-–ø–æ—Å—Ç—ã</option>
                        </select>
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–î–∞—Ç–∞ –æ—Ç</label>
                        <input type="date" class="form-control" id="dateFrom" onchange="applyFilters()">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">–î–∞—Ç–∞ –¥–æ</label>
                        <input type="date" class="form-control" id="dateTo" onchange="applyFilters()">
                    </div>
                </div>
                <div class="row mt-2">
                    <div class="col-12">
                        <button class="btn btn-sm btn-secondary" onclick="resetFilters()" id="resetFiltersBtn" style="display: none;">
                            <i class="bi bi-x-circle"></i> –°–±—Ä–æ—Å–∏—Ç—å —Ñ–∏–ª—å—Ç—Ä—ã
                        </button>
                        <span class="text-muted ms-3" id="filterStatus"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tabs Card Integration -->
        <div class="card">
            <!-- Tabs -->
            <ul class="nav nav-tabs" id="placementsTabs" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="active-tab" data-bs-toggle="tab" data-bs-target="#active" type="button">
                    <i class="bi bi-check-circle"></i> –ê–∫—Ç–∏–≤–Ω—ã–µ <span class="badge bg-success" id="activeCount">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="scheduled-tab" data-bs-toggle="tab" data-bs-target="#scheduled" type="button">
                    <i class="bi bi-clock"></i> –ó–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ <span class="badge bg-warning" id="scheduledCount">0</span>
                </button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="history-tab" data-bs-toggle="tab" data-bs-target="#history" type="button">
                    <i class="bi bi-archive"></i> –ò—Å—Ç–æ—Ä–∏—è
                </button>
            </li>
        </ul>

        <!-- Tab Content -->
        <div class="tab-content" id="placementsTabContent">
            <!-- Active Placements -->
            <div class="tab-pane fade show active" id="active" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <!-- Bulk Actions Panel for Active -->
                        <div id="activeBulkActions" class="alert alert-info d-none mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-check2-square me-2"></i>
                                    –í—ã–±—Ä–∞–Ω–æ: <strong id="activeSelectedCount">0</strong> —Ä–∞–∑–º–µ—â–µ–Ω–∏–π
                                    <span class="text-muted ms-2" id="activeLinksInfo"></span>
                                </div>
                                <div>
                                    <button class="btn btn-primary btn-sm me-2" onclick="bulkRenewPlacements()">
                                        <i class="bi bi-clock-history me-1"></i>–ü—Ä–æ–¥–ª–∏—Ç—å –≤—Å–µ
                                    </button>
                                    <button class="btn btn-success btn-sm me-2" onclick="bulkSetAutoRenewal(true)">
                                        <i class="bi bi-arrow-repeat me-1"></i>–í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
                                    </button>
                                    <button class="btn btn-secondary btn-sm" onclick="bulkSetAutoRenewal(false)">
                                        <i class="bi bi-x-circle me-1"></i>–í—ã–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ
                                    </button>
                                </div>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table1">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllActive" onchange="toggleAllActive(this)" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"></th>
                                        <th>ID</th>
                                        <th>–ü—Ä–æ–µ–∫—Ç</th>
                                        <th class="col-site">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                        <th class="col-published sortable-header" onclick="sortActiveBy('published')">
                                            –û–ø—É–±–ª.
                                            <span class="sort-icon"><i class="bi bi-arrow-down-up"></i></span>
                                        </th>
                                        <th class="col-published sortable-header" onclick="sortActiveBy('expires')">
                                            –ò—Å—Ç–µ–∫.
                                            <span class="sort-icon"><i class="bi bi-arrow-down-up"></i></span>
                                        </th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th class="col-autorenewal">–ê–≤—Ç–æ</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                        <th>DR</th>
                                        <th>DA</th>
                                        <th>TF</th>
                                        <th>CF</th>
                                        <th>RD</th>
                                        <th>RDm</th>
                                        <th>Norm</th>
                                        <th>KW</th>
                                        <th>Traf</th>
                                        <th>GEO</th>
                                        <th>–¢–∏–ø —Å–∞–π—Ç–∞</th>
                                        <th>–¢–∏–ø</th>
                                    </tr>
                                </thead>
                                <tbody id="activePlacementsTable">
                                    <tr>
                                        <td colspan="21" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scheduled Placements -->
            <div class="tab-pane fade" id="scheduled" role="tabpanel">
                <div class="card">
                    <div class="card-body">
                        <div class="alert alert-info">
                            <i class="bi bi-info-circle"></i> –≠—Ç–∏ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –±—É–¥—É—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ —É–∫–∞–∑–∞–Ω–Ω—É—é –¥–∞—Ç—É.
                        </div>

                        <!-- Bulk Actions Panel -->
                        <div id="scheduledBulkActions" class="alert alert-warning d-none mb-3">
                            <div class="d-flex align-items-center justify-content-between">
                                <div>
                                    <i class="bi bi-check2-square me-2"></i>
                                    –í—ã–±—Ä–∞–Ω–æ: <strong id="scheduledSelectedCount">0</strong> —Ä–∞–∑–º–µ—â–µ–Ω–∏–π
                                    <span class="mx-2">|</span>
                                    –°—É–º–º–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞: <strong id="scheduledRefundTotal">$0.00</strong>
                                </div>
                                <button class="btn btn-danger btn-sm" onclick="bulkCancelScheduled()">
                                    <i class="bi bi-trash me-1"></i>–û—Ç–º–µ–Ω–∏—Ç—å –≤—ã–±—Ä–∞–Ω–Ω—ã–µ
                                </button>
                            </div>
                        </div>

                        <div class="table-responsive">
                            <table class="table1">
                                <thead>
                                    <tr>
                                        <th><input type="checkbox" id="selectAllScheduled" onchange="toggleAllScheduled(this)" title="–í—ã–±—Ä–∞—Ç—å –≤—Å–µ"></th>
                                        <th>ID</th>
                                        <th>–ü—Ä–æ–µ–∫—Ç</th>
                                        <th class="col-site">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                        <th class="col-published sortable-header" onclick="sortScheduledBy('scheduled')">
                                            –ü—É–±–ª–∏–∫.
                                            <span class="sort-icon"><i class="bi bi-arrow-down-up"></i></span>
                                        </th>
                                        <th class="col-published sortable-header" onclick="sortScheduledBy('purchased')">
                                            –ö—É–ø–ª–µ–Ω–æ
                                            <span class="sort-icon"><i class="bi bi-arrow-down-up"></i></span>
                                        </th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                        <th>DR</th>
                                        <th>DA</th>
                                        <th>TF</th>
                                        <th>CF</th>
                                        <th>RD</th>
                                        <th>RDm</th>
                                        <th>Norm</th>
                                        <th>KW</th>
                                        <th>Traf</th>
                                        <th>GEO</th>
                                        <th>–¢–∏–ø —Å–∞–π—Ç–∞</th>
                                        <th>–¢–∏–ø</th>
                                    </tr>
                                </thead>
                                <tbody id="scheduledPlacementsTable">
                                    <tr>
                                        <td colspan="21" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- History -->
            <div class="tab-pane fade" id="history" role="tabpanel">
                <div class="card">
                    <div class="card-header">
                        <div class="row">
                            <div class="col-md-6">
                                <h5 class="mb-0">–í—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</h5>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="historyTypeFilter">
                                            <option value="">–í—Å–µ —Ç–∏–ø—ã</option>
                                            <option value="link">–°—Å—ã–ª–∫–∏</option>
                                            <option value="article">–ì–µ—Å—Ç-–ø–æ—Å—Ç—ã</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <select class="form-select form-select-sm" id="historyStatusFilter">
                                            <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                                            <option value="placed">–†–∞–∑–º–µ—â–µ–Ω–æ</option>
                                            <option value="pending_approval">–ù–∞ –º–æ–¥–µ—Ä–∞—Ü–∏–∏</option>
                                            <option value="expired">–ò—Å—Ç–µ–∫–ª–æ</option>
                                            <option value="cancelled">–û—Ç–º–µ–Ω–µ–Ω–æ</option>
                                            <option value="rejected">–û—Ç–∫–ª–æ–Ω–µ–Ω–æ</option>
                                            <option value="failed">–û—à–∏–±–∫–∞</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table1">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>–ü—Ä–æ–µ–∫—Ç</th>
                                        <th class="col-site">–ü–ª–æ—â–∞–¥–∫–∞</th>
                                        <th>–°—Ç–∞—Ç—É—Å</th>
                                        <th class="col-published">–û–ø—É–±–ª.</th>
                                        <th class="col-published">–ò—Å—Ç–µ–∫.</th>
                                        <th>–¶–µ–Ω–∞</th>
                                        <th>–ü—Ä–æ–¥.</th>
                                        <th>DR</th>
                                        <th>DA</th>
                                        <th>TF</th>
                                        <th>CF</th>
                                        <th>RD</th>
                                        <th>RDm</th>
                                        <th>Norm</th>
                                        <th>KW</th>
                                        <th>Traf</th>
                                        <th>GEO</th>
                                        <th>–¢–∏–ø —Å–∞–π—Ç–∞</th>
                                        <th>–¢–∏–ø</th>
                                    </tr>
                                </thead>
                                <tbody id="historyPlacementsTable">
                                    <tr>
                                        <td colspan="20" class="text-center text-muted">–ó–∞–≥—Ä—É–∑–∫–∞...</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        <nav id="historyPagination"></nav>
                    </div>
                </div>
            </div>
        </div>
        </div> <!-- END card -->
    </div>

    <!-- Purchase Placement Modal -->
    <div class="modal fade" id="purchasePlacementModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–ö—É–ø–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Step 1: Select Project -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">1. –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç</label>
                        <select class="form-select" id="purchaseProjectSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç --</option>
                        </select>
                    </div>

                    <!-- Step 2: Select Type -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">2. –¢–∏–ø —Ä–∞–∑–º–µ—â–µ–Ω–∏—è</label>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="purchaseType" id="purchaseTypeLink" value="link" checked>
                                    <label class="form-check-label" for="purchaseTypeLink">
                                        <strong>–ì–ª–∞–≤–Ω–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞</strong> ‚Äî $<span id="purchaseLinkPrice">25.00</span>
                                        <br><small class="text-muted">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –Ω–∞ 1 –≥–æ–¥, –º–æ–∂–Ω–æ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å</small>
                                        <br><small class="text-success">–ü—Ä–æ–¥–ª–µ–Ω–∏–µ: $<span id="purchaseLinkRenewalPrice">17.50</span>/–≥–æ–¥</small>
                                    </label>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-check">
                                    <input class="form-check-input" type="radio" name="purchaseType" id="purchaseTypeArticle" value="article">
                                    <label class="form-check-label" for="purchaseTypeArticle">
                                        <strong>–ì–µ—Å—Ç-–ø–æ—Å—Ç</strong> ‚Äî $<span id="purchaseArticlePrice">15.00</span>
                                        <br><small class="text-muted">–ë–µ—Å—Å—Ä–æ—á–Ω–æ–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ</small>
                                        <br><small class="text-muted">–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ</small>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Step 3: Select Site -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">3. –í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–π—Ç</label>
                        <select class="form-select" id="purchaseSiteSelect">
                            <option value="">-- –í—ã–±–µ—Ä–∏—Ç–µ —Å–∞–π—Ç --</option>
                        </select>
                    </div>

                    <!-- Step 4: Select Content -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">4. –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–Ω—Ç–µ–Ω—Ç</label>
                        <select class="form-select" id="purchaseContentSelect" size="5" disabled>
                            <option value="">–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –ø—Ä–æ–µ–∫—Ç –∏ —Ç–∏–ø</option>
                        </select>
                        <small class="text-muted">–ú–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ–¥–∏–Ω —ç–ª–µ–º–µ–Ω—Ç</small>
                    </div>

                    <!-- Step 5: Publish Date -->
                    <div class="mb-3">
                        <label class="form-label fw-bold">5. –î–∞—Ç–∞ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏</label>
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="publishTime" id="publishImmediate" value="immediate" checked>
                            <label class="form-check-label" for="publishImmediate">
                                –û–ø—É–±–ª–∏–∫–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É
                            </label>
                        </div>
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="publishTime" id="publishScheduled" value="scheduled">
                            <label class="form-check-label" for="publishScheduled">
                                –û—Ç–ª–æ–∂–µ–Ω–Ω–∞—è –ø—É–±–ª–∏–∫–∞—Ü–∏—è (–¥–æ 90 –¥–Ω–µ–π)
                            </label>
                        </div>
                        <div class="mt-2" id="scheduledDatePicker" style="display: none;">
                            <input type="datetime-local" class="form-control" id="scheduledDate">
                            <small class="text-muted">–†–∞–∑–º–µ—â–µ–Ω–∏–µ –±—É–¥–µ—Ç –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤ –≤—ã–±—Ä–∞–Ω–Ω—É—é –¥–∞—Ç—É</small>
                        </div>
                    </div>

                    <!-- Step 6: Auto-renewal (only for links) -->
                    <div class="mb-3" id="autoRenewalOption" style="display: none;">
                        <label class="form-label fw-bold">6. –ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ</label>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="autoRenewalCheckbox">
                            <label class="form-check-label" for="autoRenewalCheckbox">
                                –í–∫–ª—é—á–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –≥–æ–¥
                                <br><small class="text-muted">–°—Ä–µ–¥—Å—Ç–≤–∞ –±—É–¥—É—Ç —Å–ø–∏—Å—ã–≤–∞—Ç—å—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞ 7 –¥–Ω–µ–π –¥–æ –∏—Å—Ç–µ—á–µ–Ω–∏—è</small>
                            </label>
                        </div>
                    </div>

                    <hr>

                    <!-- Price Summary -->
                    <div class="p-3 bg-light rounded">
                        <div class="row">
                            <div class="col-6">
                                <p class="mb-1">–ë–∞–∑–æ–≤–∞—è —Ü–µ–Ω–∞:</p>
                                <p class="mb-1">–í–∞—à–∞ —Å–∫–∏–¥–∫–∞ (<span id="purchaseUserDiscount">0</span>%):</p>
                                <p class="mb-1">–í–∞—à –±–∞–ª–∞–Ω—Å:</p>
                                <p class="mb-0"><strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong></p>
                            </div>
                            <div class="col-6 text-end">
                                <p class="mb-1">$<span id="purchaseBasePrice">0.00</span></p>
                                <p class="mb-1 text-success">-$<span id="purchaseDiscountAmount">0.00</span></p>
                                <p class="mb-1" id="currentBalanceDisplay">$<span id="purchaseCurrentBalance">0.00</span></p>
                                <p class="mb-0"><strong class="text-primary fs-4">$<span id="purchaseFinalPrice">0.00</span></strong></p>
                            </div>
                        </div>
                    </div>

                    <!-- Insufficient Balance Warning -->
                    <div class="alert alert-danger mt-3" id="insufficientBalanceAlert" style="display: none;">
                        <i class="bi bi-exclamation-triangle"></i>
                        –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤ –Ω–∞ –±–∞–ª–∞–Ω—Å–µ. –ù–µ–æ–±—Ö–æ–¥–∏–º–æ –ø–æ–ø–æ–ª–Ω–∏—Ç—å –Ω–∞ $<span id="amountNeeded">0.00</span>
                        <br>
                        <a href="/balance.html" class="btn btn-sm btn-success mt-2">–ü–æ–ø–æ–ª–Ω–∏—Ç—å –±–∞–ª–∞–Ω—Å</a>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="button" class="btn btn-success" id="confirmPurchaseBtn" disabled onclick="confirmPurchase()">
                        <i class="bi bi-cart-check"></i> –ö—É–ø–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Options Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">–í—ã–±–µ—Ä–∏—Ç–µ —á—Ç–æ —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-primary" onclick="confirmExport('all')">
                            <i class="bi bi-file-earmark-spreadsheet"></i> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –≤—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è
                        </button>
                        <button class="btn btn-primary" onclick="confirmExport('filtered')">
                            <i class="bi bi-file-earmark-text"></i> –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–æ–ª—å–∫–æ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–µ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/badge-utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/purchase-modal.js"></script>
    <script src="/js/placements-manager.js"></script>
    <script src="/js/placements-manager-filters.js"></script>
    <script src="/js/navbar-config.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        // Initialize navbar
        initNavbar('user', 'placements-manager');

        // =====================
        // Column Visibility Management
        // =====================
        const COLUMN_STORAGE_KEY = 'placements_columns_visibility';

        // Mapping column ID to header text patterns (for finding columns dynamically)
        // Note: Using startsWith matching, so '–û–ø—É–±–ª' matches '–û–ø—É–±–ª.' and '–ü—É–±–ª–∏–∫.'
        const columnHeaderMap = {
            'id': 'ID',
            'project': '–ü—Ä–æ–µ–∫—Ç',
            'site': '–ü–ª–æ—â–∞–¥–∫–∞',
            'published': '–û–ø—É–±–ª',      // Matches '–û–ø—É–±–ª.' in Active table
            'scheduled': '–ü—É–±–ª–∏–∫',      // Matches '–ü—É–±–ª–∏–∫.' in Scheduled table
            'expires': '–ò—Å—Ç–µ–∫',        // Matches '–ò—Å—Ç–µ–∫.' in Active table
            'purchased': '–ö—É–ø–ª–µ–Ω–æ',    // For Scheduled table
            'price': '–¶–µ–Ω–∞',
            'autorenewal': '–ê–≤—Ç–æ',
            'actions': '–î–µ–π—Å—Ç–≤–∏—è',
            'status': '–°—Ç–∞—Ç—É—Å',        // For History table
            'renewals': '–ü—Ä–æ–¥.',       // For History table (–ü—Ä–æ–¥–ª–µ–Ω–∏–π)
            'dr': 'DR',
            'da': 'DA',
            'tf': 'TF',
            'cf': 'CF',
            'rd': 'RD',
            'rdm': 'RDm',
            'norm': 'Norm',
            'kw': 'KW',
            'traf': 'Traf',
            'geo': 'GEO',
            'sitetype': '–¢–∏–ø —Å–∞–π—Ç–∞',
            'type': '–¢–∏–ø'
        };

        // Default visible columns
        const defaultVisibleColumns = ['id', 'project', 'site', 'published', 'expires', 'price', 'autorenewal', 'actions', 'dr', 'da', 'type'];

        // Load saved column settings
        function loadColumnSettings() {
            const saved = localStorage.getItem(COLUMN_STORAGE_KEY);
            if (saved) {
                try {
                    return JSON.parse(saved);
                } catch (e) {
                    return [...defaultVisibleColumns];
                }
            }
            return [...defaultVisibleColumns];
        }

        // Save column settings
        function saveColumnSettings(columns) {
            localStorage.setItem(COLUMN_STORAGE_KEY, JSON.stringify(columns));
        }

        // Find column index by header text in a specific table
        function findColumnIndex(table, headerText) {
            const headers = table.querySelectorAll('thead th');
            for (let i = 0; i < headers.length; i++) {
                const text = headers[i].textContent.trim();
                if (text.startsWith(headerText) || text === headerText) {
                    return i;
                }
            }
            return -1;
        }

        // Toggle column visibility
        function toggleColumn(columnId) {
            const checkbox = document.getElementById('col-' + columnId);
            const isVisible = checkbox ? checkbox.checked : false;
            const headerText = columnHeaderMap[columnId];

            if (!headerText) return;

            // Toggle visibility for all tables
            const tables = document.querySelectorAll('.table1');
            tables.forEach(table => {
                const colIndex = findColumnIndex(table, headerText);
                if (colIndex === -1) return;

                const rows = table.querySelectorAll('tr');
                rows.forEach(row => {
                    const cell = row.children[colIndex];
                    if (cell) {
                        cell.style.display = isVisible ? '' : 'none';
                    }
                });
            });

            // Update saved settings
            const visibleColumns = getVisibleColumns();
            saveColumnSettings(visibleColumns);
        }

        // Get currently visible columns
        function getVisibleColumns() {
            const visible = [];
            Object.keys(columnHeaderMap).forEach(col => {
                const checkbox = document.getElementById('col-' + col);
                if (checkbox && checkbox.checked) {
                    visible.push(col);
                }
            });
            return visible;
        }

        // Show all columns
        function showAllColumns() {
            Object.keys(columnHeaderMap).forEach(col => {
                const checkbox = document.getElementById('col-' + col);
                if (checkbox) {
                    checkbox.checked = true;
                }
            });
            applyColumnSettings();
        }

        // Hide optional columns (show only essential)
        function hideOptionalColumns() {
            const essentialColumns = ['id', 'project', 'site', 'published', 'expires', 'price', 'autorenewal', 'actions'];
            Object.keys(columnHeaderMap).forEach(col => {
                const checkbox = document.getElementById('col-' + col);
                if (checkbox) {
                    checkbox.checked = essentialColumns.includes(col);
                }
            });
            applyColumnSettings();
        }

        // Apply column settings to all tables
        function applyColumnSettings() {
            const visibleColumns = loadColumnSettings();

            // Update checkboxes first
            Object.keys(columnHeaderMap).forEach(col => {
                const checkbox = document.getElementById('col-' + col);
                if (checkbox) {
                    checkbox.checked = visibleColumns.includes(col);
                }
            });

            // Apply to all tables
            const tables = document.querySelectorAll('.table1');
            tables.forEach(table => {
                Object.keys(columnHeaderMap).forEach(col => {
                    const headerText = columnHeaderMap[col];
                    const colIndex = findColumnIndex(table, headerText);
                    if (colIndex === -1) return;

                    const shouldBeVisible = visibleColumns.includes(col);
                    const rows = table.querySelectorAll('tr');
                    rows.forEach(row => {
                        const cell = row.children[colIndex];
                        if (cell) {
                            cell.style.display = shouldBeVisible ? '' : 'none';
                        }
                    });
                });
            });
        }

        // Toggle filters panel
        function toggleFiltersPanel() {
            const filtersCard = document.querySelector('.container > .card.mb-3');
            const btn = document.getElementById('filtersToggleBtn');

            if (filtersCard) {
                const isHidden = filtersCard.style.display === 'none';
                filtersCard.style.display = isHidden ? '' : 'none';

                if (btn) {
                    btn.classList.toggle('active', !isHidden);
                    if (!isHidden) {
                        btn.innerHTML = '<i class="bi bi-funnel"></i> –§–∏–ª—å—Ç—Ä—ã';
                    } else {
                        btn.innerHTML = '<i class="bi bi-funnel-fill"></i> –§–∏–ª—å—Ç—Ä—ã';
                    }
                }
            }
        }

        // Apply column settings after tables are loaded
        document.addEventListener('DOMContentLoaded', function() {
            // Wait for tables to be rendered
            setTimeout(applyColumnSettings, 500);
        });

        // Re-apply settings when tabs change or data loads
        document.addEventListener('shown.bs.tab', function() {
            setTimeout(applyColumnSettings, 100);
        });

        // Global function to reapply column settings (called after table data loads)
        window.reapplyColumnSettings = function() {
            setTimeout(applyColumnSettings, 100);
        };
    </script>
</body>
</html>
