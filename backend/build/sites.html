<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <style>
        /* Custom styles for sites table */
        .table-responsive {
            overflow-x: auto;
        }

        /* Card border styling */
        .card {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
        }

        .table thead {
            position: sticky;
            top: 0;
            z-index: 10;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .table tbody tr {
            transition: all 0.2s ease;
        }

        .table tbody tr:hover {
            transform: scale(1.01);
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        /* Row background colors with transparency for better visibility */
        .table-danger {
            background-color: rgba(220, 38, 38, 0.08) !important;
        }

        .table-success {
            background-color: rgba(34, 197, 94, 0.08) !important;
        }

        /* Progress bar custom styling */
        .progress {
            background-color: #e9ecef;
            border-radius: 4px;
        }

        /* Icon buttons styling */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Tooltip-enabled icons */
        [title] {
            cursor: help;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table thead th:nth-child(4),
            .table thead th:nth-child(5),
            .table thead th:nth-child(6),
            .table thead th:nth-child(7) {
                display: none;
            }

            .table tbody td:nth-child(4),
            .table tbody td:nth-child(5),
            .table tbody td:nth-child(6),
            .table tbody td:nth-child(7) {
                display: none;
            }
        }

        /* Inline editable price cells */
        .price-cell {
            cursor: pointer;
            position: relative;
            min-width: 80px;
            transition: background-color 0.2s;
        }

        .price-cell:hover:not(.editing):not(.saving) {
            background-color: #f8f9fa;
        }

        .price-cell:hover:not(.editing):not(.saving)::after {
            content: "✎";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #6c757d;
        }

        .price-cell.editing {
            background-color: #fff3cd;
        }

        .price-cell.saving {
            opacity: 0.6;
            pointer-events: none;
            cursor: wait;
        }

        .price-input {
            width: 70px;
            display: inline-block;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .price-display {
            display: inline-block;
        }
    </style>
</head>
<body>
    <!-- Navbar Container (injected by navbar.js) -->
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Sites</h1>
            <div class="d-flex gap-2">
                <button class="btn btn-light border" style="background: white !important; color: #333 !important;" onclick="showExportModal()">
                    <i class="bi bi-download"></i> Export Sites
                </button>
                <button class="btn btn-light border" style="background: white !important; color: #333 !important;" onclick="showCreateModal()">
                    <i class="bi bi-plus-circle"></i> Add Site
                </button>
            </div>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" placeholder="Search sites...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <!-- Bulk Actions Bar (скрыта по умолчанию) -->
        <div id="bulkActionsBar" class="alert alert-primary py-1 d-none mb-2" style="font-size: 10px;">
            <div class="d-flex align-items-center flex-wrap gap-2">
                <strong class="me-2">Выбрано: <span id="selectedCount">0</span></strong>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-success py-1 px-2" onclick="bulkSetField('allow_articles', true)">
                        <i class="bi bi-file-text-fill"></i> Статьи ВКЛ
                    </button>
                    <button class="btn btn-outline-secondary py-1 px-2" onclick="bulkSetField('allow_articles', false)">
                        <i class="bi bi-file-text"></i> ВЫКЛ
                    </button>
                </div>
                <div class="btn-group btn-group-sm admin-only-field" role="group" id="bulkPublicButtons" style="display: none;">
                    <button class="btn btn-primary py-1 px-2" onclick="bulkSetField('is_public', true)">
                        <i class="bi bi-globe"></i> Публичные
                    </button>
                    <button class="btn btn-outline-secondary py-1 px-2" onclick="bulkSetField('is_public', false)">
                        <i class="bi bi-lock-fill"></i> Личные
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-success py-1 px-2" onclick="bulkSetField('available_for_purchase', true)">
                        <i class="bi bi-cart-check-fill"></i> Покупка ВКЛ
                    </button>
                    <button class="btn btn-outline-danger py-1 px-2" onclick="bulkSetField('available_for_purchase', false)">
                        <i class="bi bi-cart-x-fill"></i> ВЫКЛ
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-outline-success py-1 px-2 bulk-price-btn" data-field="price_link">
                        <i class="bi bi-cash-stack"></i> Цена Main
                    </button>
                    <button class="btn btn-outline-info py-1 px-2 bulk-price-btn" data-field="price_article">
                        <i class="bi bi-file-text"></i> Цена GP
                    </button>
                </div>
                <button class="btn btn-sm btn-secondary py-1 px-2" onclick="clearBulkSelection()">
                    <i class="bi bi-x-lg"></i> Отмена
                </button>
            </div>
        </div>

        <!-- Sites Table Card -->
        <div class="card">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="text-muted">Показано: <strong id="sitesCount">0</strong> из <strong id="sitesTotal">0</strong></span>
                    </div>
                    <div>
                        <label class="me-2">На странице:</label>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="limitSelect">
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                    </div>
                </div>

                <div class="table-responsive">
                    <table class="table table-hover align-middle" style="font-size: 12px;">
                        <thead class="table-light sticky-top">
                            <tr>
                                <th class="text-center" style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="selectAllSites" onchange="toggleSelectAll()">
                                </th>
                                <th style="max-width: 200px;">Site Name</th>
                                <th class="text-center" style="width: 60px;">Main</th>
                                <th class="text-center" style="width: 60px;">GP</th>
                                <th class="text-center" style="width: 40px;">DR</th>
                                <th class="text-center" style="width: 40px;">DA</th>
                                <th class="text-center" style="width: 40px;">TF</th>
                                <th class="text-center" style="width: 40px;">CF</th>
                                <th class="text-center" style="width: 50px;">RD</th>
                                <th class="text-center" style="width: 50px;">RDm</th>
                                <th class="text-center" style="width: 50px;">Norm</th>
                                <th class="text-center" style="width: 60px;">KW</th>
                                <th class="text-center" style="width: 60px;">Traf</th>
                                <th class="text-center" style="width: 50px;">GEO</th>
                                <th class="text-center" style="width: 80px;">Тип</th>
                                <th class="text-center" style="width: 60px;" title="Открыть сайт">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </th>
                                <th style="width: 120px;">Links</th>
                                <th style="width: 120px;">Articles</th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-file-text" data-bs-toggle="tooltip" data-bs-placement="top" title="Разрешить размещение гест-постов"></i>
                                </th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-globe" data-bs-toggle="tooltip" data-bs-placement="top" title="Публичный сайт"></i>
                                </th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-cart-check" data-bs-toggle="tooltip" data-bs-placement="top" title="Доступен для покупки"></i>
                                </th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <!-- Sites will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls -->
                <nav aria-label="Sites pagination" class="mt-3">
                    <ul class="pagination justify-content-center" id="paginationControls">
                        <!-- Pagination buttons will be generated here -->
                    </ul>
                </nav>
            </div>
        </div>

        <!-- Bulk Registration Section -->
        <div class="card mt-5 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-cloud-arrow-down"></i> Массовая регистрация WordPress сайтов
                </h5>
                <p class="small mb-3 opacity-75">
                    Сгенерируйте токен регистрации и используйте его на множестве WordPress сайтов с плагином Link Manager для быстрого добавления в систему.
                </p>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small">Название токена</label>
                        <input type="text" class="form-control" id="tokenLabel" placeholder="Например: Январь 2025">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Макс. использований</label>
                        <input type="number" class="form-control" id="tokenMaxUses" value="0" min="0" placeholder="0 = безлимит">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">Срок действия (дней)</label>
                        <input type="number" class="form-control" id="tokenExpireDays" value="30" min="1" placeholder="30">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">&nbsp;</label>
                        <button class="btn btn-light w-100" onclick="generateRegistrationToken()">
                            <i class="bi bi-key"></i> Создать
                        </button>
                    </div>
                </div>

                <!-- Active Tokens List -->
                <div id="activeTokensList" class="mt-4">
                    <!-- Tokens will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal fade" id="siteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Site</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="siteForm">
                        <input type="hidden" id="siteId">

                        <!-- Site Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Тип сайта *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="siteType" id="siteTypeWordPress" value="wordpress" checked onchange="toggleSiteTypeFields()">
                                <label class="btn btn-primary" for="siteTypeWordPress">
                                    <i class="bi bi-wordpress"></i> WordPress
                                </label>

                                <input type="radio" class="btn-check" name="siteType" id="siteTypeStatic" value="static_php" onchange="toggleSiteTypeFields()">
                                <label class="btn btn-outline-success" for="siteTypeStatic">
                                    <i class="bi bi-filetype-php"></i> Статичный PHP
                                </label>
                            </div>
                            <small class="form-text text-muted d-block mt-1">
                                <span id="typeHintWordPress">WordPress с установленным плагином Link Manager</span>
                                <span id="typeHintStatic" style="display:none">Статичный сайт с PHP виджетом (только ссылки)</span>
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="siteName" class="form-label">Site Name *</label>
                            <input type="text" class="form-control" id="siteName" required>
                        </div>

                        <div class="mb-3">
                            <label for="siteUrl" class="form-label">Site URL *</label>
                            <input type="url" class="form-control" id="siteUrl" required
                                   placeholder="https://example.com">
                        </div>

                        <!-- API Key field (shown for WordPress, auto-generated for static) -->
                        <div id="apiKeyField" class="mb-3">
                            <label for="apiKey" class="form-label">
                                API Token
                                <span id="apiKeyRequired">*</span>
                                <span id="apiKeyAutoNote" style="display:none;" class="badge bg-success ms-2">Auto-generated</span>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="apiKey"
                                       placeholder="Получите токен из плагина на вашем WordPress сайте">
                                <button class="btn btn-primary" type="button" onclick="copyFieldToClipboard('apiKey')" id="copyApiKeyBtn">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                            <small class="form-text text-muted" id="apiKeyHint">
                                <i class="bi bi-info-circle"></i> <span id="apiKeyHintText">Установите плагин Link Manager на WordPress и скопируйте токен из настроек</span>
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxLinks" class="form-label">Max Links *</label>
                                <input type="number" class="form-control" id="maxLinks" required min="0" value="10">
                            </div>
                            <div class="col-md-6 mb-3" id="maxArticlesField">
                                <label for="maxArticles" class="form-label">Max Articles *</label>
                                <input type="number" class="form-control" id="maxArticles" required min="0" value="10">
                            </div>
                        </div>

                        <!-- Price Fields -->
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="priceLink" class="form-label">
                                    <i class="bi bi-tag"></i> Цена за ссылку (USD)
                                </label>
                                <input type="number" class="form-control" id="priceLink" min="0" step="0.01" placeholder="25.00">
                                <small class="text-muted">Оставьте пустым для $25 по умолчанию</small>
                            </div>
                            <div class="col-md-6 mb-3" id="priceArticleField">
                                <label for="priceArticle" class="form-label">
                                    <i class="bi bi-tag"></i> Цена за гест-пост (USD)
                                </label>
                                <input type="number" class="form-control" id="priceArticle" min="0" step="0.01" placeholder="15.00">
                                <small class="text-muted">Оставьте пустым для $15 по умолчанию</small>
                            </div>
                        </div>

                        <!-- Allow Articles checkbox (WordPress only) -->
                        <div class="mb-3" id="allowArticlesField">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="allowArticles" checked>
                                <label class="form-check-label" for="allowArticles">
                                    <i class="bi bi-file-text"></i> Разрешить размещение гест-постов
                                </label>
                            </div>
                            <small class="text-muted">
                                Снимите галочку, чтобы запретить покупку гест-постов на этом сайте (ссылки будут доступны)
                            </small>
                        </div>

                        <!-- Public Availability (Admin Only) -->
                        <div class="mb-3 admin-only-field" id="isPublicFieldWrapper" style="display: none;">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="isPublic">
                                <label class="form-check-label" for="isPublic">
                                    <i class="bi bi-globe"></i> Разрешить публичные покупки
                                </label>
                            </div>
                            <small class="text-muted">
                                <span class="badge bg-warning text-dark">Только админ</span>
                                Включите, чтобы другие пользователи могли размещать контент на вашем сайте.
                            </small>
                        </div>

                        <!-- Available for Purchase -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="availableForPurchase" checked>
                                <label class="form-check-label" for="availableForPurchase">
                                    <i class="bi bi-cart-check"></i> Доступен для покупки
                                </label>
                            </div>
                            <small class="text-muted">
                                Снимите галочку, чтобы временно закрыть сайт для новых размещений. Старые размещения останутся активными.
                            </small>
                        </div>

                        <!-- WordPress Plugin Info -->
                        <div class="alert alert-info" id="wordpressPluginInfo">
                            <h6><i class="bi bi-wordpress"></i> WordPress Plugin Required</h6>
                            <p class="mb-2">To enable link placement, install the Link Manager plugin on your WordPress site:</p>
                            <a href="/link-manager-widget.zip" download="link-manager-widget.zip" class="btn btn-sm btn-success">
                                <i class="bi bi-download"></i> Download Plugin (ZIP)
                            </a>
                            <small class="d-block mt-2 text-muted">Upload and activate this plugin in your WordPress admin panel</small>
                        </div>

                        <!-- Static PHP Widget Info -->
                        <div class="alert alert-success" id="staticWidgetInfo" style="display:none">
                            <h6><i class="bi bi-filetype-php"></i> PHP Widget для статичных сайтов</h6>
                            <p class="mb-2">Скачайте виджет и установите на ваш PHP сайт:</p>
                            <div class="d-grid gap-2">
                                <a href="/static.php" download="static.php" class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> Скачать static.php
                                </a>
                            </div>
                            <small class="d-block mt-2">
                                <strong>3 простых шага:</strong><br>
                                1. Откройте <code>static.php</code> в редакторе и замените <code>YOUR_API_KEY_HERE</code> на ваш API ключ<br>
                                2. Загрузите файл в корень сайта<br>
                                3. Добавьте <code>&lt;?php include 'static.php'; ?&gt;</code> где нужно отобразить ссылки
                            </small>
                            <div class="alert alert-warning mt-2 mb-0">
                                <small><i class="bi bi-exclamation-triangle"></i> <strong>Важно:</strong> Статичные сайты поддерживают только ссылки, гест-посты недоступны.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSite()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Sites Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-download"></i> Export Sites
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Format selector -->
                    <div class="mb-3">
                        <label class="form-label">Export Format:</label>
                        <select class="form-select" id="exportFormat" onchange="updateExportPreview()">
                            <option value="csv">CSV (for Excel/Sheets)</option>
                            <option value="tsv">Tab-separated (for pasting)</option>
                            <option value="plain">Plain text (formatted)</option>
                            <option value="json">JSON (backup)</option>
                        </select>
                    </div>

                    <!-- Preview area -->
                    <div class="mb-3">
                        <label class="form-label">Preview:</label>
                        <textarea class="form-control font-monospace"
                                  id="exportPreview"
                                  rows="15"
                                  readonly
                                  style="font-size: 0.85rem; white-space: pre; overflow-x: auto;"></textarea>
                    </div>

                    <!-- Stats -->
                    <div class="text-muted small">
                        <i class="bi bi-info-circle"></i>
                        Total sites: <strong id="exportCount">0</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyExportToClipboard()">
                        <i class="bi bi-clipboard"></i> Copy to Clipboard
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadExport()">
                        <i class="bi bi-download"></i> Download File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/navbar-config.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        // Initialize navbar
        initNavbar('user', 'sites');

        if (!isAuthenticated()) {
            window.location.href = '/index.html';
        }

        let sites = [];
        let modal;
        let exportModal;
        let currentPage = 1;
        let currentLimit = 100;
        let totalSites = 0;
        let totalPages = 0;

        document.addEventListener('DOMContentLoaded', async () => {
            modal = new bootstrap.Modal(document.getElementById('siteModal'));
            exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

            // Load saved limit preference
            const savedLimit = parseInt(localStorage.getItem('sitesPageLimit')) || 100;
            currentLimit = savedLimit;
            document.getElementById('limitSelect').value = savedLimit;

            await loadSites();
            await loadActiveTokens(); // Load active registration tokens on page load

            // Show admin-only fields if user is admin
            if (isAdmin()) {
                document.querySelectorAll('.admin-only-field').forEach(el => {
                    el.style.display = '';
                });
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(() => {
                loadSites(1, currentLimit);
            }, 500));
            document.getElementById('statusFilter').addEventListener('change', () => {
                loadSites(1, currentLimit);
            });
            document.getElementById('limitSelect').addEventListener('change', (e) => {
                const newLimit = parseInt(e.target.value);
                localStorage.setItem('sitesPageLimit', newLimit);
                loadSites(1, newLimit);
            });

            // Event delegation for price cell double-click
            document.getElementById('sitesTableBody').addEventListener('dblclick', (e) => {
                const cell = e.target.closest('.price-cell');
                if (!cell) return;

                const siteId = parseInt(cell.dataset.siteId);
                const field = cell.dataset.field;

                enablePriceEdit(cell, siteId, field);
            });

            // Event listeners for bulk price buttons
            document.querySelectorAll('.bulk-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showBulkPriceModal(btn.dataset.field);
                });
            });

            // Event listener for apply bulk price button
            const applyBtn = document.getElementById('applyBulkPriceBtn');
            if (applyBtn) {
                applyBtn.addEventListener('click', applyBulkPrice);
            }
        });

        async function loadSites(page = 1, limit = currentLimit) {
            try {
                currentPage = page;
                currentLimit = limit;

                const response = await SitesAPI.getAll(page, limit);
                sites = response.data || [];
                totalSites = response.pagination?.total || 0;
                totalPages = response.pagination?.pages || 0;

                displaySites();
                updatePaginationControls();
                updateSitesCount();
            } catch (error) {
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function displaySites() {
            const tbody = document.getElementById('sitesTableBody');
            tbody.innerHTML = sites.map(s => {
                const siteType = s.site_type || 'wordpress';
                const typeBadge = siteType === 'wordpress'
                    ? '<span class="badge bg-primary" style="font-size: 0.7rem;"><i class="bi bi-wordpress"></i> WP</span>'
                    : '<span class="badge bg-success" style="font-size: 0.7rem;"><i class="bi bi-filetype-php"></i> PHP</span>';

                // Row background color based on status
                let rowClass = '';
                if (s.available_for_purchase === false) {
                    rowClass = 'table-danger';
                } else if (s.is_public === true) {
                    rowClass = 'table-success';
                }

                // Calculate usage percentages for progress bars
                const linksUsed = s.used_links || 0;
                const linksMax = s.max_links || 0;
                const linksPercent = linksMax > 0 ? (linksUsed / linksMax * 100) : 0;
                const linksColor = linksPercent >= 90 ? 'danger' : linksPercent >= 70 ? 'warning' : 'success';

                const articlesUsed = s.used_articles || 0;
                const articlesMax = s.max_articles || 0;
                const articlesPercent = articlesMax > 0 ? (articlesUsed / articlesMax * 100) : 0;
                const articlesColor = articlesPercent >= 90 ? 'danger' : articlesPercent >= 70 ? 'warning' : 'success';

                // DR value with color coding
                const drValue = s.dr || 0;
                const drClass = drValue >= 50 ? 'text-success fw-bold' : drValue >= 20 ? 'text-primary' : 'text-muted';

                // DA value with color coding
                const daValue = s.da || 0;
                const daClass = daValue >= 50 ? 'text-success fw-bold' : daValue >= 20 ? 'text-primary' : 'text-muted';

                // TF value with color coding
                const tfValue = s.tf || 0;
                const tfClass = tfValue >= 50 ? 'text-success fw-bold' : tfValue >= 20 ? 'text-primary' : 'text-muted';

                // CF value with color coding
                const cfValue = s.cf || 0;
                const cfClass = cfValue >= 50 ? 'text-success fw-bold' : cfValue >= 20 ? 'text-primary' : 'text-muted';

                // Ref Domains, RD Main, Norm, Keywords, Traffic values
                const refDomainsValue = s.ref_domains || 0;
                const rdMainValue = s.rd_main || 0;
                const normValue = s.norm || 0;
                const keywordsValue = s.keywords || 0;
                const trafficValue = s.traffic || 0;

                // GEO value
                const geoValue = s.geo || 'EN';

                // Clean site name - remove https:// and trailing slash
                const cleanSiteName = (s.site_name || '').replace(/^https?:\/\//, '').replace(/\/$/, '');

                return `
                <tr class="${rowClass}" data-site-id="${s.id}">
                    <td class="text-center">
                        <input type="checkbox" class="form-check-input site-checkbox" data-site-id="${s.id}" onchange="updateBulkSelection()">
                    </td>
                    <td style="max-width: 200px;">
                        <div class="fw-semibold text-truncate" title="${escapeHtml(s.site_name)}">${escapeHtml(cleanSiteName)}</div>
                    </td>
                    <td class="text-center price-cell"
                        data-site-id="${s.id}"
                        data-field="price_link"
                        data-default="25">
                        <span class="price-display">
                            ${s.price_link !== null && s.price_link !== undefined
                                ? `<span class="text-success">$${parseFloat(s.price_link).toFixed(2)}</span>`
                                : '<span class="text-muted">$25</span>'}
                        </span>
                    </td>
                    <td class="text-center price-cell"
                        data-site-id="${s.id}"
                        data-field="price_article"
                        data-default="15">
                        <span class="price-display">
                            ${s.price_article !== null && s.price_article !== undefined
                                ? `<span class="text-success">$${parseFloat(s.price_article).toFixed(2)}</span>`
                                : '<span class="text-muted">$15</span>'}
                        </span>
                    </td>
                    <td class="text-center ${drClass}">${drValue}</td>
                    <td class="text-center ${daClass}">${daValue}</td>
                    <td class="text-center ${tfClass}">${tfValue}</td>
                    <td class="text-center ${cfClass}">${cfValue}</td>
                    <td class="text-center text-muted">${refDomainsValue}</td>
                    <td class="text-center text-muted">${rdMainValue}</td>
                    <td class="text-center text-muted">${normValue}</td>
                    <td class="text-center text-muted">${keywordsValue}</td>
                    <td class="text-center text-muted">${trafficValue}</td>
                    <td class="text-center text-muted">${geoValue}</td>
                    <td class="text-center">
                        ${typeBadge}
                    </td>
                    <td>
                        <a href="${escapeHtml(s.site_url)}" target="_blank" class="btn btn-sm btn-primary" title="${escapeHtml(s.site_url)}">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </td>
                    <td>
                        <div class="text-center fw-semibold mb-1">${linksUsed} / ${linksMax}</div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${linksColor}" role="progressbar"
                                 style="width: ${linksPercent}%"
                                 aria-valuenow="${linksUsed}"
                                 aria-valuemin="0"
                                 aria-valuemax="${linksMax}"></div>
                        </div>
                    </td>
                    <td>
                        ${siteType === 'wordpress' ? `
                            <div class="text-center fw-semibold mb-1">${articlesUsed} / ${articlesMax}</div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-${articlesColor}" role="progressbar"
                                     style="width: ${articlesPercent}%"
                                     aria-valuenow="${articlesUsed}"
                                     aria-valuemin="0"
                                     aria-valuemax="${articlesMax}"></div>
                            </div>
                        ` : '<span class="text-muted">N/A</span>'}
                    </td>
                    <td class="text-center">
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="allowArticles_${s.id}"
                                   ${(siteType === 'wordpress' && s.allow_articles !== false) ? 'checked' : ''}
                                   ${siteType !== 'wordpress' ? 'disabled' : ''}
                                   onchange="toggleSiteField(${s.id}, 'allow_articles', this.checked)">
                        </div>
                    </td>
                    <td class="text-center is-public-cell">
                        ${isAdmin() ? `
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="isPublic_${s.id}"
                                   ${s.is_public === true ? 'checked' : ''}
                                   onchange="toggleSiteField(${s.id}, 'is_public', this.checked)">
                        </div>
                        ` : `
                        <span class="badge ${s.is_public === true ? 'bg-success' : 'bg-secondary'}">${s.is_public === true ? 'Да' : 'Нет'}</span>
                        `}
                    </td>
                    <td class="text-center">
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="available_${s.id}"
                                   ${s.available_for_purchase !== false ? 'checked' : ''}
                                   onchange="toggleSiteField(${s.id}, 'available_for_purchase', this.checked)">
                        </div>
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-primary" onclick="editSite(${s.id})" title="Edit">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteSite(${s.id})" title="Delete">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function updatePaginationControls() {
            const pagination = document.getElementById('paginationControls');
            if (totalPages <= 1) {
                pagination.innerHTML = '';
                return;
            }

            let html = '';

            // Previous button
            html += `<li class="page-item ${currentPage === 1 ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadSites(${currentPage - 1}, ${currentLimit}); return false;" aria-label="Previous">
                    <i class="bi bi-chevron-left"></i>
                </a>
            </li>`;

            // Page numbers (smart display)
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            // First page
            if (startPage > 1) {
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadSites(1, ${currentLimit}); return false;">1</a>
                </li>`;
                if (startPage > 2) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
            }

            // Page buttons
            for (let i = startPage; i <= endPage; i++) {
                html += `<li class="page-item ${i === currentPage ? 'active' : ''}">
                    <a class="page-link" href="#" onclick="loadSites(${i}, ${currentLimit}); return false;">${i}</a>
                </li>`;
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<li class="page-item disabled"><span class="page-link">...</span></li>`;
                }
                html += `<li class="page-item">
                    <a class="page-link" href="#" onclick="loadSites(${totalPages}, ${currentLimit}); return false;">${totalPages}</a>
                </li>`;
            }

            // Next button
            html += `<li class="page-item ${currentPage === totalPages ? 'disabled' : ''}">
                <a class="page-link" href="#" onclick="loadSites(${currentPage + 1}, ${currentLimit}); return false;" aria-label="Next">
                    <i class="bi bi-chevron-right"></i>
                </a>
            </li>`;

            pagination.innerHTML = html;
        }

        function updateSitesCount() {
            document.getElementById('sitesCount').textContent = sites.length;
            document.getElementById('sitesTotal').textContent = totalSites;
        }

        // Toggle site type fields visibility
        function toggleSiteTypeFields() {
            const siteType = document.querySelector('input[name="siteType"]:checked').value;
            const isWordPress = siteType === 'wordpress';

            // Toggle fields visibility
            document.getElementById('maxArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('allowArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('priceArticleField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('wordpressPluginInfo').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('staticWidgetInfo').style.display = isWordPress ? 'none' : 'block';

            // Toggle hints
            document.getElementById('typeHintWordPress').style.display = isWordPress ? 'inline' : 'none';
            document.getElementById('typeHintStatic').style.display = isWordPress ? 'none' : 'inline';

            // Update API key field
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyRequired = document.getElementById('apiKeyRequired');
            const apiKeyAutoNote = document.getElementById('apiKeyAutoNote');
            const apiKeyHintText = document.getElementById('apiKeyHintText');

            if (isWordPress) {
                apiKeyRequired.style.display = 'inline';
                apiKeyAutoNote.style.display = 'none';
                apiKeyHintText.textContent = 'Установите плагин Link Manager на WordPress и скопируйте токен из настроек';
                apiKeyInput.setAttribute('required', 'required');
            } else {
                apiKeyRequired.style.display = 'none';
                apiKeyAutoNote.style.display = 'inline';
                apiKeyHintText.textContent = 'API ключ генерируется автоматически при создании сайта';
                apiKeyInput.removeAttribute('required');
            }

            // Set max_articles to 0 for static PHP sites
            if (!isWordPress) {
                document.getElementById('maxArticles').value = '0';
            }
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Add Site';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteTypeWordPress').checked = true; // Default to WordPress
            document.getElementById('maxLinks').value = '10';
            document.getElementById('maxArticles').value = '10';
            document.getElementById('allowArticles').checked = true; // Default: allow articles
            document.getElementById('availableForPurchase').checked = true; // Default: available for purchase

            // Clear price fields
            document.getElementById('priceLink').value = '';
            document.getElementById('priceArticle').value = '';

            // Enable API key input for new sites
            document.getElementById('apiKey').removeAttribute('readonly');

            toggleSiteTypeFields(); // Initialize field visibility
            modal.show();
        }

        function editSite(id) {
            const site = sites.find(s => s.id === id);
            if (!site) return;

            document.getElementById('modalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.site_name;
            document.getElementById('siteUrl').value = site.site_url;
            document.getElementById('apiKey').value = site.api_key || '';
            document.getElementById('maxLinks').value = site.max_links || 10;
            document.getElementById('maxArticles').value = site.max_articles || 10;

            // Set allow_articles checkbox (default to true if not set)
            document.getElementById('allowArticles').checked = site.allow_articles !== false;

            // Set is_public checkbox (default to false if not set)
            document.getElementById('isPublic').checked = site.is_public === true;

            // Set available_for_purchase checkbox (default to true if not set)
            document.getElementById('availableForPurchase').checked = site.available_for_purchase !== false;

            // Populate price fields (show empty if NULL/default)
            document.getElementById('priceLink').value = site.price_link !== null && site.price_link !== undefined ? site.price_link : '';
            document.getElementById('priceArticle').value = site.price_article !== null && site.price_article !== undefined ? site.price_article : '';

            // Make API key readonly when editing
            document.getElementById('apiKey').setAttribute('readonly', 'readonly');

            // Set site type (default to wordpress if not set)
            const siteType = site.site_type || 'wordpress';
            if (siteType === 'static_php') {
                document.getElementById('siteTypeStatic').checked = true;
            } else {
                document.getElementById('siteTypeWordPress').checked = true;
            }
            toggleSiteTypeFields(); // Update field visibility

            modal.show();
        }

        async function saveSite() {
            const id = document.getElementById('siteId').value;
            const siteType = document.querySelector('input[name="siteType"]:checked').value;

            const data = {
                site_name: document.getElementById('siteName').value,
                site_url: document.getElementById('siteUrl').value,
                site_type: siteType,
                max_links: parseInt(document.getElementById('maxLinks').value),
                max_articles: parseInt(document.getElementById('maxArticles').value)
            };

            // Only include API key and allow_articles for WordPress sites
            if (siteType === 'wordpress') {
                data.api_key = document.getElementById('apiKey').value;
                data.allow_articles = document.getElementById('allowArticles').checked;
            } else {
                // Static sites always have allow_articles = false
                data.allow_articles = false;
            }

            // Add is_public checkbox value (applies to all site types)
            data.is_public = document.getElementById('isPublic').checked;

            // Add available_for_purchase checkbox value (applies to all site types)
            data.available_for_purchase = document.getElementById('availableForPurchase').checked;

            // Add price fields (optional - null if empty)
            const priceLinkValue = document.getElementById('priceLink').value.trim();
            const priceArticleValue = document.getElementById('priceArticle').value.trim();

            data.price_link = priceLinkValue !== '' ? parseFloat(priceLinkValue) : null;
            data.price_article = priceArticleValue !== '' ? parseFloat(priceArticleValue) : null;

            // Validate prices are positive if provided
            if (data.price_link !== null && data.price_link < 0) {
                showNotification('Цена за ссылку должна быть положительным числом', 'error');
                return;
            }

            if (data.price_article !== null && data.price_article < 0) {
                showNotification('Цена за гест-пост должна быть положительным числом', 'error');
                return;
            }

            try {
                if (id) {
                    await SitesAPI.update(id, data);
                    showNotification('Site updated successfully');
                } else {
                    await SitesAPI.create(data);
                    showNotification('Site created successfully');
                }
                modal.hide();
                await loadSites();
            } catch (error) {
                showNotification('Failed to save site: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            try {
                // Get placements for this site to show warning
                const response = await PlacementsAPI.getBySite(id);
                const { placements, summary } = response;

                // Build confirmation message
                let message = 'Вы уверены, что хотите удалить этот сайт?';

                if (summary.total > 0) {
                    message = `⚠️ ВНИМАНИЕ: На этом сайте есть ${summary.total} размещени${summary.total === 1 ? 'е' : summary.total < 5 ? 'я' : 'й'}!\n\n`;

                    if (summary.paidCount > 0) {
                        message += `💰 Платных размещений: ${summary.paidCount}\n`;
                        message += `💵 Общая стоимость: $${summary.totalRefund.toFixed(2)}\n\n`;
                        message += `✅ Все размещения будут удалены\n`;
                        message += `✅ Деньги ($${summary.totalRefund.toFixed(2)}) будут возвращены на ваш баланс\n`;
                        message += `✅ Использование ссылок/гест-постов будет восстановлено\n\n`;
                    } else {
                        message += `Все размещения (бесплатные) будут удалены.\n\n`;
                    }

                    message += `Вы уверены, что хотите продолжить?`;
                }

                if (!confirm(message)) return;

                // Delete site with refunds
                const result = await SitesAPI.delete(id);

                // Show success message with refund details
                if (result.refundedCount > 0) {
                    showNotification(
                        `Сайт удалён успешно! Возвращено: $${result.totalRefunded.toFixed(2)} (${result.refundedCount} размещени${result.refundedCount === 1 ? 'е' : result.refundedCount < 5 ? 'я' : 'й'})`,
                        'success'
                    );

                    if (result.tierChanged) {
                        showNotification(
                            `Ваш уровень скидки изменился на "${result.newTier}" из-за уменьшения общих затрат.`,
                            'info'
                        );
                    }
                } else {
                    showNotification('Сайт удалён успешно', 'success');
                }

                await loadSites();
            } catch (error) {
                showNotification('Ошибка при удалении сайта: ' + error.message, 'error');
            }
        }

        function copyApiKey(apiKey, event) {
            event.stopPropagation(); // Prevent card click
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API Key copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy API Key', 'error');
            });
        }

        function copyFieldToClipboard(fieldId) {
            const field = document.getElementById(fieldId);
            const text = field.value;
            if (!text) {
                showNotification('Nothing to copy', 'warning');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        // Bulk Registration Token Functions
        async function generateRegistrationToken() {
            try {
                const label = document.getElementById('tokenLabel').value || 'Registration Token';
                const maxUses = parseInt(document.getElementById('tokenMaxUses').value) || 0;
                const expireDays = parseInt(document.getElementById('tokenExpireDays').value) || 30;

                // Calculate expiry date
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + expireDays);

                const response = await fetch('/api/sites/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        label,
                        max_uses: maxUses,
                        expires_at: expiresAt.toISOString()
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate token');
                }

                const data = await response.json();

                // Clear form
                document.getElementById('tokenLabel').value = '';
                document.getElementById('tokenMaxUses').value = '0';
                document.getElementById('tokenExpireDays').value = '30';

                // Reload tokens list
                await loadActiveTokens();

                showNotification('Токен регистрации создан!', 'success');
            } catch (error) {
                console.error('Generate token error:', error);
                showNotification('Ошибка создания токена: ' + error.message, 'error');
            }
        }

        async function loadActiveTokens() {
            try {
                const response = await fetch('/api/sites/tokens', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load tokens');
                }

                const data = await response.json();
                displayTokensList(data.data || []);
            } catch (error) {
                console.error('Load tokens error:', error);
                document.getElementById('activeTokensList').innerHTML =
                    '<div class="alert alert-light mb-0"><small class="text-dark">Не удалось загрузить токены</small></div>';
            }
        }

        function displayTokensList(tokens) {
            const container = document.getElementById('activeTokensList');

            if (tokens.length === 0) {
                container.innerHTML = '';
                return;
            }

            const now = new Date();
            const activeTokens = tokens.filter(token => {
                const isExpired = token.expires_at && new Date(token.expires_at) < now;
                const isExhausted = token.max_uses > 0 && token.current_uses >= token.max_uses;
                return !isExpired && !isExhausted;
            });

            if (activeTokens.length === 0) {
                container.innerHTML = '<div class="alert alert-light mb-0"><small class="text-dark">Нет активных токенов</small></div>';
                return;
            }

            const html = activeTokens.map(token => {
                const maxUsesText = token.max_uses === 0 ? '∞' : token.max_uses;
                const expiryDate = token.expires_at ? new Date(token.expires_at).toLocaleDateString('ru-RU') : 'Без срока';
                const usagePercent = token.max_uses > 0 ? (token.current_uses / token.max_uses * 100) : 0;
                const usageColor = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : 'success';

                return `
                    <div class="alert alert-light mb-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-dark">${escapeHtml(token.label)}</strong>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-calendar"></i> До: ${expiryDate}
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-bar-chart"></i> Использовано: ${token.current_uses} / ${maxUsesText}
                                </div>
                                ${token.max_uses > 0 ? `
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-${usageColor}" role="progressbar"
                                         style="width: ${usagePercent}%"
                                         aria-valuenow="${token.current_uses}"
                                         aria-valuemin="0"
                                         aria-valuemax="${token.max_uses}"></div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace bg-white text-dark"
                                   value="${token.token}" readonly>
                            <button class="btn btn-dark" onclick="copyTokenToClipboard('${token.token}')">
                                <i class="bi bi-clipboard"></i> Копировать
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteRegistrationToken(${token.id})" title="Удалить токен">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mt-2 small text-dark">
                            <i class="bi bi-info-circle"></i> Вставьте этот токен в настройках плагина Link Manager на ваших WordPress сайтах
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function copyTokenToClipboard(token) {
            navigator.clipboard.writeText(token).then(() => {
                showNotification('Токен скопирован в буфер обмена!', 'success');
            }).catch(err => {
                console.error('Failed to copy token:', err);
                showNotification('Ошибка копирования токена', 'error');
            });
        }

        async function deleteRegistrationToken(tokenId) {
            if (!confirm('Удалить этот токен? Сайты, уже зарегистрированные с этим токеном, останутся в системе.')) {
                return;
            }

            try {
                const response = await fetch(`/api/sites/tokens/${tokenId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete token');
                }

                await loadActiveTokens();
                showNotification('Токен удалён', 'success');
            } catch (error) {
                console.error('Delete token error:', error);
                showNotification('Ошибка удаления: ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // ========== Export Functions ==========

        function showExportModal() {
            updateExportPreview();
            exportModal.show();
        }

        function updateExportPreview() {
            const format = document.getElementById('exportFormat').value;
            const preview = document.getElementById('exportPreview');
            const count = document.getElementById('exportCount');

            let content = '';

            switch(format) {
                case 'csv':
                    content = generateCSV();
                    break;
                case 'tsv':
                    content = generateTSV();
                    break;
                case 'plain':
                    content = generatePlainText();
                    break;
                case 'json':
                    content = generateJSON();
                    break;
            }

            preview.value = content;
            count.textContent = sites.length;
        }

        function generateCSV() {
            const headers = ['Site Name', 'Site URL', 'DR', 'DA', 'TF', 'CF', 'RD', 'RDm', 'Norm', 'KW', 'Traffic', 'GEO', 'Type', 'API Key', 'Links', 'Articles', 'Allow Articles', 'Public', 'Available'];
            const rows = sites.map(s => [
                `"${(s.site_name || '').replace(/"/g, '""')}"`,
                `"${(s.site_url || '').replace(/"/g, '""')}"`,
                s.dr || 0,
                s.da || 0,
                s.tf || 0,
                s.cf || 0,
                s.ref_domains || 0,
                s.rd_main || 0,
                s.norm || 0,
                s.keywords || 0,
                s.traffic || 0,
                s.geo || 'EN',
                s.site_type || 'wordpress',
                s.api_key ? `"${s.api_key.substring(0, 8)}..."` : 'N/A',
                `${s.used_links || 0}/${s.max_links || 0}`,
                `${s.used_articles || 0}/${s.max_articles || 0}`,
                s.allow_articles !== false ? 'Yes' : 'No',
                s.is_public === true ? 'Yes' : 'No',
                s.available_for_purchase !== false ? 'Yes' : 'No'
            ]);

            return [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        }

        function generateTSV() {
            const headers = ['Site Name', 'Site URL', 'DR', 'DA', 'TF', 'CF', 'RD', 'RDm', 'Norm', 'KW', 'Traffic', 'GEO', 'Type', 'API Key', 'Links', 'Articles', 'Allow Articles', 'Public', 'Available'];
            const rows = sites.map(s => [
                s.site_name || '',
                s.site_url || '',
                s.dr || 0,
                s.da || 0,
                s.tf || 0,
                s.cf || 0,
                s.ref_domains || 0,
                s.rd_main || 0,
                s.norm || 0,
                s.keywords || 0,
                s.traffic || 0,
                s.geo || 'EN',
                s.site_type || 'wordpress',
                s.api_key ? `${s.api_key.substring(0, 8)}...` : 'N/A',
                `${s.used_links || 0}/${s.max_links || 0}`,
                `${s.used_articles || 0}/${s.max_articles || 0}`,
                s.allow_articles !== false ? 'Yes' : 'No',
                s.is_public === true ? 'Yes' : 'No',
                s.available_for_purchase !== false ? 'Yes' : 'No'
            ]);

            return [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
        }

        function generatePlainText() {
            return sites.map((s, index) => {
                return `Site #${index + 1}
Name: ${s.site_name || 'N/A'}
URL: ${s.site_url || 'N/A'}
DR: ${s.dr || 0}
DA: ${s.da || 0}
TF: ${s.tf || 0}
CF: ${s.cf || 0}
Ref Domains: ${s.ref_domains || 0}
RD Main: ${s.rd_main || 0}
Norm: ${s.norm || 0}
Keywords: ${s.keywords || 0}
Traffic: ${s.traffic || 0}
GEO: ${s.geo || 'EN'}
Type: ${s.site_type || 'wordpress'}
API Key: ${s.api_key ? `${s.api_key.substring(0, 8)}...` : 'N/A'}
Links: ${s.used_links || 0}/${s.max_links || 0}
Articles: ${s.used_articles || 0}/${s.max_articles || 0}
Allow Articles: ${s.allow_articles !== false ? 'Yes' : 'No'}
Public: ${s.is_public === true ? 'Yes' : 'No'}
Available for Purchase: ${s.available_for_purchase !== false ? 'Yes' : 'No'}
${'='.repeat(50)}`;
            }).join('\n');
        }

        function generateJSON() {
            // Export only essential fields for readability
            const exportData = sites.map(s => ({
                site_name: s.site_name,
                site_url: s.site_url,
                dr: s.dr || 0,
                da: s.da || 0,
                tf: s.tf || 0,
                cf: s.cf || 0,
                ref_domains: s.ref_domains || 0,
                rd_main: s.rd_main || 0,
                norm: s.norm || 0,
                keywords: s.keywords || 0,
                traffic: s.traffic || 0,
                geo: s.geo || 'EN',
                site_type: s.site_type || 'wordpress',
                api_key: s.api_key ? `${s.api_key.substring(0, 8)}...` : null,
                links_usage: `${s.used_links || 0}/${s.max_links || 0}`,
                articles_usage: `${s.used_articles || 0}/${s.max_articles || 0}`,
                allow_articles: s.allow_articles !== false,
                is_public: s.is_public === true,
                available_for_purchase: s.available_for_purchase !== false
            }));

            return JSON.stringify(exportData, null, 2);
        }

        function copyExportToClipboard() {
            const content = document.getElementById('exportPreview').value;
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Exported data copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function downloadExport() {
            const format = document.getElementById('exportFormat').value;
            const content = document.getElementById('exportPreview').value;
            const date = new Date().toISOString().split('T')[0];
            const filename = `sites-export-${date}.${format}`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`File "${filename}" downloaded successfully!`, 'success');
        }

        // ========== Bulk Selection & Toggle Functions ==========

        // Состояние выбора
        let selectedSiteIds = new Set();

        // Toggle одного поля сайта
        async function toggleSiteField(siteId, field, value) {
            try {
                const data = {};
                data[field] = value;

                await SitesAPI.update(siteId, data);

                // Обновляем локальные данные
                const site = sites.find(s => s.id === siteId);
                if (site) site[field] = value;

                // Обновляем цвет строки
                updateRowStyle(siteId);

                const fieldNames = {
                    'allow_articles': 'Статьи',
                    'is_public': 'Публичность',
                    'available_for_purchase': 'Доступность'
                };
                showNotification(`${fieldNames[field]} ${value ? 'включено' : 'отключено'}`, 'success');
            } catch (error) {
                // Откатываем переключатель
                const fieldId = field === 'allow_articles' ? 'allowArticles' :
                               field === 'is_public' ? 'isPublic' : 'available';
                const checkbox = document.getElementById(`${fieldId}_${siteId}`);
                if (checkbox) checkbox.checked = !value;
                showNotification('Ошибка обновления: ' + error.message, 'error');
            }
        }

        // Обновить стиль строки на основе данных
        function updateRowStyle(siteId) {
            const site = sites.find(s => s.id === siteId);
            if (!site) return;

            const row = document.querySelector(`tr[data-site-id="${siteId}"]`);
            if (!row) return;

            row.classList.remove('table-danger', 'table-success');
            if (site.available_for_purchase === false) {
                row.classList.add('table-danger');
            } else if (site.is_public === true) {
                row.classList.add('table-success');
            }
        }

        // Выбрать/снять выбор со всех
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllSites');
            const checkboxes = document.querySelectorAll('.site-checkbox');

            selectedSiteIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedSiteIds.add(parseInt(cb.dataset.siteId));
                }
            });

            updateBulkActionsBar();
        }

        // Обновить состояние выбора
        function updateBulkSelection() {
            selectedSiteIds.clear();
            document.querySelectorAll('.site-checkbox:checked').forEach(cb => {
                selectedSiteIds.add(parseInt(cb.dataset.siteId));
            });

            // Обновить "Select All" чекбокс
            const allCheckboxes = document.querySelectorAll('.site-checkbox');
            const selectAll = document.getElementById('selectAllSites');
            selectAll.checked = allCheckboxes.length > 0 &&
                                selectedSiteIds.size === allCheckboxes.length;
            selectAll.indeterminate = selectedSiteIds.size > 0 &&
                                      selectedSiteIds.size < allCheckboxes.length;

            updateBulkActionsBar();
        }

        // Показать/скрыть панель массового редактирования
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('selectedCount');

            if (selectedSiteIds.size > 0) {
                bar.classList.remove('d-none');
                count.textContent = selectedSiteIds.size;
            } else {
                bar.classList.add('d-none');
            }
        }

        // Массовое изменение поля
        async function bulkSetField(field, value) {
            if (selectedSiteIds.size === 0) return;

            const fieldNames = {
                'allow_articles': 'Разрешить гест-посты',
                'is_public': 'Публичный',
                'available_for_purchase': 'Доступен для покупки'
            };

            if (!confirm(`Изменить "${fieldNames[field]}" на "${value ? 'Да' : 'Нет'}" для ${selectedSiteIds.size} сайтов?`)) {
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;

                for (const siteId of selectedSiteIds) {
                    try {
                        const data = {};
                        data[field] = value;
                        await SitesAPI.update(siteId, data);

                        // Обновляем локальные данные
                        const site = sites.find(s => s.id === siteId);
                        if (site) site[field] = value;

                        successCount++;
                    } catch (e) {
                        errorCount++;
                    }
                }

                // Перерисовываем таблицу
                displaySites();
                clearBulkSelection();

                if (errorCount === 0) {
                    showNotification(`Обновлено ${successCount} сайтов`, 'success');
                } else {
                    showNotification(`Обновлено ${successCount}, ошибок: ${errorCount}`, 'warning');
                }
            } catch (error) {
                showNotification('Ошибка массового обновления: ' + error.message, 'error');
            }
        }

        // Очистить выбор
        function clearBulkSelection() {
            selectedSiteIds.clear();
            document.querySelectorAll('.site-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllSites').checked = false;
            document.getElementById('selectAllSites').indeterminate = false;
            updateBulkActionsBar();
        }

        // ===== INLINE PRICE EDITING =====

        function enablePriceEdit(cell, siteId, field) {
            // Prevent multiple edits
            if (cell.classList.contains('editing')) {
                return;
            }

            // Get current value from sites array
            const site = sites.find(s => s.id === siteId);
            const currentValue = site ? site[field] : null;

            cell.classList.add('editing');

            // Hide display, create input
            const display = cell.querySelector('.price-display');
            display.classList.add('d-none');

            // Create input element
            const input = document.createElement('input');
            input.type = 'number';
            input.className = 'form-control form-control-sm price-input';
            input.min = '0';
            input.step = '0.01';
            input.value = currentValue || '';
            input.placeholder = cell.dataset.default;

            // Event handlers
            input.onblur = () => savePriceEdit(cell, siteId, field);
            input.onkeydown = (e) => handlePriceKeydown(e, cell, siteId, field);

            // Insert and focus
            cell.appendChild(input);
            input.focus();
            input.select();
        }

        async function savePriceEdit(cell, siteId, field) {
            const input = cell.querySelector('.price-input');
            if (!input) return;

            const value = input.value.trim();
            const numericValue = value === '' ? null : parseFloat(value);

            // Validation
            if (numericValue !== null && (isNaN(numericValue) || numericValue < 0)) {
                showNotification('Цена должна быть положительным числом', 'error');
                input.focus();
                return;
            }

            // Show saving state
            cell.classList.add('saving');

            try {
                // API call
                const data = {};
                data[field] = numericValue;
                await SitesAPI.update(siteId, data);

                // Update local data
                const site = sites.find(s => s.id === siteId);
                if (site) site[field] = numericValue;

                // Re-render cell
                const defaultValue = field === 'price_link' ? 25 : 15;
                const display = cell.querySelector('.price-display');
                if (numericValue !== null) {
                    display.innerHTML = `<span class="text-success">${numericValue.toFixed(2)}</span>`;
                } else {
                    display.innerHTML = `<span class="text-muted">$${defaultValue}</span>`;
                }

                showNotification('Цена обновлена', 'success');
            } catch (error) {
                showNotification('Ошибка: ' + error.message, 'error');
            } finally {
                // Cleanup
                input.remove();
                cell.querySelector('.price-display').classList.remove('d-none');
                cell.classList.remove('editing', 'saving');
            }
        }

        function handlePriceKeydown(event, cell, siteId, field) {
            if (event.key === 'Enter') {
                event.preventDefault();
                savePriceEdit(cell, siteId, field);
            } else if (event.key === 'Escape') {
                // Cancel edit
                const input = cell.querySelector('.price-input');
                if (input) input.remove();
                cell.querySelector('.price-display').classList.remove('d-none');
                cell.classList.remove('editing');
            }
        }

        // ===== BULK PRICE UPDATES =====

        let currentBulkField = null;

        function showBulkPriceModal(field) {
            currentBulkField = field;

            const count = selectedSiteIds.size;
            if (count === 0) {
                showNotification('Выберите сайты для изменения', 'warning');
                return;
            }

            // Set modal content
            const fieldName = field === 'price_link' ? 'цену за ссылку (Main)' : 'цену за гест-пост (GP)';
            document.getElementById('bulkPriceFieldName').textContent = fieldName;
            document.getElementById('bulkPriceCount').textContent = count;
            document.getElementById('bulkPriceValue').value = '';

            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('bulkPriceModal'));
            modal.show();
        }

        async function applyBulkPrice() {
            const value = document.getElementById('bulkPriceValue').value.trim();
            const numericValue = value === '' ? null : parseFloat(value);

            // Validation
            if (numericValue !== null && (isNaN(numericValue) || numericValue < 0)) {
                showNotification('Цена должна быть положительным числом', 'error');
                return;
            }

            const count = selectedSiteIds.size;
            const fieldName = currentBulkField === 'price_link' ? 'ссылку' : 'гест-пост';
            const priceText = numericValue !== null ? `$${numericValue.toFixed(2)}` : 'дефолтную';

            // Confirmation
            if (!confirm(`Изменить цену за ${fieldName} для ${count} сайтов на ${priceText}?`)) {
                return;
            }

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('bulkPriceModal')).hide();

            // Process in chunks of 10
            const siteIds = Array.from(selectedSiteIds);
            const CHUNK_SIZE = 10;
            let successful = 0;
            let failed = 0;

            for (let i = 0; i < siteIds.length; i += CHUNK_SIZE) {
                const chunk = siteIds.slice(i, i + CHUNK_SIZE);
                const data = {};
                data[currentBulkField] = numericValue;

                const results = await Promise.allSettled(
                    chunk.map(siteId => SitesAPI.update(siteId, data))
                );

                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled') {
                        successful++;
                        const site = sites.find(s => s.id === chunk[idx]);
                        if (site) site[currentBulkField] = numericValue;
                    } else {
                        failed++;
                    }
                });

                // Show progress
                showNotification(`Обновлено ${successful} из ${siteIds.length}...`, 'info');
            }

            // Final notification
            if (failed === 0) {
                showNotification(`✅ Цены обновлены для всех ${successful} сайтов`, 'success');
            } else {
                showNotification(`⚠️ Обновлено: ${successful}, ошибок: ${failed}`, 'warning');
            }

            // Reload and clear
            await loadSites();
            clearBulkSelection();
        }
    </script>

    <!-- Bulk Price Update Modal -->
    <div class="modal fade" id="bulkPriceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Массовое изменение цены</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Изменить <strong id="bulkPriceFieldName"></strong> для <strong id="bulkPriceCount"></strong> выбранных сайтов</p>

                    <div class="mb-3">
                        <label for="bulkPriceValue" class="form-label">Новая цена (USD)</label>
                        <input type="number"
                               class="form-control"
                               id="bulkPriceValue"
                               min="0"
                               step="0.01"
                               placeholder="Введите цену или оставьте пустым для сброса">
                        <small class="text-muted">Пустое значение = использовать дефолтную цену</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Изменение будет применено ко всем выбранным сайтам
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="applyBulkPriceBtn">Применить</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
