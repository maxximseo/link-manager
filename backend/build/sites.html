<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <!-- Navbar Container (injected by navbar.js) -->
    <div id="navbar-container"></div>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Sites</h1>
            <button class="btn btn-primary" onclick="showCreateModal()">
                <i class="bi bi-plus-circle"></i> Add Site
            </button>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" placeholder="Search sites...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div id="sitesList" class="row"></div>

        <!-- Bulk Registration Section -->
        <div class="card mt-5 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-cloud-arrow-down"></i> –ú–∞—Å—Å–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è WordPress —Å–∞–π—Ç–æ–≤
                </h5>
                <p class="small mb-3 opacity-75">
                    –°–≥–µ–Ω–µ—Ä–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –∏ –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –µ–≥–æ –Ω–∞ –º–Ω–æ–∂–µ—Å—Ç–≤–µ WordPress —Å–∞–π—Ç–æ–≤ —Å –ø–ª–∞–≥–∏–Ω–æ–º Link Manager –¥–ª—è –±—ã—Å—Ç—Ä–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –≤ —Å–∏—Å—Ç–µ–º—É.
                </p>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–∫–µ–Ω–∞</label>
                        <input type="text" class="form-control" id="tokenLabel" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –Ø–Ω–≤–∞—Ä—å 2025">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">–ú–∞–∫—Å. –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–π</label>
                        <input type="number" class="form-control" id="tokenMaxUses" value="0" min="0" placeholder="0 = –±–µ–∑–ª–∏–º–∏—Ç">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small">–°—Ä–æ–∫ –¥–µ–π—Å—Ç–≤–∏—è (–¥–Ω–µ–π)</label>
                        <input type="number" class="form-control" id="tokenExpireDays" value="30" min="1" placeholder="30">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">&nbsp;</label>
                        <button class="btn btn-light w-100" onclick="generateRegistrationToken()">
                            <i class="bi bi-key"></i> –°–æ–∑–¥–∞—Ç—å
                        </button>
                    </div>
                </div>

                <div id="tokenDisplay" style="display:none;" class="mt-3">
                    <div class="alert alert-light mb-0">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div class="flex-grow-1">
                                <strong class="text-dark">–¢–æ–∫–µ–Ω —Å–æ–∑–¥–∞–Ω!</strong>
                                <div class="small text-muted" id="tokenInfo"></div>
                            </div>
                            <button class="btn btn-sm btn-outline-dark" onclick="hideToken()">
                                <i class="bi bi-x"></i>
                            </button>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace bg-white text-dark" id="generatedToken" readonly>
                            <button class="btn btn-dark" onclick="copyToken()">
                                <i class="bi bi-clipboard"></i> –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å
                            </button>
                        </div>
                        <div class="mt-2 small text-dark">
                            <i class="bi bi-info-circle"></i> –í—Å—Ç–∞–≤—å—Ç–µ —ç—Ç–æ—Ç —Ç–æ–∫–µ–Ω –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö –ø–ª–∞–≥–∏–Ω–∞ Link Manager –Ω–∞ –≤–∞—à–∏—Ö WordPress —Å–∞–π—Ç–∞—Ö
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal fade" id="siteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Site</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="siteForm">
                        <input type="hidden" id="siteId">

                        <!-- Site Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">–¢–∏–ø —Å–∞–π—Ç–∞ *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="siteType" id="siteTypeWordPress" value="wordpress" checked onchange="toggleSiteTypeFields()">
                                <label class="btn btn-outline-primary" for="siteTypeWordPress">
                                    <i class="bi bi-wordpress"></i> WordPress
                                </label>

                                <input type="radio" class="btn-check" name="siteType" id="siteTypeStatic" value="static_php" onchange="toggleSiteTypeFields()">
                                <label class="btn btn-outline-success" for="siteTypeStatic">
                                    <i class="bi bi-filetype-php"></i> –°—Ç–∞—Ç–∏—á–Ω—ã–π PHP
                                </label>
                            </div>
                            <small class="form-text text-muted d-block mt-1">
                                <span id="typeHintWordPress">WordPress —Å —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—ã–º –ø–ª–∞–≥–∏–Ω–æ–º Link Manager</span>
                                <span id="typeHintStatic" style="display:none">–°—Ç–∞—Ç–∏—á–Ω—ã–π —Å–∞–π—Ç —Å PHP –≤–∏–¥–∂–µ—Ç–æ–º (—Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏)</span>
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="siteName" class="form-label">Site Name *</label>
                            <input type="text" class="form-control" id="siteName" required>
                        </div>

                        <div class="mb-3">
                            <label for="siteUrl" class="form-label">Site URL *</label>
                            <input type="url" class="form-control" id="siteUrl" required
                                   placeholder="https://example.com">
                        </div>

                        <!-- API Key field (shown for WordPress, auto-generated for static) -->
                        <div id="apiKeyField" class="mb-3">
                            <label for="apiKey" class="form-label">
                                API Token
                                <span id="apiKeyRequired">*</span>
                                <span id="apiKeyAutoNote" style="display:none;" class="badge bg-success ms-2">Auto-generated</span>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="apiKey"
                                       placeholder="–ü–æ–ª—É—á–∏—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –ø–ª–∞–≥–∏–Ω–∞ –Ω–∞ –≤–∞—à–µ–º WordPress —Å–∞–π—Ç–µ">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyFieldToClipboard('apiKey')" id="copyApiKeyBtn">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                            <small class="form-text text-muted" id="apiKeyHint">
                                <i class="bi bi-info-circle"></i> <span id="apiKeyHintText">–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω Link Manager –Ω–∞ WordPress –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫</span>
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxLinks" class="form-label">Max Links *</label>
                                <input type="number" class="form-control" id="maxLinks" required min="0" value="10">
                            </div>
                            <div class="col-md-6 mb-3" id="maxArticlesField">
                                <label for="maxArticles" class="form-label">Max Articles *</label>
                                <input type="number" class="form-control" id="maxArticles" required min="0" value="10">
                            </div>
                        </div>

                        <!-- Allow Articles checkbox (WordPress only) -->
                        <div class="mb-3" id="allowArticlesField">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="allowArticles" checked>
                                <label class="form-check-label" for="allowArticles">
                                    <i class="bi bi-file-text"></i> –†–∞–∑—Ä–µ—à–∏—Ç—å —Ä–∞–∑–º–µ—â–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π
                                </label>
                            </div>
                            <small class="text-muted">
                                –°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É, —á—Ç–æ–±—ã –∑–∞–ø—Ä–µ—Ç–∏—Ç—å –ø–æ–∫—É–ø–∫—É —Å—Ç–∞—Ç–µ–π –Ω–∞ —ç—Ç–æ–º —Å–∞–π—Ç–µ (—Å—Å—ã–ª–∫–∏ –±—É–¥—É—Ç –¥–æ—Å—Ç—É–ø–Ω—ã)
                            </small>
                        </div>

                        <!-- Public Availability -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="isPublic">
                                <label class="form-check-label" for="isPublic">
                                    <i class="bi bi-globe"></i> –†–∞–∑—Ä–µ—à–∏—Ç—å –ø—É–±–ª–∏—á–Ω—ã–µ –ø–æ–∫—É–ø–∫–∏
                                </label>
                            </div>
                            <small class="text-muted">
                                –í–∫–ª—é—á–∏—Ç–µ, —á—Ç–æ–±—ã –¥—Ä—É–≥–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –º–æ–≥–ª–∏ —Ä–∞–∑–º–µ—â–∞—Ç—å –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–∞ –≤–∞—à–µ–º —Å–∞–π—Ç–µ. –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ç–æ–ª—å–∫–æ –≤—ã –º–æ–∂–µ—Ç–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–≤–æ–π —Å–∞–π—Ç.
                            </small>
                        </div>

                        <!-- Available for Purchase -->
                        <div class="mb-3">
                            <div class="form-check">
                                <input type="checkbox" class="form-check-input" id="availableForPurchase" checked>
                                <label class="form-check-label" for="availableForPurchase">
                                    <i class="bi bi-cart-check"></i> –î–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –ø–æ–∫—É–ø–∫–∏
                                </label>
                            </div>
                            <small class="text-muted">
                                –°–Ω–∏–º–∏—Ç–µ –≥–∞–ª–æ—á–∫—É, —á—Ç–æ–±—ã –≤—Ä–µ–º–µ–Ω–Ω–æ –∑–∞–∫—Ä—ã—Ç—å —Å–∞–π—Ç –¥–ª—è –Ω–æ–≤—ã—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π. –°—Ç–∞—Ä—ã–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –æ—Å—Ç–∞–Ω—É—Ç—Å—è –∞–∫—Ç–∏–≤–Ω—ã–º–∏.
                            </small>
                        </div>

                        <!-- WordPress Plugin Info -->
                        <div class="alert alert-info" id="wordpressPluginInfo">
                            <h6><i class="bi bi-wordpress"></i> WordPress Plugin Required</h6>
                            <p class="mb-2">To enable link placement, install the Link Manager plugin on your WordPress site:</p>
                            <a href="/link-manager-widget.zip" download="link-manager-widget.zip" class="btn btn-sm btn-success">
                                <i class="bi bi-download"></i> Download Plugin (ZIP)
                            </a>
                            <small class="d-block mt-2 text-muted">Upload and activate this plugin in your WordPress admin panel</small>
                        </div>

                        <!-- Static PHP Widget Info -->
                        <div class="alert alert-success" id="staticWidgetInfo" style="display:none">
                            <h6><i class="bi bi-filetype-php"></i> PHP Widget –¥–ª—è —Å—Ç–∞—Ç–∏—á–Ω—ã—Ö —Å–∞–π—Ç–æ–≤</h6>
                            <p class="mb-2">–°–∫–∞—á–∞–π—Ç–µ –≤–∏–¥–∂–µ—Ç –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –Ω–∞ –≤–∞—à PHP —Å–∞–π—Ç:</p>
                            <div class="d-grid gap-2">
                                <a href="/static.php" download="static.php" class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> –°–∫–∞—á–∞—Ç—å static.php
                                </a>
                            </div>
                            <small class="d-block mt-2">
                                <strong>3 –ø—Ä–æ—Å—Ç—ã—Ö —à–∞–≥–∞:</strong><br>
                                1. –û—Ç–∫—Ä–æ–π—Ç–µ <code>static.php</code> –≤ —Ä–µ–¥–∞–∫—Ç–æ—Ä–µ –∏ –∑–∞–º–µ–Ω–∏—Ç–µ <code>YOUR_API_KEY_HERE</code> –Ω–∞ –≤–∞—à API –∫–ª—é—á<br>
                                2. –ó–∞–≥—Ä—É–∑–∏—Ç–µ —Ñ–∞–π–ª –≤ –∫–æ—Ä–µ–Ω—å —Å–∞–π—Ç–∞<br>
                                3. –î–æ–±–∞–≤—å—Ç–µ <code>&lt;?php include 'static.php'; ?&gt;</code> –≥–¥–µ –Ω—É–∂–Ω–æ –æ—Ç–æ–±—Ä–∞–∑–∏—Ç—å —Å—Å—ã–ª–∫–∏
                            </small>
                            <div class="alert alert-warning mt-2 mb-0">
                                <small><i class="bi bi-exclamation-triangle"></i> <strong>–í–∞–∂–Ω–æ:</strong> –°—Ç–∞—Ç–∏—á–Ω—ã–µ —Å–∞–π—Ç—ã –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç —Ç–æ–ª—å–∫–æ —Å—Å—ã–ª–∫–∏, —Å—Ç–∞—Ç—å–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSite()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/navbar-config.js"></script>
    <script src="/js/navbar.js"></script>
    <script>
        // Initialize navbar
        initNavbar('user', 'sites');

        if (!isAuthenticated()) {
            window.location.href = '/index.html';
        }

        let sites = [];
        let modal;

        document.addEventListener('DOMContentLoaded', async () => {
            modal = new bootstrap.Modal(document.getElementById('siteModal'));
            await loadSites();

            document.getElementById('searchInput').addEventListener('input', displaySites);
            document.getElementById('statusFilter').addEventListener('change', displaySites);
        });

        async function loadSites() {
            try {
                sites = await SitesAPI.getAll();
                displaySites();
            } catch (error) {
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function displaySites() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = sites.filter(s => {
                const matchesSearch = s.site_name.toLowerCase().includes(search) ||
                                     s.site_url.toLowerCase().includes(search);
                const matchesStatus = !statusFilter || s.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            const list = document.getElementById('sitesList');
            list.innerHTML = filtered.map(s => {
                const siteType = s.site_type || 'wordpress';
                const typeIcon = siteType === 'wordpress' ? 'bi-wordpress' : 'bi-filetype-php';
                const typeBadge = siteType === 'wordpress'
                    ? '<span class="badge bg-primary"><i class="bi bi-wordpress"></i> WordPress</span>'
                    : '<span class="badge bg-success"><i class="bi bi-filetype-php"></i> Static PHP</span>';

                // Highlight sites based on status:
                // - Red background: unavailable for purchase
                // - Green background: public (available to all users)
                // - White background: private (default)
                let cardStyle = '';
                if (s.available_for_purchase === false) {
                    cardStyle = 'style="background-color: rgba(220, 38, 38, 0.08); border-color: rgba(220, 38, 38, 0.3);"';
                } else if (s.is_public === true) {
                    cardStyle = 'style="background-color: rgba(34, 197, 94, 0.08); border-color: rgba(34, 197, 94, 0.3);"';
                }

                return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100" ${cardStyle}>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${escapeHtml(s.site_name)}</h5>
                                ${typeBadge}
                            </div>
                            <p class="card-text">
                                <a href="${escapeHtml(s.site_url)}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-globe"></i> ${escapeHtml(s.site_url)}
                                </a>
                            </p>
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-link-45deg"></i> Links: ${s.used_links || 0}/${s.max_links || 0}
                                </small>
                            </div>
                            ${siteType === 'wordpress' ? `
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-file-text"></i> Articles: ${s.used_articles || 0}/${s.max_articles || 0}
                                </small>
                            </div>
                            ` : ''}
                            ${s.api_key ? `
                            <div class="mb-2">
                                <small class="text-muted d-flex align-items-center gap-1">
                                    <i class="bi bi-key"></i>
                                    <span class="font-monospace" style="font-size: 0.75rem;">${s.api_key.substring(0, 20)}...</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size: 0.7rem; line-height: 1;"
                                            onclick="copyApiKey('${s.api_key}', event)" title="Copy API Key">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </small>
                            </div>
                            ` : ''}
                            <div class="mb-3">
                                <span class="badge bg-${s.status === 'active' ? 'success' : 'secondary'}">
                                    ${escapeHtml(s.status || 'active')}
                                </span>
                                ${s.is_public
                                    ? '<span class="badge bg-info ms-1"><i class="bi bi-globe"></i> –ü—É–±–ª–∏—á–Ω—ã–π</span>'
                                    : '<span class="badge bg-secondary ms-1"><i class="bi bi-lock-fill"></i> –ü—Ä–∏–≤–∞—Ç–Ω—ã–π</span>'}
                                ${s.available_for_purchase !== false
                                    ? '<span class="badge bg-success ms-1"><i class="bi bi-cart-check"></i> –î–æ—Å—Ç—É–ø–µ–Ω</span>'
                                    : '<span class="badge bg-secondary ms-1"><i class="bi bi-cart-x"></i> –ó–∞–∫—Ä—ã—Ç</span>'}
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-primary" onclick="editSite(${s.id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-primary" onclick="deleteSite(${s.id})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Toggle site type fields visibility
        function toggleSiteTypeFields() {
            const siteType = document.querySelector('input[name="siteType"]:checked').value;
            const isWordPress = siteType === 'wordpress';

            // Toggle fields visibility
            document.getElementById('maxArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('allowArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('wordpressPluginInfo').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('staticWidgetInfo').style.display = isWordPress ? 'none' : 'block';

            // Toggle hints
            document.getElementById('typeHintWordPress').style.display = isWordPress ? 'inline' : 'none';
            document.getElementById('typeHintStatic').style.display = isWordPress ? 'none' : 'inline';

            // Update API key field
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyRequired = document.getElementById('apiKeyRequired');
            const apiKeyAutoNote = document.getElementById('apiKeyAutoNote');
            const apiKeyHintText = document.getElementById('apiKeyHintText');

            if (isWordPress) {
                apiKeyRequired.style.display = 'inline';
                apiKeyAutoNote.style.display = 'none';
                apiKeyHintText.textContent = '–£—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ –ø–ª–∞–≥–∏–Ω Link Manager –Ω–∞ WordPress –∏ —Å–∫–æ–ø–∏—Ä—É–π—Ç–µ —Ç–æ–∫–µ–Ω –∏–∑ –Ω–∞—Å—Ç—Ä–æ–µ–∫';
                apiKeyInput.setAttribute('required', 'required');
            } else {
                apiKeyRequired.style.display = 'none';
                apiKeyAutoNote.style.display = 'inline';
                apiKeyHintText.textContent = 'API –∫–ª—é—á –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Å–∞–π—Ç–∞';
                apiKeyInput.removeAttribute('required');
            }

            // Set max_articles to 0 for static PHP sites
            if (!isWordPress) {
                document.getElementById('maxArticles').value = '0';
            }
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Add Site';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteTypeWordPress').checked = true; // Default to WordPress
            document.getElementById('maxLinks').value = '10';
            document.getElementById('maxArticles').value = '10';
            document.getElementById('allowArticles').checked = true; // Default: allow articles
            document.getElementById('availableForPurchase').checked = true; // Default: available for purchase

            // Enable API key input for new sites
            document.getElementById('apiKey').removeAttribute('readonly');

            toggleSiteTypeFields(); // Initialize field visibility
            modal.show();
        }

        function editSite(id) {
            const site = sites.find(s => s.id === id);
            if (!site) return;

            document.getElementById('modalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.site_name;
            document.getElementById('siteUrl').value = site.site_url;
            document.getElementById('apiKey').value = site.api_key || '';
            document.getElementById('maxLinks').value = site.max_links || 10;
            document.getElementById('maxArticles').value = site.max_articles || 10;

            // Set allow_articles checkbox (default to true if not set)
            document.getElementById('allowArticles').checked = site.allow_articles !== false;

            // Set is_public checkbox (default to false if not set)
            document.getElementById('isPublic').checked = site.is_public === true;

            // Set available_for_purchase checkbox (default to true if not set)
            document.getElementById('availableForPurchase').checked = site.available_for_purchase !== false;

            // Make API key readonly when editing
            document.getElementById('apiKey').setAttribute('readonly', 'readonly');

            // Set site type (default to wordpress if not set)
            const siteType = site.site_type || 'wordpress';
            if (siteType === 'static_php') {
                document.getElementById('siteTypeStatic').checked = true;
            } else {
                document.getElementById('siteTypeWordPress').checked = true;
            }
            toggleSiteTypeFields(); // Update field visibility

            modal.show();
        }

        async function saveSite() {
            const id = document.getElementById('siteId').value;
            const siteType = document.querySelector('input[name="siteType"]:checked').value;

            const data = {
                site_name: document.getElementById('siteName').value,
                site_url: document.getElementById('siteUrl').value,
                site_type: siteType,
                max_links: parseInt(document.getElementById('maxLinks').value),
                max_articles: parseInt(document.getElementById('maxArticles').value)
            };

            // Only include API key and allow_articles for WordPress sites
            if (siteType === 'wordpress') {
                data.api_key = document.getElementById('apiKey').value;
                data.allow_articles = document.getElementById('allowArticles').checked;
            } else {
                // Static sites always have allow_articles = false
                data.allow_articles = false;
            }

            // Add is_public checkbox value (applies to all site types)
            data.is_public = document.getElementById('isPublic').checked;

            // Add available_for_purchase checkbox value (applies to all site types)
            data.available_for_purchase = document.getElementById('availableForPurchase').checked;

            try {
                if (id) {
                    await SitesAPI.update(id, data);
                    showNotification('Site updated successfully');
                } else {
                    await SitesAPI.create(data);
                    showNotification('Site created successfully');
                }
                modal.hide();
                await loadSites();
            } catch (error) {
                showNotification('Failed to save site: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            try {
                // Get placements for this site to show warning
                const response = await PlacementsAPI.getBySite(id);
                const { placements, summary } = response;

                // Build confirmation message
                let message = '–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç–æ—Ç —Å–∞–π—Ç?';

                if (summary.total > 0) {
                    message = `‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï: –ù–∞ —ç—Ç–æ–º —Å–∞–π—Ç–µ –µ—Å—Ç—å ${summary.total} —Ä–∞–∑–º–µ—â–µ–Ω–∏${summary.total === 1 ? '–µ' : summary.total < 5 ? '—è' : '–π'}!\n\n`;

                    if (summary.paidCount > 0) {
                        message += `üí∞ –ü–ª–∞—Ç–Ω—ã—Ö —Ä–∞–∑–º–µ—â–µ–Ω–∏–π: ${summary.paidCount}\n`;
                        message += `üíµ –û–±—â–∞—è —Å—Ç–æ–∏–º–æ—Å—Ç—å: $${summary.totalRefund.toFixed(2)}\n\n`;
                        message += `‚úÖ –í—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã\n`;
                        message += `‚úÖ –î–µ–Ω—å–≥–∏ ($${summary.totalRefund.toFixed(2)}) –±—É–¥—É—Ç –≤–æ–∑–≤—Ä–∞—â–µ–Ω—ã –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å\n`;
                        message += `‚úÖ –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ —Å—Å—ã–ª–æ–∫/—Å—Ç–∞—Ç–µ–π –±—É–¥–µ—Ç –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ\n\n`;
                    } else {
                        message += `–í—Å–µ —Ä–∞–∑–º–µ—â–µ–Ω–∏—è (–±–µ—Å–ø–ª–∞—Ç–Ω—ã–µ) –±—É–¥—É—Ç —É–¥–∞–ª–µ–Ω—ã.\n\n`;
                    }

                    message += `–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å?`;
                }

                if (!confirm(message)) return;

                // Delete site with refunds
                const result = await SitesAPI.delete(id);

                // Show success message with refund details
                if (result.refundedCount > 0) {
                    showNotification(
                        `–°–∞–π—Ç —É–¥–∞–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ! –í–æ–∑–≤—Ä–∞—â–µ–Ω–æ: $${result.totalRefunded.toFixed(2)} (${result.refundedCount} —Ä–∞–∑–º–µ—â–µ–Ω–∏${result.refundedCount === 1 ? '–µ' : result.refundedCount < 5 ? '—è' : '–π'})`,
                        'success'
                    );

                    if (result.tierChanged) {
                        showNotification(
                            `–í–∞—à —É—Ä–æ–≤–µ–Ω—å —Å–∫–∏–¥–∫–∏ –∏–∑–º–µ–Ω–∏–ª—Å—è –Ω–∞ "${result.newTier}" –∏–∑-–∑–∞ —É–º–µ–Ω—å—à–µ–Ω–∏—è –æ–±—â–∏—Ö –∑–∞—Ç—Ä–∞—Ç.`,
                            'info'
                        );
                    }
                } else {
                    showNotification('–°–∞–π—Ç —É–¥–∞–ª—ë–Ω —É—Å–ø–µ—à–Ω–æ', 'success');
                }

                await loadSites();
            } catch (error) {
                showNotification('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ —Å–∞–π—Ç–∞: ' + error.message, 'error');
            }
        }

        function copyApiKey(apiKey, event) {
            event.stopPropagation(); // Prevent card click
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API Key copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy API Key', 'error');
            });
        }

        function copyFieldToClipboard(fieldId) {
            const field = document.getElementById(fieldId);
            const text = field.value;
            if (!text) {
                showNotification('Nothing to copy', 'warning');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        // Bulk Registration Token Functions
        async function generateRegistrationToken() {
            try {
                const label = document.getElementById('tokenLabel').value || 'Registration Token';
                const maxUses = parseInt(document.getElementById('tokenMaxUses').value) || 0;
                const expireDays = parseInt(document.getElementById('tokenExpireDays').value) || 30;

                // Calculate expiry date
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + expireDays);

                const response = await fetch('/api/sites/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        label,
                        max_uses: maxUses,
                        expires_at: expiresAt.toISOString()
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate token');
                }

                const data = await response.json();

                // Display token
                document.getElementById('generatedToken').value = data.token;
                document.getElementById('tokenDisplay').style.display = 'block';

                // Show token info
                const maxUsesText = data.max_uses === 0 ? '–±–µ–∑–ª–∏–º–∏—Ç' : data.max_uses;
                const expiryDate = new Date(data.expires_at).toLocaleDateString('ru-RU');
                document.getElementById('tokenInfo').textContent =
                    `${data.label} | –ú–∞–∫—Å: ${maxUsesText} | –î–æ: ${expiryDate}`;

                showNotification('–¢–æ–∫–µ–Ω —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω!', 'success');
            } catch (error) {
                console.error('Generate token error:', error);
                showNotification('–û—à–∏–±–∫–∞ —Å–æ–∑–¥–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞: ' + error.message, 'error');
            }
        }

        function copyToken() {
            const tokenField = document.getElementById('generatedToken');
            navigator.clipboard.writeText(tokenField.value).then(() => {
                showNotification('–¢–æ–∫–µ–Ω —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω –≤ –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞!', 'success');
            }).catch(err => {
                console.error('Failed to copy token:', err);
                showNotification('–û—à–∏–±–∫–∞ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è —Ç–æ–∫–µ–Ω–∞', 'error');
            });
        }

        function hideToken() {
            document.getElementById('tokenDisplay').style.display = 'none';
            document.getElementById('tokenLabel').value = '';
            document.getElementById('tokenMaxUses').value = '0';
            document.getElementById('tokenExpireDays').value = '30';
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
