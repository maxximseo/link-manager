<!DOCTYPE html>
<html lang="ru" id="htmlRoot">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/modern-table.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        /* Custom styles for sites table */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Card border styling */
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            overflow: hidden;
        }

        /* === SEO Metrics columns - голубой фон как в placements-manager === */
        .seo-metric-th,
        .seo-metric-td {
            background: #eff6ff !important;
        }

        .seo-metric-th {
            color: #1d4ed8 !important;
            font-weight: 600 !important;
        }

        /* Sites Table - стиль как на dashboard */
        .sites-table {
            width: 100%;
            border-collapse: collapse;
            /* Убрали table-layout: fixed чтобы колонки могли расширяться */
        }

        .sites-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sites-table th {
            padding: 12px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
            cursor: pointer;
        }

        .sites-table th:first-child {
            padding-left: 16px;
        }

        .sites-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }

        .sites-table tbody tr:hover {
            background: #f9fafb;
        }

        .sites-table td {
            padding: 10px 8px;
            font-size: 13px;
            color: #374151;
            vertical-align: middle;
        }

        .sites-table td:first-child {
            padding-left: 16px;
        }

        /* Row background colors */
        .sites-table tr.table-danger {
            background-color: rgba(220, 38, 38, 0.06) !important;
        }

        .sites-table tr.table-success {
            background-color: rgba(34, 197, 94, 0.06) !important;
        }

        /* Pagination - стиль dashboard */
        .pagination-wrapper {
            padding: 16px 24px;
            border-top: 1px solid #e5e7eb;
            background: #f9fafb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-radius: 0 0 16px 16px;
        }

        .pagination-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-left span {
            font-size: 14px;
            color: #4b5563;
        }

        .pagination-left select {
            padding: 6px 12px;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 14px;
            background: white;
        }

        .pagination-right {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-info {
            font-size: 14px;
            color: #4b5563;
            margin-right: 16px;
        }

        .pagination-buttons {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .pagination-btn {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            background: white;
            font-size: 14px;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .pagination-btn:hover:not(:disabled):not(.active) {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .pagination-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .pagination-btn.active {
            background: #2563eb;
            color: white;
            border-color: #2563eb;
        }

        #pageNumbers {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        /* Progress bar custom styling */
        .progress {
            background-color: #e9ecef;
            border-radius: 4px;
        }

        /* Icon buttons styling */
        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        /* Tooltip-enabled icons */
        [title] {
            cursor: help;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .table thead th:nth-child(4),
            .table thead th:nth-child(5),
            .table thead th:nth-child(6),
            .table thead th:nth-child(7) {
                display: none;
            }

            .table tbody td:nth-child(4),
            .table tbody td:nth-child(5),
            .table tbody td:nth-child(6),
            .table tbody td:nth-child(7) {
                display: none;
            }
        }

        /* === Moderation Status Badges === */
        .status-approved {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #198754;
            font-size: 13px;
        }
        .status-approved i { color: #198754; }

        .status-pending {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #ffc107;
            font-size: 13px;
        }
        .status-pending i { color: #ffc107; }

        .status-rejected {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            color: #dc3545;
            font-size: 13px;
        }
        .status-rejected i { color: #dc3545; }

        /* === Action Buttons (Reference Style) === */
        .action-buttons {
            display: flex;
            gap: 8px;
            justify-content: center;
        }
        .action-btn {
            width: 36px;
            height: 36px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
            font-size: 14px;
        }
        .action-edit {
            background: #e7f1ff;
            color: #0d6efd;
        }
        .action-edit:hover {
            background: #0d6efd;
            color: white;
        }
        .action-delete {
            background: #ffebee;
            color: #dc3545;
        }
        .action-delete:hover {
            background: #dc3545;
            color: white;
        }

        /* Inline editable price cells */
        .price-cell {
            cursor: pointer;
            position: relative;
            min-width: 80px;
            transition: background-color 0.2s;
        }

        .price-cell:hover:not(.editing):not(.saving) {
            background-color: #f8f9fa;
        }

        .price-cell:hover:not(.editing):not(.saving)::after {
            content: "✎";
            position: absolute;
            right: 5px;
            top: 50%;
            transform: translateY(-50%);
            font-size: 12px;
            color: #6c757d;
        }

        .price-cell.editing {
            background-color: #fff3cd;
        }

        .price-cell.saving {
            opacity: 0.6;
            pointer-events: none;
            cursor: wait;
        }

        .price-input {
            width: 70px;
            display: inline-block;
            text-align: center;
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
        }

        .price-display {
            display: inline-block;
        }

        /* Page Header with icon */
        .page-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 24px;
        }

        .header-icon {
            width: 48px;
            height: 48px;
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
        }

        .header-text h1 {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: #111827;
        }

        .header-text .subtitle {
            font-size: 14px;
            color: #6b7280;
            margin: 4px 0 0;
        }

        /* Stats Grid - Reference Design */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 16px;
            margin-bottom: 24px;
        }

        .stat-card {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            padding: 20px 24px;
            display: flex;
            flex-direction: column;
            position: relative;
            min-height: 120px;
        }

        .stat-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 12px;
        }

        .stat-label {
            font-size: 14px;
            color: #6b7280;
            font-weight: 400;
        }

        .stat-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
        }

        .stat-value {
            font-size: 48px;
            font-weight: 600;
            color: #111827;
            line-height: 1;
            margin-top: auto;
        }

        /* Card 1: Всего сайтов - white bg, blue icon */
        .stat-card.card-total {
            background: white;
        }
        .stat-card.card-total .stat-icon {
            background: #dbeafe;
            color: #2563eb;
        }
        .stat-card.card-total .stat-value {
            color: #111827;
        }

        /* Card 2: Активных - FULL green background */
        .stat-card.card-active {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
            border-color: #16a34a;
        }
        .stat-card.card-active .stat-label {
            color: rgba(255,255,255,0.9);
        }
        .stat-card.card-active .stat-icon {
            background: rgba(255,255,255,0.2);
            color: white;
        }
        .stat-card.card-active .stat-value {
            color: white;
        }

        /* Card 3: Средний DR - white bg, purple value */
        .stat-card.card-dr {
            background: white;
        }
        .stat-card.card-dr .stat-icon {
            background: #f3e8ff;
            color: #9333ea;
        }
        .stat-card.card-dr .stat-value {
            color: #9333ea;
        }

        /* Card 4: Средний RD - cream bg, orange icon */
        .stat-card.card-rd {
            background: #fffbeb;
            border-color: #fde68a;
        }
        .stat-card.card-rd .stat-icon {
            background: #fed7aa;
            color: #ea580c;
        }
        .stat-card.card-rd .stat-value {
            color: #92400e;
        }

        /* Add Site Button - gradient */
        .btn-gradient {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.2s;
        }

        .btn-gradient:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            color: white;
        }

        /* Table Toolbar */
        .table-toolbar {
            padding: 16px 20px;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 16px;
            flex-wrap: wrap;
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 12px;
            flex-wrap: wrap;
        }

        .toolbar-right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search-wrapper {
            position: relative;
        }

        .search-wrapper i {
            position: absolute;
            left: 14px;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
            font-size: 14px;
        }

        .search-input {
            width: 280px;
            padding: 10px 16px 10px 40px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .filter-btn {
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .filter-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        .filter-btn.active {
            background: #eff6ff;
            border-color: #3b82f6;
            color: #2563eb;
        }

        .export-btn {
            padding: 10px 16px;
            border: 1px solid #e5e7eb;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .export-btn:hover {
            background: #f9fafb;
            border-color: #d1d5db;
        }

        /* Filters Dropdown */
        .filters-dropdown {
            position: relative;
        }

        .filters-panel {
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 12px;
            padding: 16px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            z-index: 100;
            min-width: 280px;
            display: none;
        }

        .filters-panel.show {
            display: block;
        }

        .filter-group {
            margin-bottom: 12px;
        }

        .filter-group:last-child {
            margin-bottom: 0;
        }

        .filter-group label {
            display: block;
            font-size: 12px;
            font-weight: 500;
            color: #6b7280;
            margin-bottom: 6px;
            text-transform: uppercase;
        }

        .filter-group select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            font-size: 14px;
        }

        /* Responsive Stats Grid */
        @media (max-width: 992px) {
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 576px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            .search-input {
                width: 100%;
            }
            .toolbar-left, .toolbar-right {
                width: 100%;
            }
        }

        /* ============================================
           Site Modal - Figma Design Styles
           ============================================ */
        .site-modal-content {
            border: none;
            border-radius: 1.5rem;
            overflow: hidden;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
        }

        .site-modal-header {
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 50%, #06b6d4 100%);
            padding: 1.5rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .site-modal-header-inner {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .site-modal-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.5rem;
        }

        .site-modal-title-wrap {
            color: white;
        }

        .site-modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin: 0;
            color: white;
        }

        .site-modal-subtitle {
            font-size: 0.875rem;
            opacity: 0.9;
            margin: 0.25rem 0 0;
        }

        .site-modal-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 0.5rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .site-modal-close:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .site-modal-body {
            padding: 2rem;
            background: #f9fafb;
            max-height: 60vh;
            overflow-y: auto;
        }

        /* Site Type Toggle */
        .site-type-toggle {
            display: flex;
            background: #e5e7eb;
            border-radius: 0.75rem;
            padding: 4px;
            margin-bottom: 0.5rem;
        }

        .site-type-btn {
            flex: 1;
            padding: 0.75rem 1rem;
            border: none;
            border-radius: 0.625rem;
            background: transparent;
            color: #6b7280;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .btn-check:checked + .site-type-btn {
            background: white;
            color: #111827;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .site-type-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        /* Form Groups */
        .site-form-group {
            margin-bottom: 1.25rem;
        }

        .site-form-label {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .required-mark {
            color: #ef4444;
        }

        .auto-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-weight: 600;
        }

        .site-form-input {
            width: 100%;
            padding: 0.75rem 1rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            color: #111827;
            transition: all 0.2s;
        }

        .site-form-input:focus {
            outline: none;
            border-color: #a855f7;
            box-shadow: 0 0 0 3px rgba(168, 85, 247, 0.1);
        }

        .site-form-input::placeholder {
            color: #9ca3af;
        }

        .site-form-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.375rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        /* Input with button */
        .site-input-with-button {
            display: flex;
            gap: 0.5rem;
        }

        .site-input-with-button .site-form-input {
            flex: 1;
        }

        .site-copy-btn {
            width: 48px;
            background: linear-gradient(135deg, #a855f7, #6366f1);
            border: none;
            border-radius: 0.75rem;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .site-copy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(168, 85, 247, 0.3);
        }

        /* Form Row */
        .site-form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        /* Price Input */
        .site-price-input {
            position: relative;
        }

        .site-price-input .price-prefix {
            position: absolute;
            left: 1rem;
            top: 50%;
            transform: translateY(-50%);
            color: #6b7280;
            font-weight: 500;
        }

        .site-price-input .site-form-input {
            padding-left: 2rem;
        }

        /* Cooldown Warning */
        .site-cooldown-warning {
            background: #fef3c7;
            border: 1px solid #fcd34d;
            border-radius: 0.75rem;
            padding: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            margin-bottom: 1.25rem;
            color: #92400e;
        }

        .site-cooldown-warning i {
            font-size: 1.25rem;
            color: #f59e0b;
        }

        /* Toggles Section */
        .site-toggles-section {
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 1rem;
            overflow: hidden;
            margin-bottom: 1.5rem;
        }

        .site-toggle-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid #f3f4f6;
        }

        .site-toggle-item:last-child {
            border-bottom: none;
        }

        .site-toggle-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .site-toggle-icon {
            width: 40px;
            height: 40px;
            border-radius: 0.625rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.125rem;
        }

        .site-toggle-icon.green {
            background: #dcfce7;
            color: #16a34a;
        }

        .site-toggle-icon.purple {
            background: #f3e8ff;
            color: #9333ea;
        }

        .site-toggle-icon.blue {
            background: #dbeafe;
            color: #2563eb;
        }

        .site-toggle-label {
            font-size: 0.9375rem;
            font-weight: 500;
            color: #111827;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .admin-badge {
            background: #fef3c7;
            color: #92400e;
            font-size: 0.625rem;
            padding: 0.125rem 0.5rem;
            border-radius: 999px;
            font-weight: 600;
        }

        .site-toggle-hint {
            font-size: 0.75rem;
            color: #6b7280;
            margin: 0.125rem 0 0;
        }

        /* Toggle Switch */
        .site-toggle-switch {
            position: relative;
            width: 48px;
            height: 28px;
            cursor: pointer;
        }

        .site-toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .site-toggle-slider {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: #e5e7eb;
            border-radius: 999px;
            transition: all 0.3s;
        }

        .site-toggle-slider::before {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            left: 3px;
            bottom: 3px;
            background: white;
            border-radius: 50%;
            transition: all 0.3s;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .site-toggle-switch input:checked + .site-toggle-slider {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .site-toggle-switch input:checked + .site-toggle-slider::before {
            transform: translateX(20px);
        }

        /* Plugin Section */
        .site-plugin-section {
            background: #eff6ff;
            border: 2px solid #bfdbfe;
            border-radius: 1rem;
            padding: 1.25rem;
            margin-bottom: 1rem;
        }

        .site-plugin-section.static {
            background: #f0fdf4;
            border-color: #86efac;
        }

        .site-plugin-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .site-plugin-icon {
            width: 44px;
            height: 44px;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            border-radius: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 1.25rem;
        }

        .site-plugin-icon.static {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .site-plugin-header h6 {
            font-size: 1rem;
            font-weight: 600;
            color: #111827;
            margin: 0;
        }

        .site-plugin-header p {
            font-size: 0.8125rem;
            color: #6b7280;
            margin: 0.125rem 0 0;
        }

        .site-download-btn {
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.625rem 1.25rem;
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            border: none;
            border-radius: 0.625rem;
            font-size: 0.875rem;
            font-weight: 500;
            text-decoration: none;
            transition: all 0.2s;
        }

        .site-download-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
            color: white;
        }

        .site-download-btn.green {
            background: linear-gradient(135deg, #22c55e, #16a34a);
        }

        .site-download-btn.green:hover {
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.3);
        }

        .site-static-steps {
            font-size: 0.8125rem;
            color: #374151;
            margin-top: 1rem;
            line-height: 1.5;
        }

        .site-static-steps code {
            background: rgba(0, 0, 0, 0.1);
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
        }

        .site-static-warning {
            background: #fef3c7;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.75rem;
            font-size: 0.8125rem;
            color: #92400e;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        /* Modal Footer */
        .site-modal-footer {
            padding: 1.25rem 2rem;
            background: white;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
        }

        .site-btn-cancel {
            padding: 0.75rem 1.5rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            font-weight: 500;
            color: #374151;
            cursor: pointer;
            transition: all 0.2s;
        }

        .site-btn-cancel:hover {
            background: #f3f4f6;
            border-color: #d1d5db;
        }

        .site-btn-save {
            padding: 0.75rem 1.5rem;
            background: linear-gradient(135deg, #a855f7 0%, #6366f1 100%);
            border: none;
            border-radius: 0.75rem;
            font-size: 0.9375rem;
            font-weight: 600;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .site-btn-save:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 20px rgba(168, 85, 247, 0.3);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .site-modal-body {
                padding: 1.25rem;
            }
            .site-form-row {
                grid-template-columns: 1fr;
            }
            .site-modal-footer {
                padding: 1rem 1.25rem;
            }
        }
    </style>
</head>
<body>
    <!-- Content will be wrapped by sidebar.js -->

    <div class="container-fluid">
        <!-- Stats Grid (4 cards) - Reference Design -->
        <div class="stats-grid">
            <!-- Card 1: Всего сайтов - white bg, blue icon -->
            <div class="stat-card card-total">
                <div class="stat-card-header">
                    <div class="stat-label" data-i18n="totalSitesLabel">Всего<br>сайтов</div>
                    <div class="stat-icon">
                        <i class="bi bi-globe2"></i>
                    </div>
                </div>
                <div class="stat-value" id="statTotalSites">0</div>
            </div>
            <!-- Card 2: Активных - FULL green background -->
            <div class="stat-card card-active">
                <div class="stat-card-header">
                    <div class="stat-label" data-i18n="activeSites">Активных</div>
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                </div>
                <div class="stat-value" id="statActiveSites">0</div>
            </div>
            <!-- Card 3: Средний DR - white bg, purple value -->
            <div class="stat-card card-dr">
                <div class="stat-card-header">
                    <div class="stat-label" data-i18n="averageDR">Средний DR</div>
                    <div class="stat-icon">
                        <i class="bi bi-graph-up-arrow"></i>
                    </div>
                </div>
                <div class="stat-value" id="statAvgDR">0</div>
            </div>
            <!-- Card 4: Средний RD - cream bg, orange icon -->
            <div class="stat-card card-rd">
                <div class="stat-card-header">
                    <div class="stat-label" data-i18n="averageRD">Средний RD</div>
                    <div class="stat-icon">
                        <i class="bi bi-link-45deg"></i>
                    </div>
                </div>
                <div class="stat-value" id="statAvgRD">0</div>
            </div>
        </div>

        <!-- Bulk Actions Bar (скрыта по умолчанию) -->
        <div id="bulkActionsBar" class="alert alert-primary py-1 d-none mb-2" style="font-size: 12px;">
            <div class="d-flex align-items-center flex-wrap gap-2">
                <strong class="me-2"><span data-i18n="selected">Выбрано</span>: <span id="selectedCount">0</span></strong>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('allow_articles', true)">
                        <i class="bi bi-file-text-fill"></i> <span data-i18n="articlesOn">Статьи ВКЛ</span>
                    </button>
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('allow_articles', false)">
                        <i class="bi bi-file-text"></i> <span data-i18n="articlesOff">ВЫКЛ</span>
                    </button>
                </div>
                <div class="btn-group btn-group-sm admin-only-field" role="group" id="bulkPublicButtons" style="display: none;">
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('is_public', true)">
                        <i class="bi bi-globe"></i> <span data-i18n="publicSites">Публичные</span>
                    </button>
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('is_public', false)">
                        <i class="bi bi-lock-fill"></i> <span data-i18n="privateSites">Личные</span>
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('available_for_purchase', true)">
                        <i class="bi bi-cart-check-fill"></i> <span data-i18n="purchaseOn">Покупка ВКЛ</span>
                    </button>
                    <button class="btn btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="bulkSetField('available_for_purchase', false)">
                        <i class="bi bi-cart-x-fill"></i> <span data-i18n="purchaseOff">ВЫКЛ</span>
                    </button>
                </div>
                <div class="btn-group btn-group-sm" role="group">
                    <button class="btn btn-light border py-1 px-2 bulk-price-btn" style="background: white !important; color: #333 !important; font-size: 12px;" data-field="price_link">
                        <i class="bi bi-cash-stack"></i> <span data-i18n="priceMain">Цена Main</span>
                    </button>
                    <button class="btn btn-light border py-1 px-2 bulk-price-btn" style="background: white !important; color: #333 !important; font-size: 12px;" data-field="price_article">
                        <i class="bi bi-file-text"></i> <span data-i18n="priceGP">Цена GP</span>
                    </button>
                </div>
                <button class="btn btn-sm btn-light border py-1 px-2" style="background: white !important; color: #333 !important; font-size: 12px;" onclick="clearBulkSelection()">
                    <i class="bi bi-x-lg"></i> <span data-i18n="cancel">Отмена</span>
                </button>
            </div>
        </div>

        <!-- Sites Table Card -->
        <div class="card">
            <!-- Table Toolbar -->
            <div class="table-toolbar">
                <div class="toolbar-left">
                    <div class="search-wrapper">
                        <i class="bi bi-search"></i>
                        <input type="text" class="search-input" id="searchInput" data-i18n-placeholder="searchByNameOrUrl" placeholder="Поиск по названию или URL...">
                    </div>
                    <div class="filters-dropdown">
                        <button class="filter-btn" onclick="toggleFiltersPanel()" id="filtersBtn">
                            <i class="bi bi-funnel"></i> <span data-i18n="filters">Фильтры</span>
                            <span id="activeFiltersCount" class="badge bg-primary ms-1" style="display: none;">0</span>
                        </button>
                        <div class="filters-panel" id="filtersPanel">
                            <div class="filter-group">
                                <label data-i18n="guestPosts">Гест-посты</label>
                                <select class="form-select" id="allowArticlesFilter">
                                    <option value="" data-i18n="all">Все</option>
                                    <option value="true" data-i18n="allowed">Разрешены</option>
                                    <option value="false" data-i18n="forbidden">Запрещены</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label data-i18n="visibility">Видимость</label>
                                <select class="form-select" id="isPublicFilter">
                                    <option value="" data-i18n="all">Все</option>
                                    <option value="true" data-i18n="public">Публичные</option>
                                    <option value="false" data-i18n="hidden">Скрытые</option>
                                </select>
                            </div>
                            <div class="filter-group">
                                <label data-i18n="purchase">Покупка</label>
                                <select class="form-select" id="availableForPurchaseFilter">
                                    <option value="" data-i18n="all">Все</option>
                                    <option value="true" data-i18n="available">Доступны</option>
                                    <option value="false" data-i18n="unavailable">Недоступны</option>
                                </select>
                            </div>
                            <div class="d-flex gap-2 mt-3">
                                <button type="button" class="btn btn-sm btn-outline-secondary flex-grow-1" onclick="resetFilters()">
                                    <i class="bi bi-x-circle"></i> <span data-i18n="reset">Сбросить</span>
                                </button>
                                <button type="button" class="btn btn-sm btn-primary flex-grow-1" onclick="toggleFiltersPanel()">
                                    <span data-i18n="apply">Применить</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="toolbar-right">
                    <button class="export-btn" onclick="showExportModal()">
                        <i class="bi bi-download"></i> <span data-i18n="export">Export</span>
                    </button>
                    <button class="btn-gradient" onclick="showCreateModal()">
                        <i class="bi bi-plus-lg"></i> <span data-i18n="addSite">Добавить сайт</span>
                    </button>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <div class="table-responsive">
                    <table class="sites-table">
                        <thead>
                            <tr>
                                <th class="text-center" style="width: 40px;">
                                    <input type="checkbox" class="form-check-input" id="selectAllSites" onchange="toggleSelectAll()">
                                </th>
                                <th style="width: 35px; cursor: pointer;" onclick="sortTable('site_name')">
                                    Site <span id="sort-site_name"></span>
                                </th>
                                <th class="text-center" style="width: 60px; cursor: pointer;" onclick="sortTable('price_link')">
                                    Main <span id="sort-price_link"></span>
                                </th>
                                <th class="text-center" style="width: 60px; cursor: pointer;" onclick="sortTable('price_article')">
                                    GP <span id="sort-price_article"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 40px; cursor: pointer;" onclick="sortTable('dr')">
                                    DR <span id="sort-dr"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 40px; cursor: pointer;" onclick="sortTable('da')">
                                    DA <span id="sort-da"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 40px; cursor: pointer;" onclick="sortTable('tf')">
                                    TF <span id="sort-tf"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 40px; cursor: pointer;" onclick="sortTable('cf')">
                                    CF <span id="sort-cf"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 50px; cursor: pointer;" onclick="sortTable('ref_domains')">
                                    RD <span id="sort-ref_domains"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 50px; cursor: pointer;" onclick="sortTable('rd_main')">
                                    RDm <span id="sort-rd_main"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 50px; cursor: pointer;" onclick="sortTable('norm')">
                                    Norm <span id="sort-norm"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 60px; cursor: pointer;" onclick="sortTable('keywords')">
                                    KW <span id="sort-keywords"></span>
                                </th>
                                <th class="text-center seo-metric-th" style="width: 60px; cursor: pointer;" onclick="sortTable('traffic')">
                                    Traf <span id="sort-traffic"></span>
                                </th>
                                <th class="text-center" style="width: 50px; cursor: pointer;" onclick="sortTable('geo')">
                                    GEO <span id="sort-geo"></span>
                                </th>
                                <th class="text-center" style="width: 100px; cursor: pointer;" onclick="sortTable('moderation_status')">
                                    <span data-i18n="status">Статус</span> <span id="sort-moderation_status"></span>
                                </th>
                                <th class="text-center" style="width: 80px;" data-i18n="type">Тип</th>
                                <th class="text-center" style="width: 60px;" title="Открыть сайт">
                                    <i class="bi bi-box-arrow-up-right"></i>
                                </th>
                                <th style="width: 120px;" data-i18n="homepages">Главные</th>
                                <th style="width: 120px;" data-i18n="guestPosts">Гест-посты</th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-file-text" data-bs-toggle="tooltip" data-bs-placement="top" title="Разрешить размещение гест-постов"></i>
                                </th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-globe" data-bs-toggle="tooltip" data-bs-placement="top" title="Публичный сайт"></i>
                                </th>
                                <th class="text-center" style="width: 60px;">
                                    <i class="bi bi-cart-check" data-bs-toggle="tooltip" data-bs-placement="top" title="Доступен для покупки"></i>
                                </th>
                                <th style="width: 80px;">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sitesTableBody">
                            <!-- Sites will be rendered here -->
                        </tbody>
                    </table>
                </div>

                <!-- Pagination Controls - стиль dashboard -->
                <div class="pagination-wrapper" id="paginationWrapper">
                    <div class="pagination-left">
                        <span data-i18n="showSites">Показать</span>:
                        <select id="limitSelect" onchange="changeItemsPerPage(this.value)">
                            <option value="100" selected>100</option>
                            <option value="200">200</option>
                            <option value="500">500</option>
                        </select>
                        <span data-i18n="sitesPerPage">сайтов</span>
                    </div>
                    <div class="pagination-right">
                        <span class="pagination-info" id="paginationInfo">Показано 0–0 из 0</span>
                        <div class="pagination-buttons">
                            <button class="pagination-btn" id="prevPageBtn" onclick="changePage(currentPage - 1)" disabled>
                                <i class="bi bi-chevron-left"></i>
                            </button>
                            <div id="pageNumbers">
                                <!-- Page buttons will be generated here -->
                            </div>
                            <button class="pagination-btn" id="nextPageBtn" onclick="changePage(currentPage + 1)" disabled>
                                <i class="bi bi-chevron-right"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bulk Registration Section -->
        <div class="card mt-5 mb-4" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <div class="card-body">
                <h5 class="card-title mb-3">
                    <i class="bi bi-cloud-arrow-down"></i> <span data-i18n="bulkRegistration">Массовая регистрация WordPress сайтов</span>
                </h5>
                <p class="small mb-3 opacity-75" data-i18n="bulkRegistrationDesc">
                    Сгенерируйте токен регистрации и используйте его на множестве WordPress сайтов с плагином Link Manager для быстрого добавления в систему.
                </p>

                <div class="row g-3">
                    <div class="col-md-4">
                        <label class="form-label small" data-i18n="tokenLabel">Название токена</label>
                        <input type="text" class="form-control" id="tokenLabel" data-i18n-placeholder="tokenLabelPlaceholder" placeholder="Например: Январь 2025">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small" data-i18n="tokenMaxUses">Макс. использований</label>
                        <input type="number" class="form-control" id="tokenMaxUses" value="0" min="0" data-i18n-placeholder="tokenUnlimited" placeholder="0 = безлимит">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label small" data-i18n="tokenExpireDays">Срок действия (дней)</label>
                        <input type="number" class="form-control" id="tokenExpireDays" value="30" min="1" placeholder="30">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label small">&nbsp;</label>
                        <button class="btn btn-light w-100" onclick="generateRegistrationToken()">
                            <i class="bi bi-key"></i> <span data-i18n="generate">Создать</span>
                        </button>
                    </div>
                </div>

                <!-- Active Tokens List -->
                <div id="activeTokensList" class="mt-4">
                    <!-- Tokens will be loaded here via JavaScript -->
                </div>
            </div>
        </div>
    </div>

    <!-- Create/Edit Modal - Figma Design -->
    <div class="modal fade" id="siteModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content site-modal-content">
                <!-- Gradient Header -->
                <div class="site-modal-header">
                    <div class="site-modal-header-inner">
                        <div class="site-modal-icon">
                            <i class="bi bi-globe2"></i>
                        </div>
                        <div class="site-modal-title-wrap">
                            <h5 class="site-modal-title" id="modalTitle" data-i18n="addSite">Add Site</h5>
                            <p class="site-modal-subtitle" data-i18n="configureSiteSettings">Configure site settings and integration</p>
                        </div>
                    </div>
                    <button type="button" class="site-modal-close" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="site-modal-body">
                    <form id="siteForm">
                        <input type="hidden" id="siteId">

                        <!-- Site Type Toggle -->
                        <div class="site-type-toggle">
                            <input type="radio" class="btn-check" name="siteType" id="siteTypeWordPress" value="wordpress" checked onchange="toggleSiteTypeFields()">
                            <label class="site-type-btn" for="siteTypeWordPress">
                                <i class="bi bi-wordpress"></i>
                                <span>WordPress</span>
                            </label>

                            <input type="radio" class="btn-check" name="siteType" id="siteTypeStatic" value="static_php" onchange="toggleSiteTypeFields()">
                            <label class="site-type-btn" for="siteTypeStatic">
                                <i class="bi bi-filetype-php"></i>
                                <span data-i18n="staticPHP">Static PHP</span>
                            </label>
                        </div>
                        <p class="site-type-hint">
                            <span id="typeHintWordPress" data-i18n="wordpressHint">WordPress с установленным плагином Link Manager</span>
                            <span id="typeHintStatic" style="display:none" data-i18n="staticHint">Статичный сайт с PHP виджетом (только ссылки)</span>
                        </p>

                        <!-- Site Name -->
                        <div class="site-form-group">
                            <label for="siteName" class="site-form-label" data-i18n="siteName">Site Name</label>
                            <input type="text" class="site-form-input" id="siteName" required placeholder="My Awesome Site">
                        </div>

                        <!-- Site URL -->
                        <div class="site-form-group">
                            <label for="siteUrl" class="site-form-label" data-i18n="siteUrl">Site URL</label>
                            <input type="url" class="site-form-input" id="siteUrl" required placeholder="https://example.com">
                        </div>

                        <!-- API Token with Copy -->
                        <div id="apiKeyField" class="site-form-group">
                            <label for="apiKey" class="site-form-label">
                                <span data-i18n="apiToken">API Token</span>
                                <span id="apiKeyRequired" class="required-mark">*</span>
                                <span id="apiKeyAutoNote" style="display:none;" class="auto-badge" data-i18n="autoGenerated">Auto</span>
                            </label>
                            <div class="site-input-with-button">
                                <input type="text" class="site-form-input font-monospace" id="apiKey"
                                       data-i18n-placeholder="apiTokenPlaceholder" placeholder="api_xxxxxxxxxxxxx">
                                <button class="site-copy-btn" type="button" onclick="copyFieldToClipboard('apiKey')" id="copyApiKeyBtn">
                                    <i class="bi bi-clipboard"></i>
                                </button>
                            </div>
                            <p class="site-form-hint" id="apiKeyHint">
                                <i class="bi bi-info-circle"></i>
                                <span id="apiKeyHintText" data-i18n="apiTokenHint">Get token from WordPress plugin settings</span>
                            </p>
                        </div>

                        <!-- Max Links / Max Articles Row -->
                        <div class="site-form-row">
                            <div class="site-form-group">
                                <label for="maxLinks" class="site-form-label" data-i18n="maxLinks">Max Links</label>
                                <input type="number" class="site-form-input" id="maxLinks" required min="0" value="10">
                            </div>
                            <div class="site-form-group" id="maxArticlesField">
                                <label for="maxArticles" class="site-form-label" data-i18n="maxArticles">Max Guest Posts</label>
                                <input type="number" class="site-form-input" id="maxArticles" required min="0" value="10">
                            </div>
                        </div>

                        <!-- Cooldown Warning -->
                        <div id="limitsCooldownWarning" class="site-cooldown-warning" style="display: none;">
                            <i class="bi bi-clock-history"></i>
                            <div>
                                <strong data-i18n="restriction">Restriction</strong>
                                <span id="limitsCooldownText"></span>
                            </div>
                        </div>

                        <!-- Price Row -->
                        <div class="site-form-row">
                            <div class="site-form-group">
                                <label for="priceLink" class="site-form-label">
                                    <i class="bi bi-tag-fill"></i>
                                    <span data-i18n="priceLinkLabel">Link Price (USD)</span>
                                </label>
                                <div class="site-price-input">
                                    <span class="price-prefix">$</span>
                                    <input type="number" class="site-form-input" id="priceLink" min="0" step="0.01" placeholder="25.00">
                                </div>
                            </div>
                            <div class="site-form-group" id="priceArticleField">
                                <label for="priceArticle" class="site-form-label">
                                    <i class="bi bi-tag-fill"></i>
                                    <span data-i18n="priceArticleLabel">Guest Post Price (USD)</span>
                                </label>
                                <div class="site-price-input">
                                    <span class="price-prefix">$</span>
                                    <input type="number" class="site-form-input" id="priceArticle" min="0" step="0.01" placeholder="15.00">
                                </div>
                            </div>
                        </div>

                        <!-- Toggles Section -->
                        <div class="site-toggles-section">
                            <!-- Allow Guest Posts -->
                            <div class="site-toggle-item" id="allowArticlesField">
                                <div class="site-toggle-info">
                                    <div class="site-toggle-icon green">
                                        <i class="bi bi-file-earmark-text"></i>
                                    </div>
                                    <div>
                                        <span class="site-toggle-label" data-i18n="allowGuestPosts">Allow Guest Posts</span>
                                        <p class="site-toggle-hint" data-i18n="allowGuestPostsHint">Enable to allow guest post placements</p>
                                    </div>
                                </div>
                                <label class="site-toggle-switch">
                                    <input type="checkbox" id="allowArticles" checked>
                                    <span class="site-toggle-slider"></span>
                                </label>
                            </div>

                            <!-- Public Purchases (Admin Only) -->
                            <div class="site-toggle-item admin-only-field" id="isPublicFieldWrapper" style="display: none;">
                                <div class="site-toggle-info">
                                    <div class="site-toggle-icon purple">
                                        <i class="bi bi-globe"></i>
                                    </div>
                                    <div>
                                        <span class="site-toggle-label">
                                            <span data-i18n="allowPublicPurchases">Public Purchases</span>
                                            <span class="admin-badge" data-i18n="adminOnly">Admin</span>
                                        </span>
                                        <p class="site-toggle-hint" data-i18n="allowPublicPurchasesHint">Allow other users to place content</p>
                                    </div>
                                </div>
                                <label class="site-toggle-switch">
                                    <input type="checkbox" id="isPublic">
                                    <span class="site-toggle-slider"></span>
                                </label>
                            </div>

                            <!-- Available for Purchase -->
                            <div class="site-toggle-item">
                                <div class="site-toggle-info">
                                    <div class="site-toggle-icon blue">
                                        <i class="bi bi-cart-check"></i>
                                    </div>
                                    <div>
                                        <span class="site-toggle-label" data-i18n="availableForPurchase">Available for Purchase</span>
                                        <p class="site-toggle-hint" data-i18n="availableForPurchaseHint">Disable to temporarily close for new placements</p>
                                    </div>
                                </div>
                                <label class="site-toggle-switch">
                                    <input type="checkbox" id="availableForPurchase" checked>
                                    <span class="site-toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- WordPress Plugin Download -->
                        <div class="site-plugin-section" id="wordpressPluginInfo">
                            <div class="site-plugin-header">
                                <div class="site-plugin-icon">
                                    <i class="bi bi-wordpress"></i>
                                </div>
                                <div>
                                    <h6 data-i18n="wordpressPluginRequired">WordPress Plugin</h6>
                                    <p data-i18n="wordpressPluginDesc">Install the Link Manager plugin to enable integration</p>
                                </div>
                            </div>
                            <a href="/link-manager-widget.zip" download="link-manager-widget.zip" class="site-download-btn">
                                <i class="bi bi-download"></i>
                                <span data-i18n="downloadPlugin">Download Plugin</span>
                            </a>
                        </div>

                        <!-- Static PHP Widget Info -->
                        <div class="site-plugin-section static" id="staticWidgetInfo" style="display:none">
                            <div class="site-plugin-header">
                                <div class="site-plugin-icon static">
                                    <i class="bi bi-filetype-php"></i>
                                </div>
                                <div>
                                    <h6 data-i18n="phpWidgetTitle">PHP Widget</h6>
                                    <p data-i18n="phpWidgetDesc">Download and install on your PHP site</p>
                                </div>
                            </div>
                            <a href="/static.php" download="static.php" class="site-download-btn green">
                                <i class="bi bi-download"></i>
                                <span data-i18n="downloadStaticPHP">Download Widget</span>
                            </a>
                            <div class="site-static-steps" data-i18n="phpWidgetSteps">
                                <strong>Setup:</strong> Replace <code>YOUR_API_KEY_HERE</code> with your API key, upload to server, include where needed.
                            </div>
                            <div class="site-static-warning">
                                <i class="bi bi-exclamation-triangle"></i>
                                <span data-i18n="staticOnlyLinks">Static sites support links only, no guest posts.</span>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- Footer -->
                <div class="site-modal-footer">
                    <button type="button" class="site-btn-cancel" data-bs-dismiss="modal" data-i18n="cancel">Cancel</button>
                    <button type="button" class="site-btn-save" onclick="saveSite()">
                        <i class="bi bi-check2"></i>
                        <span data-i18n="save">Save Site</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Sites Modal -->
    <div class="modal fade" id="exportModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="bi bi-download"></i> <span data-i18n="exportSites">Export Sites</span>
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <!-- Format selector -->
                    <div class="mb-3">
                        <label class="form-label" data-i18n="exportFormat">Export Format:</label>
                        <select class="form-select" id="exportFormat" onchange="updateExportPreview()">
                            <option value="csv" data-i18n="exportCSV">CSV (for Excel/Sheets)</option>
                            <option value="tsv" data-i18n="exportTSV">Tab-separated (for pasting)</option>
                            <option value="plain" data-i18n="exportPlain">Plain text (formatted)</option>
                            <option value="json" data-i18n="exportJSON">JSON (backup)</option>
                        </select>
                    </div>

                    <!-- Preview area -->
                    <div class="mb-3">
                        <label class="form-label" data-i18n="preview">Preview:</label>
                        <textarea class="form-control font-monospace"
                                  id="exportPreview"
                                  rows="15"
                                  readonly
                                  style="font-size: 0.85rem; white-space: pre; overflow-x: auto;"></textarea>
                    </div>

                    <!-- Stats -->
                    <div class="text-muted small">
                        <i class="bi bi-info-circle"></i>
                        <span data-i18n="totalSites">Total sites</span>: <strong id="exportCount">0</strong>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="close">Close</button>
                    <button type="button" class="btn btn-primary" onclick="copyExportToClipboard()">
                        <i class="bi bi-clipboard"></i> <span data-i18n="copyToClipboard">Copy to Clipboard</span>
                    </button>
                    <button type="button" class="btn btn-success" onclick="downloadExport()">
                        <i class="bi bi-download"></i> <span data-i18n="downloadFile">Download File</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/translations.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script>
        // Initialize language and translations
        (function() {
            const lang = getLang();
            document.documentElement.lang = lang;
            document.title = lang === 'en' ? 'Sites - Link Manager' : 'Сайты - Link Manager';
            if (typeof applyTranslations === 'function') {
                applyTranslations();
            }
        })();

        // Initialize sidebar navigation
        SidebarNav.init({
            activePage: 'sites',
            pageTitle: getLang() === 'en' ? 'Sites' : 'Сайты',
            pageSubtitle: getLang() === 'en' ? 'Manage sites for placements' : 'Управление сайтами для размещений',
            pageIcon: 'globe2',
            pageIconGradient: 'gradient-green-teal'
        });

        window.sites = [];  // Make sites globally accessible
        let modal;
        let exportModal;
        let currentPage = 1;
        let currentLimit = 100;
        let totalSites = 0;
        let totalPages = 0;

        // ===== PRICE EDITING FUNCTIONS (must be before addEventListener) =====

        let currentBulkField = null;

        function enablePriceEdit(cell, siteId, field) {
            // Prevent multiple edits
            if (cell.classList.contains('editing')) {
                return;
            }

            // Get current value from sites array
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            // Only allow editing public sites
            if (!site.is_public) {
                showNotification('Цены можно менять только для публичных сайтов', 'warning');
                return;
            }

            const currentValue = site[field];

            // Если цена не задана (null/undefined), используем дефолтное значение
            const defaultValue = field === 'price_link' ? '25.00' : '15.00';
            const displayValue = currentValue !== null && currentValue !== undefined
                ? parseFloat(currentValue).toFixed(2)
                : defaultValue;

            cell.classList.add('editing');

            // Hide display, create input
            const display = cell.querySelector('.price-display');
            display.classList.add('d-none');

            // Create input element
            const input = document.createElement('input');
            input.type = 'text';  // Используем text вместо number для работы select()
            input.inputMode = 'decimal';  // Мобильная клавиатура с точкой для десятичных чисел
            input.className = 'form-control form-control-sm price-input';
            input.value = displayValue;  // Десятичное число с 2 знаками
            input.placeholder = cell.dataset.default;

            // Event handlers
            input.onblur = () => savePriceEdit(cell, siteId, field);
            input.onkeydown = (e) => handlePriceKeydown(e, cell, siteId, field);

            // Select all text when clicking on input
            input.onclick = function() {
                this.select();
            };

            // Insert into DOM first
            cell.appendChild(input);

            // Focus and select text
            input.focus();
            input.select();
        }

        async function savePriceEdit(cell, siteId, field) {
            const input = cell.querySelector('.price-input');
            if (!input) return;

            const value = input.value.trim();
            const numericValue = value === '' ? null : parseFloat(value);

            // Validation - минимальная цена $5.00, шаг $0.10
            if (numericValue !== null && (isNaN(numericValue) || numericValue < 5)) {
                showNotification('Минимальная цена: $5.00, шаг $0.10', 'error');
                input.focus();
                return;
            }

            // Show saving state
            cell.classList.add('saving');

            try {
                // API call
                const data = {};
                data[field] = numericValue;
                await SitesAPI.update(siteId, data);

                // Update local data
                const site = window.sites.find(s => s.id === siteId);
                if (site) site[field] = numericValue;

                // Re-render cell - с 2 десятичными знаками
                const defaultValue = field === 'price_link' ? '25.00' : '15.00';
                const display = cell.querySelector('.price-display');
                if (numericValue !== null) {
                    display.innerHTML = `<span class="text-success">$${numericValue.toFixed(2)}</span>`;
                } else {
                    display.innerHTML = `<span class="text-muted">$${defaultValue}</span>`;
                }

                showNotification('Цена обновлена', 'success');
            } catch (error) {
                showNotification('Ошибка: ' + error.message, 'error');
            } finally {
                // Cleanup
                input.remove();
                cell.querySelector('.price-display').classList.remove('d-none');
                cell.classList.remove('editing', 'saving');
            }
        }

        function handlePriceKeydown(event, cell, siteId, field) {
            const input = cell.querySelector('.price-input');

            if (event.key === 'Enter') {
                event.preventDefault();
                savePriceEdit(cell, siteId, field);
            } else if (event.key === 'Escape') {
                // Cancel edit
                if (input) input.remove();
                cell.querySelector('.price-display').classList.remove('d-none');
                cell.classList.remove('editing');
            } else if (event.key === 'Delete' && event.ctrlKey) {
                // Ctrl+Delete: полностью очистить поле (сброс к дефолтной цене)
                event.preventDefault();
                if (input) {
                    input.value = '';
                    input.select();
                }
            }
        }

        function showBulkPriceModal(field) {
            currentBulkField = field;

            const count = selectedSiteIds.size;
            if (count === 0) {
                showNotification('Выберите сайты для изменения', 'warning');
                return;
            }

            // Set modal content
            const fieldName = field === 'price_link' ? 'цену за ссылку (Main)' : 'цену за гест-пост (GP)';
            document.getElementById('bulkPriceFieldName').textContent = fieldName;
            document.getElementById('bulkPriceCount').textContent = count;
            document.getElementById('bulkPriceValue').value = '';

            // Open modal
            const modal = new bootstrap.Modal(document.getElementById('bulkPriceModal'));
            modal.show();
        }

        async function applyBulkPrice() {
            const value = document.getElementById('bulkPriceValue').value.trim();
            const numericValue = value === '' ? null : parseFloat(value);

            // Validation - минимальная цена $5.00, шаг $0.10
            if (numericValue !== null && (isNaN(numericValue) || numericValue < 5)) {
                showNotification('Минимальная цена: $5.00, шаг $0.10', 'error');
                return;
            }

            const count = selectedSiteIds.size;
            const fieldName = currentBulkField === 'price_link' ? 'ссылку' : 'гест-пост';
            const priceText = numericValue !== null ? `$${numericValue.toFixed(2)}` : 'дефолтную';

            // Confirmation
            if (!confirm(`Изменить цену за ${fieldName} для ${count} сайтов на ${priceText}?`)) {
                return;
            }

            // Close modal
            bootstrap.Modal.getInstance(document.getElementById('bulkPriceModal')).hide();

            // Process in chunks of 10
            const siteIds = Array.from(selectedSiteIds);
            const CHUNK_SIZE = 10;
            let successful = 0;
            let failed = 0;

            for (let i = 0; i < siteIds.length; i += CHUNK_SIZE) {
                const chunk = siteIds.slice(i, i + CHUNK_SIZE);
                const data = {};
                data[currentBulkField] = numericValue;

                const results = await Promise.allSettled(
                    chunk.map(siteId => SitesAPI.update(siteId, data))
                );

                results.forEach((result, idx) => {
                    if (result.status === 'fulfilled') {
                        successful++;
                        const site = window.sites.find(s => s.id === chunk[idx]);
                        if (site) site[currentBulkField] = numericValue;
                    } else {
                        failed++;
                    }
                });

                // Show progress
                showNotification(`Обновлено ${successful} из ${siteIds.length}...`, 'info');
            }

            // Final notification
            if (failed === 0) {
                showNotification(`✅ Цены обновлены для всех ${successful} сайтов`, 'success');
            } else {
                showNotification(`⚠️ Обновлено: ${successful}, ошибок: ${failed}`, 'warning');
            }

            // Reload and clear
            await loadSites();
            clearBulkSelection();
        }

        // ===== END PRICE EDITING FUNCTIONS =====

        document.addEventListener('DOMContentLoaded', async () => {
            modal = new bootstrap.Modal(document.getElementById('siteModal'));
            exportModal = new bootstrap.Modal(document.getElementById('exportModal'));

            // Initialize Bootstrap tooltips
            const tooltipTriggerList = document.querySelectorAll('[data-bs-toggle="tooltip"]');
            tooltipTriggerList.forEach(el => new bootstrap.Tooltip(el));

            // Load saved limit preference
            const savedLimit = parseInt(localStorage.getItem('sitesPageLimit')) || 100;
            currentLimit = savedLimit;
            document.getElementById('limitSelect').value = savedLimit;

            await loadSites();
            await loadActiveTokens(); // Load active registration tokens on page load
            await loadAllSitesForStats(); // Load ALL sites for accurate stats calculation

            // Show admin-only fields if user is admin
            if (isAdmin()) {
                document.querySelectorAll('.admin-only-field').forEach(el => {
                    el.style.display = '';
                });
            }

            // Event listeners
            document.getElementById('searchInput').addEventListener('input', debounce(() => {
                loadSites(1, currentLimit);
            }, 500));

            // Add filter event listeners
            document.getElementById('allowArticlesFilter').addEventListener('change', applyClientFilters);
            document.getElementById('isPublicFilter').addEventListener('change', applyClientFilters);
            document.getElementById('availableForPurchaseFilter').addEventListener('change', applyClientFilters);

            // limitSelect теперь использует onchange="changeItemsPerPage()" в HTML

            // Event delegation is now handled via onclick in HTML template
            // No need for addEventListener since onclick is directly on <td> elements

            // Event listeners for bulk price buttons
            document.querySelectorAll('.bulk-price-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    showBulkPriceModal(btn.dataset.field);
                });
            });

            // Event listener for apply bulk price button
            const applyBtn = document.getElementById('applyBulkPriceBtn');
            if (applyBtn) {
                applyBtn.addEventListener('click', applyBulkPrice);
            }
        });

        async function loadSites(page = 1, limit = currentLimit) {
            try {
                currentPage = page;
                currentLimit = limit;

                const response = await SitesAPI.getAll(page, limit);
                window.sites = response.data || [];  // CRITICAL: Must assign to window.sites for global access
                window.allSites = [...window.sites];  // Store original backup for filtering
                totalSites = response.pagination?.total || 0;
                totalPages = response.pagination?.pages || 0;

                // Apply filters if any are active
                applyClientFilters();

                updatePaginationControls();
                updateSitesCount();
            } catch (error) {
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        function applyClientFilters() {
            const allowArticles = document.getElementById('allowArticlesFilter').value;
            const isPublic = document.getElementById('isPublicFilter').value;
            const availableForPurchase = document.getElementById('availableForPurchaseFilter').value;

            // Store original sites if not already stored
            if (!window.allSites) {
                window.allSites = [...window.sites];
            }

            // Filter the sites array
            const filteredSites = window.allSites.filter(site => {
                // Allow articles filter
                if (allowArticles !== '') {
                    const allowArticlesMatch = site.allow_articles === (allowArticles === 'true');
                    if (!allowArticlesMatch) return false;
                }

                // Is public filter
                if (isPublic !== '') {
                    const isPublicMatch = site.is_public === (isPublic === 'true');
                    if (!isPublicMatch) return false;
                }

                // Available for purchase filter
                if (availableForPurchase !== '') {
                    const availableMatch = site.available_for_purchase === (availableForPurchase === 'true');
                    if (!availableMatch) return false;
                }

                return true;
            });

            // Update window.sites with filtered results
            window.sites = filteredSites;

            // Re-render table
            displaySites();

            // Update total count display - use totalSites (from API) not allSites.length (current page only)
            updateFilteredCount(filteredSites.length, totalSites);

            // Update filter button state
            updateFiltersButtonState();
        }

        function updateFilteredCount(filtered, total) {
            // Use existing sitesCount/sitesTotal elements instead of separate filterInfo
            const sitesCount = document.getElementById('sitesCount');
            const sitesTotal = document.getElementById('sitesTotal');

            if (sitesCount && sitesTotal) {
                sitesCount.textContent = filtered;
                sitesTotal.textContent = total;
            }
        }

        function resetFilters() {
            document.getElementById('allowArticlesFilter').value = '';
            document.getElementById('isPublicFilter').value = '';
            document.getElementById('availableForPurchaseFilter').value = '';

            // Restore original sites
            if (window.allSites) {
                window.sites = [...window.allSites];
            }

            displaySites();
            // Update counter to show all sites - use totalSites from API pagination
            updateFilteredCount(window.sites.length, totalSites);

            // Update filter button state
            updateFiltersButtonState();
        }

        // Filters panel toggle
        function toggleFiltersPanel() {
            const panel = document.getElementById('filtersPanel');
            panel.classList.toggle('show');
        }

        // Update filters button state (show badge if filters active)
        function updateFiltersButtonState() {
            const allowArticles = document.getElementById('allowArticlesFilter').value;
            const isPublic = document.getElementById('isPublicFilter').value;
            const availableForPurchase = document.getElementById('availableForPurchaseFilter').value;

            let activeCount = 0;
            if (allowArticles !== '') activeCount++;
            if (isPublic !== '') activeCount++;
            if (availableForPurchase !== '') activeCount++;

            const badge = document.getElementById('activeFiltersCount');
            const btn = document.getElementById('filtersBtn');

            if (activeCount > 0) {
                badge.textContent = activeCount;
                badge.style.display = 'inline';
                btn.classList.add('active');
            } else {
                badge.style.display = 'none';
                btn.classList.remove('active');
            }
        }

        // Close filters panel when clicking outside
        document.addEventListener('click', function(e) {
            const panel = document.getElementById('filtersPanel');
            const btn = document.getElementById('filtersBtn');
            if (panel && !panel.contains(e.target) && !btn.contains(e.target)) {
                panel.classList.remove('show');
            }
        });

        // Stats calculation - загружаем ВСЕ сайты для корректной статистики
        let allSitesForStats = null;

        async function loadAllSitesForStats() {
            try {
                // Загружаем ВСЕ сайты (limit=5000) для корректной статистики
                const response = await SitesAPI.getAll(1, 5000);
                allSitesForStats = response.data || [];
                updateStatsCards();
            } catch (error) {
                console.error('Failed to load stats:', error);
            }
        }

        function calculateAvgDR() {
            const sites = allSitesForStats || [];
            if (sites.length === 0) return 0;
            const sitesWithDR = sites.filter(s => s.dr > 0);
            if (sitesWithDR.length === 0) return 0;
            return Math.round(sitesWithDR.reduce((sum, s) => sum + (parseFloat(s.dr) || 0), 0) / sitesWithDR.length);
        }

        function calculateAvgRD() {
            const sites = allSitesForStats || [];
            if (sites.length === 0) return 0;
            const sitesWithRD = sites.filter(s => s.ref_domains > 0);
            if (sitesWithRD.length === 0) return 0;
            return Math.round(sitesWithRD.reduce((sum, s) => sum + (parseFloat(s.ref_domains) || 0), 0) / sitesWithRD.length);
        }

        function updateStatsCards() {
            const sites = allSitesForStats || [];

            // Total sites
            document.getElementById('statTotalSites').textContent = sites.length;

            // Active sites (available_for_purchase = true)
            const activeSites = sites.filter(s => s.available_for_purchase === true);
            document.getElementById('statActiveSites').textContent = activeSites.length;

            // Average DR
            document.getElementById('statAvgDR').textContent = calculateAvgDR();

            // Average RD
            document.getElementById('statAvgRD').textContent = calculateAvgRD().toLocaleString();
        }

        // Sorting state
        let currentSortField = null;
        let currentSortDirection = 'asc';

        function sortTable(field) {
            // Toggle direction if clicking same column
            if (currentSortField === field) {
                currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
            } else {
                currentSortField = field;
                currentSortDirection = 'asc';
            }

            // Sort the sites array
            window.sites.sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];

                // Special handling for price fields (price_link and price_article)
                if (field === 'price_link' || field === 'price_article') {
                    // For non-public sites, use 0 for sorting (they show "—")
                    if (!a.is_public) {
                        aVal = 0;
                    } else {
                        // For public sites, use actual value or default
                        const defaultPrice = field === 'price_link' ? 25 : 15;
                        aVal = (a[field] !== null && a[field] !== undefined) ? parseFloat(a[field]) : defaultPrice;
                    }

                    if (!b.is_public) {
                        bVal = 0;
                    } else {
                        const defaultPrice = field === 'price_link' ? 25 : 15;
                        bVal = (b[field] !== null && b[field] !== undefined) ? parseFloat(b[field]) : defaultPrice;
                    }
                }
                // Special handling for site_name - clean it before comparing
                else if (field === 'site_name') {
                    aVal = (aVal || '').replace(/^https?:\/\//, '').replace(/\/$/, '').toLowerCase();
                    bVal = (bVal || '').replace(/^https?:\/\//, '').replace(/\/$/, '').toLowerCase();
                }
                // Numeric fields
                else if (['dr', 'da', 'tf', 'cf', 'ref_domains', 'rd_main', 'norm', 'keywords', 'traffic'].includes(field)) {
                    aVal = parseFloat(aVal) || 0;
                    bVal = parseFloat(bVal) || 0;
                }
                // String comparison for GEO
                else if (field === 'geo') {
                    aVal = String(aVal || '').toLowerCase();
                    bVal = String(bVal || '').toLowerCase();
                }
                else {
                    // Handle null/undefined values for other fields
                    if (aVal === null || aVal === undefined) aVal = '';
                    if (bVal === null || bVal === undefined) bVal = '';
                }

                // Compare
                let comparison = 0;
                if (aVal > bVal) comparison = 1;
                if (aVal < bVal) comparison = -1;

                return currentSortDirection === 'asc' ? comparison : -comparison;
            });

            // Update sort indicators
            updateSortIndicators(field);

            // Re-render table
            displaySites();
        }

        function updateSortIndicators(field) {
            // Clear all indicators
            const allFields = ['site_name', 'price_link', 'price_article', 'dr', 'da', 'tf', 'cf', 'ref_domains', 'rd_main', 'norm', 'keywords', 'traffic', 'geo'];
            allFields.forEach(f => {
                const indicator = document.getElementById(`sort-${f}`);
                if (indicator) indicator.innerHTML = '';
            });

            // Set current indicator
            const indicator = document.getElementById(`sort-${field}`);
            if (indicator) {
                indicator.innerHTML = currentSortDirection === 'asc'
                    ? '<i class="bi bi-arrow-up"></i>'
                    : '<i class="bi bi-arrow-down"></i>';
            }
        }

        function displaySites() {
            const tbody = document.getElementById('sitesTableBody');
            tbody.innerHTML = window.sites.map(s => {
                const siteType = s.site_type || 'wordpress';
                const typeBadge = siteType === 'wordpress'
                    ? '<span class="badge bg-primary" style="font-size: 0.7rem;"><i class="bi bi-wordpress"></i> WP</span>'
                    : '<span class="badge bg-success" style="font-size: 0.7rem;"><i class="bi bi-filetype-php"></i> PHP</span>';

                // Row background color based on status
                let rowClass = '';
                if (s.available_for_purchase === false) {
                    rowClass = 'table-danger';
                }

                // Calculate usage percentages for progress bars
                const linksUsed = s.used_links || 0;
                const linksMax = s.max_links || 0;
                const linksPercent = linksMax > 0 ? (linksUsed / linksMax * 100) : 0;
                const linksColor = linksPercent >= 90 ? 'danger' : linksPercent >= 70 ? 'warning' : 'success';

                const articlesUsed = s.used_articles || 0;
                const articlesMax = s.max_articles || 0;
                const articlesPercent = articlesMax > 0 ? (articlesUsed / articlesMax * 100) : 0;
                const articlesColor = articlesPercent >= 90 ? 'danger' : articlesPercent >= 70 ? 'warning' : 'success';

                // DR value with color coding
                const drValue = s.dr || 0;
                const drClass = drValue >= 50 ? 'text-success fw-bold' : drValue >= 20 ? 'text-primary' : 'text-muted';

                // DA value with color coding
                const daValue = s.da || 0;
                const daClass = daValue >= 50 ? 'text-success fw-bold' : daValue >= 20 ? 'text-primary' : 'text-muted';

                // TF value with color coding
                const tfValue = s.tf || 0;
                const tfClass = tfValue >= 50 ? 'text-success fw-bold' : tfValue >= 20 ? 'text-primary' : 'text-muted';

                // CF value with color coding
                const cfValue = s.cf || 0;
                const cfClass = cfValue >= 50 ? 'text-success fw-bold' : cfValue >= 20 ? 'text-primary' : 'text-muted';

                // Ref Domains, RD Main, Norm, Keywords, Traffic values
                const refDomainsValue = s.ref_domains || 0;
                const rdMainValue = s.rd_main || 0;
                const normValue = s.norm || 0;
                const keywordsValue = s.keywords || 0;
                const trafficValue = s.traffic || 0;

                // GEO value
                const geoValue = s.geo || 'EN';

                // Clean site URL - remove https:// and trailing slash for display
                const displayUrl = (s.site_url || s.site_name || '').replace(/^https?:\/\//, '').replace(/\/$/, '');

                return `
                <tr class="${rowClass}" data-site-id="${s.id}" onclick="toggleRowSelection(event, ${s.id})" style="cursor: pointer;">
                    <td class="text-center" onclick="event.stopPropagation();">
                        <input type="checkbox" class="form-check-input site-checkbox" data-site-id="${s.id}" onchange="updateBulkSelection()">
                    </td>
                    <td style="min-width: 200px;">
                        <a href="${escapeHtml(s.site_url)}" target="_blank" class="text-decoration-none" title="${escapeHtml(s.site_url)}">
                            <span class="fw-semibold text-primary">${escapeHtml(displayUrl)}</span>
                        </a>
                    </td>
                    <td class="text-center ${s.is_public ? 'price-cell' : ''}"
                        ${s.is_public ? `
                            data-site-id="${s.id}"
                            data-field="price_link"
                            data-default="25.00"
                            onclick="enablePriceEdit(this, ${s.id}, 'price_link')"
                        ` : ''}
                        style="${!s.is_public ? 'cursor: default;' : ''}">
                        <span class="price-display">
                            ${!s.is_public
                                ? '<span class="text-muted">—</span>'
                                : s.price_link !== null && s.price_link !== undefined
                                    ? `<span class="text-success">$${parseFloat(s.price_link).toFixed(2)}</span>`
                                    : '<span class="text-muted">$25.00</span>'}
                        </span>
                    </td>
                    <td class="text-center ${s.is_public ? 'price-cell' : ''}"
                        ${s.is_public ? `
                            data-site-id="${s.id}"
                            data-field="price_article"
                            data-default="15.00"
                            onclick="enablePriceEdit(this, ${s.id}, 'price_article')"
                        ` : ''}
                        style="${!s.is_public ? 'cursor: default;' : ''}">
                        <span class="price-display">
                            ${!s.is_public
                                ? '<span class="text-muted">—</span>'
                                : s.price_article !== null && s.price_article !== undefined
                                    ? `<span class="text-success">$${parseFloat(s.price_article).toFixed(2)}</span>`
                                    : '<span class="text-muted">$15.00</span>'}
                        </span>
                    </td>
                    <td class="text-center seo-metric-td ${drClass}">${drValue}</td>
                    <td class="text-center seo-metric-td ${daClass}">${daValue}</td>
                    <td class="text-center seo-metric-td ${tfClass}">${tfValue}</td>
                    <td class="text-center seo-metric-td ${cfClass}">${cfValue}</td>
                    <td class="text-center seo-metric-td text-muted">${refDomainsValue}</td>
                    <td class="text-center seo-metric-td text-muted">${rdMainValue}</td>
                    <td class="text-center seo-metric-td text-muted">${normValue}</td>
                    <td class="text-center seo-metric-td text-muted">${keywordsValue}</td>
                    <td class="text-center seo-metric-td text-muted">${trafficValue}</td>
                    <td class="text-center text-muted">${geoValue}</td>
                    <td class="text-center">
                        ${getStatusBadge(s.moderation_status)}
                    </td>
                    <td class="text-center">
                        ${typeBadge}
                    </td>
                    <td>
                        <a href="${escapeHtml(s.site_url)}" target="_blank" class="btn btn-sm btn-primary" title="${escapeHtml(s.site_url)}">
                            <i class="bi bi-box-arrow-up-right"></i>
                        </a>
                    </td>
                    <td>
                        <div class="text-center fw-semibold mb-1">${linksUsed} / ${linksMax}</div>
                        <div class="progress" style="height: 6px;">
                            <div class="progress-bar bg-${linksColor}" role="progressbar"
                                 style="width: ${linksPercent}%"
                                 aria-valuenow="${linksUsed}"
                                 aria-valuemin="0"
                                 aria-valuemax="${linksMax}"></div>
                        </div>
                    </td>
                    <td>
                        ${siteType === 'wordpress' ? `
                            <div class="text-center fw-semibold mb-1">${articlesUsed} / ${articlesMax}</div>
                            <div class="progress" style="height: 6px;">
                                <div class="progress-bar bg-${articlesColor}" role="progressbar"
                                     style="width: ${articlesPercent}%"
                                     aria-valuenow="${articlesUsed}"
                                     aria-valuemin="0"
                                     aria-valuemax="${articlesMax}"></div>
                            </div>
                        ` : '<span class="text-muted">N/A</span>'}
                    </td>
                    <td class="text-center">
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="allowArticles_${s.id}"
                                   ${(siteType === 'wordpress' && s.allow_articles !== false) ? 'checked' : ''}
                                   ${siteType !== 'wordpress' ? 'disabled' : ''}
                                   onchange="toggleSiteField(${s.id}, 'allow_articles', this.checked)">
                        </div>
                    </td>
                    <td class="text-center is-public-cell">
                        ${isAdmin() ? `
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="isPublic_${s.id}"
                                   ${s.is_public === true ? 'checked' : ''}
                                   onchange="toggleSiteField(${s.id}, 'is_public', this.checked)">
                        </div>
                        ` : `
                        <span class="badge ${s.is_public === true ? 'bg-success' : 'bg-secondary'}">${s.is_public === true ? 'Да' : 'Нет'}</span>
                        `}
                    </td>
                    <td class="text-center">
                        <div class="form-check form-switch d-inline-block">
                            <input class="form-check-input" type="checkbox" role="switch"
                                   id="available_${s.id}"
                                   ${s.available_for_purchase !== false ? 'checked' : ''}
                                   onchange="toggleSiteField(${s.id}, 'available_for_purchase', this.checked)">
                        </div>
                    </td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn action-edit" onclick="editSite(${s.id})" title="Настройки">
                                <i class="bi bi-gear"></i>
                            </button>
                            <button class="action-btn action-delete" onclick="deleteSite(${s.id})" title="Удалить">
                                <i class="bi bi-trash3"></i>
                            </button>
                        </div>
                    </td>
                </tr>
                `;
            }).join('');
        }

        function updatePaginationControls() {
            const pageNumbers = document.getElementById('pageNumbers');
            const prevBtn = document.getElementById('prevPageBtn');
            const nextBtn = document.getElementById('nextPageBtn');
            const paginationInfo = document.getElementById('paginationInfo');
            const paginationWrapper = document.getElementById('paginationWrapper');

            // Скрыть пагинацию если только 1 страница
            if (totalPages <= 1) {
                if (paginationWrapper) {
                    paginationWrapper.style.display = totalSites > 0 ? 'flex' : 'none';
                }
                if (pageNumbers) pageNumbers.innerHTML = '';
                if (prevBtn) prevBtn.disabled = true;
                if (nextBtn) nextBtn.disabled = true;
            } else {
                if (paginationWrapper) paginationWrapper.style.display = 'flex';
            }

            // Обновить информацию о показанных записях
            const startItem = totalSites > 0 ? (currentPage - 1) * currentLimit + 1 : 0;
            const endItem = Math.min(currentPage * currentLimit, totalSites);
            if (paginationInfo) {
                paginationInfo.textContent = `Показано ${startItem}–${endItem} из ${totalSites}`;
            }

            // Обновить кнопки prev/next
            if (prevBtn) prevBtn.disabled = currentPage <= 1;
            if (nextBtn) nextBtn.disabled = currentPage >= totalPages;

            // Генерация номеров страниц
            if (!pageNumbers || totalPages <= 1) return;

            let html = '';
            const maxButtons = 5;
            let startPage = Math.max(1, currentPage - 2);
            let endPage = Math.min(totalPages, startPage + maxButtons - 1);

            if (endPage - startPage < maxButtons - 1) {
                startPage = Math.max(1, endPage - maxButtons + 1);
            }

            // First page
            if (startPage > 1) {
                html += `<button class="pagination-btn" onclick="changePage(1)">1</button>`;
                if (startPage > 2) {
                    html += `<span style="color: #6b7280;">...</span>`;
                }
            }

            // Page buttons
            for (let i = startPage; i <= endPage; i++) {
                html += `<button class="pagination-btn ${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>`;
            }

            // Last page
            if (endPage < totalPages) {
                if (endPage < totalPages - 1) {
                    html += `<span style="color: #6b7280;">...</span>`;
                }
                html += `<button class="pagination-btn" onclick="changePage(${totalPages})">${totalPages}</button>`;
            }

            pageNumbers.innerHTML = html;
        }

        // Новые функции пагинации в стиле dashboard
        function changeItemsPerPage(value) {
            const newLimit = parseInt(value);
            localStorage.setItem('sitesPageLimit', newLimit);
            currentLimit = newLimit;
            loadSites(1, newLimit);
        }

        function changePage(page) {
            if (page < 1 || page > totalPages) return;
            loadSites(page, currentLimit);
        }

        // Функция обновления счетчика (для совместимости с updateFilteredCount)
        function updateSitesCount() {
            // Счетчик теперь обновляется в updatePaginationControls через paginationInfo
            // Эта функция оставлена для обратной совместимости
        }

        // Toggle site type fields visibility
        function toggleSiteTypeFields() {
            const siteType = document.querySelector('input[name="siteType"]:checked').value;
            const isWordPress = siteType === 'wordpress';

            // Toggle fields visibility
            document.getElementById('maxArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('allowArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('priceArticleField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('wordpressPluginInfo').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('staticWidgetInfo').style.display = isWordPress ? 'none' : 'block';

            // Toggle hints
            document.getElementById('typeHintWordPress').style.display = isWordPress ? 'inline' : 'none';
            document.getElementById('typeHintStatic').style.display = isWordPress ? 'none' : 'inline';

            // Update API key field
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyRequired = document.getElementById('apiKeyRequired');
            const apiKeyAutoNote = document.getElementById('apiKeyAutoNote');
            const apiKeyHintText = document.getElementById('apiKeyHintText');

            if (isWordPress) {
                apiKeyRequired.style.display = 'inline';
                apiKeyAutoNote.style.display = 'none';
                apiKeyHintText.textContent = 'Установите плагин Link Manager на WordPress и скопируйте токен из настроек';
                apiKeyInput.setAttribute('required', 'required');
            } else {
                apiKeyRequired.style.display = 'none';
                apiKeyAutoNote.style.display = 'inline';
                apiKeyHintText.textContent = 'API ключ генерируется автоматически при создании сайта';
                apiKeyInput.removeAttribute('required');
            }

            // Set max_articles to 0 for static PHP sites
            if (!isWordPress) {
                document.getElementById('maxArticles').value = '0';
            }
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Add Site';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteTypeWordPress').checked = true; // Default to WordPress
            document.getElementById('maxLinks').value = '10';
            document.getElementById('maxArticles').value = '10';
            document.getElementById('allowArticles').checked = true; // Default: allow articles
            document.getElementById('availableForPurchase').checked = true; // Default: available for purchase

            // Clear price fields
            document.getElementById('priceLink').value = '';
            document.getElementById('priceArticle').value = '';

            // Enable API key input for new sites
            document.getElementById('apiKey').removeAttribute('readonly');

            // Hide cooldown warning and enable limits fields for new sites
            document.getElementById('limitsCooldownWarning').style.display = 'none';
            document.getElementById('maxLinks').removeAttribute('readonly');
            document.getElementById('maxArticles').removeAttribute('readonly');

            toggleSiteTypeFields(); // Initialize field visibility
            modal.show();
        }

        function editSite(id) {
            const site = window.sites.find(s => s.id === id);
            if (!site) return;

            document.getElementById('modalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.site_name;
            document.getElementById('siteUrl').value = site.site_url;
            document.getElementById('apiKey').value = site.api_key || '';
            document.getElementById('maxLinks').value = site.max_links || 10;
            document.getElementById('maxArticles').value = site.max_articles || 10;

            // Store original values for cooldown check
            window.editingOriginalLimits = {
                max_links: site.max_links || 10,
                max_articles: site.max_articles || 10
            };

            // Handle 6-month cooldown for limits (non-admin only)
            const currentUser = getCurrentUser();
            const isAdmin = currentUser && currentUser.role === 'admin';
            const cooldownWarning = document.getElementById('limitsCooldownWarning');
            const cooldownText = document.getElementById('limitsCooldownText');
            const maxLinksInput = document.getElementById('maxLinks');
            const maxArticlesInput = document.getElementById('maxArticles');

            // Reset fields to editable
            maxLinksInput.removeAttribute('readonly');
            maxArticlesInput.removeAttribute('readonly');
            cooldownWarning.style.display = 'none';

            if (!isAdmin && site.limits_changed_at) {
                const cooldownEndDate = new Date(site.limits_changed_at);
                cooldownEndDate.setMonth(cooldownEndDate.getMonth() + 6);

                if (new Date() < cooldownEndDate) {
                    // Cooldown is active
                    const daysLeft = Math.ceil((cooldownEndDate - new Date()) / (1000 * 60 * 60 * 24));
                    cooldownText.textContent = `Вы сможете изменить Links/Articles через ${daysLeft} дн. (${cooldownEndDate.toLocaleDateString('ru-RU')})`;
                    cooldownWarning.style.display = 'block';
                    maxLinksInput.setAttribute('readonly', 'readonly');
                    maxArticlesInput.setAttribute('readonly', 'readonly');
                }
            }

            // Set allow_articles checkbox (default to true if not set)
            document.getElementById('allowArticles').checked = site.allow_articles !== false;

            // Set is_public checkbox (default to false if not set)
            document.getElementById('isPublic').checked = site.is_public === true;

            // Set available_for_purchase checkbox (default to true if not set)
            document.getElementById('availableForPurchase').checked = site.available_for_purchase !== false;

            // Populate price fields (show empty if NULL/default)
            document.getElementById('priceLink').value = site.price_link !== null && site.price_link !== undefined ? site.price_link : '';
            document.getElementById('priceArticle').value = site.price_article !== null && site.price_article !== undefined ? site.price_article : '';

            // Make API key readonly when editing
            document.getElementById('apiKey').setAttribute('readonly', 'readonly');

            // Set site type (default to wordpress if not set)
            const siteType = site.site_type || 'wordpress';
            if (siteType === 'static_php') {
                document.getElementById('siteTypeStatic').checked = true;
            } else {
                document.getElementById('siteTypeWordPress').checked = true;
            }
            toggleSiteTypeFields(); // Update field visibility

            modal.show();
        }

        async function saveSite() {
            const id = document.getElementById('siteId').value;
            const siteType = document.querySelector('input[name="siteType"]:checked').value;

            const data = {
                site_name: document.getElementById('siteName').value,
                site_url: document.getElementById('siteUrl').value,
                site_type: siteType,
                max_links: parseInt(document.getElementById('maxLinks').value),
                max_articles: parseInt(document.getElementById('maxArticles').value)
            };

            // Only include API key and allow_articles for WordPress sites
            if (siteType === 'wordpress') {
                data.api_key = document.getElementById('apiKey').value;
                data.allow_articles = document.getElementById('allowArticles').checked;
            } else {
                // Static sites always have allow_articles = false
                data.allow_articles = false;
            }

            // Add is_public checkbox value (applies to all site types)
            data.is_public = document.getElementById('isPublic').checked;

            // Add available_for_purchase checkbox value (applies to all site types)
            data.available_for_purchase = document.getElementById('availableForPurchase').checked;

            // Add price fields (optional - null if empty)
            const priceLinkValue = document.getElementById('priceLink').value.trim();
            const priceArticleValue = document.getElementById('priceArticle').value.trim();

            data.price_link = priceLinkValue !== '' ? parseFloat(priceLinkValue) : null;
            data.price_article = priceArticleValue !== '' ? parseFloat(priceArticleValue) : null;

            // Validate prices are positive if provided
            if (data.price_link !== null && data.price_link < 0) {
                showNotification('Цена за ссылку должна быть положительным числом', 'error');
                return;
            }

            if (data.price_article !== null && data.price_article < 0) {
                showNotification('Цена за гест-пост должна быть положительным числом', 'error');
                return;
            }

            try {
                if (id) {
                    await SitesAPI.update(id, data);
                    showNotification('Site updated successfully');
                } else {
                    await SitesAPI.create(data);
                    showNotification('Site created successfully');
                }
                modal.hide();
                await loadSites();
            } catch (error) {
                showNotification('Failed to save site: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            try {
                // Get placements for this site to show warning
                const response = await PlacementsAPI.getBySite(id);
                const { placements, summary } = response;

                // Build confirmation message
                let message = 'Вы уверены, что хотите удалить этот сайт?';

                if (summary.total > 0) {
                    message = `⚠️ ВНИМАНИЕ: На этом сайте есть ${summary.total} размещени${summary.total === 1 ? 'е' : summary.total < 5 ? 'я' : 'й'}!\n\n`;

                    if (summary.paidCount > 0) {
                        message += `💰 Платных размещений: ${summary.paidCount}\n`;
                        message += `💵 Общая стоимость: $${summary.totalRefund.toFixed(2)}\n\n`;
                        message += `✅ Все размещения будут удалены\n`;
                        message += `✅ Деньги ($${summary.totalRefund.toFixed(2)}) будут возвращены на ваш баланс\n`;
                        message += `✅ Использование ссылок/гест-постов будет восстановлено\n\n`;
                    } else {
                        message += `Все размещения (бесплатные) будут удалены.\n\n`;
                    }

                    message += `Вы уверены, что хотите продолжить?`;
                }

                if (!confirm(message)) return;

                // Delete site with refunds
                const result = await SitesAPI.delete(id);

                // Show success message with refund details
                if (result.refundedCount > 0) {
                    showNotification(
                        `Сайт удалён успешно! Возвращено: $${result.totalRefunded.toFixed(2)} (${result.refundedCount} размещени${result.refundedCount === 1 ? 'е' : result.refundedCount < 5 ? 'я' : 'й'})`,
                        'success'
                    );

                    if (result.tierChanged) {
                        showNotification(
                            `Ваш уровень скидки изменился на "${result.newTier}" из-за уменьшения общих затрат.`,
                            'info'
                        );
                    }
                } else {
                    showNotification('Сайт удалён успешно', 'success');
                }

                await loadSites();
            } catch (error) {
                showNotification('Ошибка при удалении сайта: ' + error.message, 'error');
            }
        }

        function copyApiKey(apiKey, event) {
            event.stopPropagation(); // Prevent card click
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API Key copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy API Key', 'error');
            });
        }

        function copyFieldToClipboard(fieldId) {
            const field = document.getElementById(fieldId);
            const text = field.value;
            if (!text) {
                showNotification('Nothing to copy', 'warning');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        // Bulk Registration Token Functions
        async function generateRegistrationToken() {
            try {
                const label = document.getElementById('tokenLabel').value || 'Registration Token';
                const maxUses = parseInt(document.getElementById('tokenMaxUses').value) || 0;
                const expireDays = parseInt(document.getElementById('tokenExpireDays').value) || 30;

                // Calculate expiry date
                const expiresAt = new Date();
                expiresAt.setDate(expiresAt.getDate() + expireDays);

                const response = await fetch('/api/sites/generate-token', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify({
                        label,
                        max_uses: maxUses,
                        expires_at: expiresAt.toISOString()
                    })
                });

                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.error || 'Failed to generate token');
                }

                const data = await response.json();

                // Clear form
                document.getElementById('tokenLabel').value = '';
                document.getElementById('tokenMaxUses').value = '0';
                document.getElementById('tokenExpireDays').value = '30';

                // Reload tokens list
                await loadActiveTokens();

                showNotification('Токен регистрации создан!', 'success');
            } catch (error) {
                console.error('Generate token error:', error);
                showNotification('Ошибка создания токена: ' + error.message, 'error');
            }
        }

        async function loadActiveTokens() {
            try {
                const response = await fetch('/api/sites/tokens', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Failed to load tokens');
                }

                const data = await response.json();
                displayTokensList(data.data || []);
            } catch (error) {
                console.error('Load tokens error:', error);
                document.getElementById('activeTokensList').innerHTML =
                    '<div class="alert alert-light mb-0"><small class="text-dark">Не удалось загрузить токены</small></div>';
            }
        }

        function displayTokensList(tokens) {
            const container = document.getElementById('activeTokensList');

            if (tokens.length === 0) {
                container.innerHTML = '';
                return;
            }

            const now = new Date();
            const activeTokens = tokens.filter(token => {
                const isExpired = token.expires_at && new Date(token.expires_at) < now;
                const isExhausted = token.max_uses > 0 && token.current_uses >= token.max_uses;
                return !isExpired && !isExhausted;
            });

            if (activeTokens.length === 0) {
                container.innerHTML = `<div class="alert alert-light mb-0"><small class="text-dark">${t('noActiveTokens')}</small></div>`;
                return;
            }

            const lang = typeof getLang === 'function' ? getLang() : 'ru';
            const html = activeTokens.map(token => {
                const maxUsesText = token.max_uses === 0 ? '∞' : token.max_uses;
                const expiryDate = token.expires_at ? new Date(token.expires_at).toLocaleDateString(lang === 'en' ? 'en-US' : 'ru-RU') : t('noExpiry');
                const usagePercent = token.max_uses > 0 ? (token.current_uses / token.max_uses * 100) : 0;
                const usageColor = usagePercent >= 90 ? 'danger' : usagePercent >= 70 ? 'warning' : 'success';

                return `
                    <div class="alert alert-light mb-2">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <div>
                                <strong class="text-dark">${escapeHtml(token.label)}</strong>
                                <div class="small text-muted mt-1">
                                    <i class="bi bi-calendar"></i> ${t('validUntilLabel')} ${expiryDate}
                                    <span class="mx-2">|</span>
                                    <i class="bi bi-bar-chart"></i> ${t('tokenUsed')} ${token.current_uses} / ${maxUsesText}
                                </div>
                                ${token.max_uses > 0 ? `
                                <div class="progress mt-2" style="height: 4px;">
                                    <div class="progress-bar bg-${usageColor}" role="progressbar"
                                         style="width: ${usagePercent}%"
                                         aria-valuenow="${token.current_uses}"
                                         aria-valuemin="0"
                                         aria-valuemax="${token.max_uses}"></div>
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="input-group">
                            <input type="text" class="form-control font-monospace bg-white text-dark"
                                   value="${token.token}" readonly>
                            <button class="btn btn-dark" onclick="copyTokenToClipboard('${token.token}')">
                                <i class="bi bi-clipboard"></i> ${t('copyBtn')}
                            </button>
                            <button class="btn btn-outline-danger" onclick="deleteRegistrationToken(${token.id})" title="${t('deleteToken')}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                        <div class="mt-2 small text-dark">
                            <i class="bi bi-info-circle"></i> ${t('tokenInstruction')}
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = html;
        }

        function copyTokenToClipboard(token) {
            navigator.clipboard.writeText(token).then(() => {
                showNotification(t('tokenCopiedSuccess'), 'success');
            }).catch(err => {
                console.error('Failed to copy token:', err);
                showNotification(t('tokenCopyError'), 'error');
            });
        }

        async function deleteRegistrationToken(tokenId) {
            if (!confirm(t('deleteTokenConfirm'))) {
                return;
            }

            try {
                const response = await fetch(`/api/sites/tokens/${tokenId}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    const data = await response.json();
                    throw new Error(data.error || 'Failed to delete token');
                }

                await loadActiveTokens();
                showNotification(t('tokenDeleted'), 'success');
            } catch (error) {
                console.error('Delete token error:', error);
                showNotification(t('deleteError') + ' ' + error.message, 'error');
            }
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        // Get moderation status badge HTML
        function getStatusBadge(status) {
            switch(status) {
                case 'approved':
                    return `<div class="status-approved"><i class="bi bi-check-circle-fill"></i> ${t('siteStatusActive')}</div>`;
                case 'pending':
                    return `<div class="status-pending"><i class="bi bi-clock"></i> ${t('siteStatusPending')}</div>`;
                case 'rejected':
                    return `<div class="status-rejected"><i class="bi bi-x-circle-fill"></i> ${t('siteStatusRejected')}</div>`;
                default:
                    return '<span class="text-muted">—</span>';
            }
        }

        // ========== Export Functions ==========

        function showExportModal() {
            updateExportPreview();
            exportModal.show();
        }

        function updateExportPreview() {
            const format = document.getElementById('exportFormat').value;
            const preview = document.getElementById('exportPreview');
            const count = document.getElementById('exportCount');

            let content = '';

            switch(format) {
                case 'csv':
                    content = generateCSV();
                    break;
                case 'tsv':
                    content = generateTSV();
                    break;
                case 'plain':
                    content = generatePlainText();
                    break;
                case 'json':
                    content = generateJSON();
                    break;
            }

            preview.value = content;
            count.textContent = window.sites.length;
        }

        function generateCSV() {
            const headers = ['Site Name', 'Site URL', 'DR', 'DA', 'TF', 'CF', 'RD', 'RDm', 'Norm', 'KW', 'Traffic', 'GEO', 'Type', 'API Key', 'Links', 'Articles', 'Allow Articles', 'Public', 'Available'];
            const rows = window.sites.map(s => [
                `"${(s.site_name || '').replace(/"/g, '""')}"`,
                `"${(s.site_url || '').replace(/"/g, '""')}"`,
                s.dr || 0,
                s.da || 0,
                s.tf || 0,
                s.cf || 0,
                s.ref_domains || 0,
                s.rd_main || 0,
                s.norm || 0,
                s.keywords || 0,
                s.traffic || 0,
                s.geo || 'EN',
                s.site_type || 'wordpress',
                s.api_key ? `"${s.api_key.substring(0, 8)}..."` : 'N/A',
                `${s.used_links || 0}/${s.max_links || 0}`,
                `${s.used_articles || 0}/${s.max_articles || 0}`,
                s.allow_articles !== false ? 'Yes' : 'No',
                s.is_public === true ? 'Yes' : 'No',
                s.available_for_purchase !== false ? 'Yes' : 'No'
            ]);

            return [headers.join(','), ...rows.map(r => r.join(','))].join('\n');
        }

        function generateTSV() {
            const headers = ['Site Name', 'Site URL', 'DR', 'DA', 'TF', 'CF', 'RD', 'RDm', 'Norm', 'KW', 'Traffic', 'GEO', 'Type', 'API Key', 'Links', 'Articles', 'Allow Articles', 'Public', 'Available'];
            const rows = window.sites.map(s => [
                s.site_name || '',
                s.site_url || '',
                s.dr || 0,
                s.da || 0,
                s.tf || 0,
                s.cf || 0,
                s.ref_domains || 0,
                s.rd_main || 0,
                s.norm || 0,
                s.keywords || 0,
                s.traffic || 0,
                s.geo || 'EN',
                s.site_type || 'wordpress',
                s.api_key ? `${s.api_key.substring(0, 8)}...` : 'N/A',
                `${s.used_links || 0}/${s.max_links || 0}`,
                `${s.used_articles || 0}/${s.max_articles || 0}`,
                s.allow_articles !== false ? 'Yes' : 'No',
                s.is_public === true ? 'Yes' : 'No',
                s.available_for_purchase !== false ? 'Yes' : 'No'
            ]);

            return [headers.join('\t'), ...rows.map(r => r.join('\t'))].join('\n');
        }

        function generatePlainText() {
            return window.sites.map((s, index) => {
                return `Site #${index + 1}
Name: ${s.site_name || 'N/A'}
URL: ${s.site_url || 'N/A'}
DR: ${s.dr || 0}
DA: ${s.da || 0}
TF: ${s.tf || 0}
CF: ${s.cf || 0}
Ref Domains: ${s.ref_domains || 0}
RD Main: ${s.rd_main || 0}
Norm: ${s.norm || 0}
Keywords: ${s.keywords || 0}
Traffic: ${s.traffic || 0}
GEO: ${s.geo || 'EN'}
Type: ${s.site_type || 'wordpress'}
API Key: ${s.api_key ? `${s.api_key.substring(0, 8)}...` : 'N/A'}
Links: ${s.used_links || 0}/${s.max_links || 0}
Articles: ${s.used_articles || 0}/${s.max_articles || 0}
Allow Articles: ${s.allow_articles !== false ? 'Yes' : 'No'}
Public: ${s.is_public === true ? 'Yes' : 'No'}
Available for Purchase: ${s.available_for_purchase !== false ? 'Yes' : 'No'}
${'='.repeat(50)}`;
            }).join('\n');
        }

        function generateJSON() {
            // Export only essential fields for readability
            const exportData = window.sites.map(s => ({
                site_name: s.site_name,
                site_url: s.site_url,
                dr: s.dr || 0,
                da: s.da || 0,
                tf: s.tf || 0,
                cf: s.cf || 0,
                ref_domains: s.ref_domains || 0,
                rd_main: s.rd_main || 0,
                norm: s.norm || 0,
                keywords: s.keywords || 0,
                traffic: s.traffic || 0,
                geo: s.geo || 'EN',
                site_type: s.site_type || 'wordpress',
                api_key: s.api_key ? `${s.api_key.substring(0, 8)}...` : null,
                links_usage: `${s.used_links || 0}/${s.max_links || 0}`,
                articles_usage: `${s.used_articles || 0}/${s.max_articles || 0}`,
                allow_articles: s.allow_articles !== false,
                is_public: s.is_public === true,
                available_for_purchase: s.available_for_purchase !== false
            }));

            return JSON.stringify(exportData, null, 2);
        }

        function copyExportToClipboard() {
            const content = document.getElementById('exportPreview').value;
            navigator.clipboard.writeText(content).then(() => {
                showNotification('Exported data copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Copy failed:', err);
                showNotification('Failed to copy to clipboard', 'error');
            });
        }

        function downloadExport() {
            const format = document.getElementById('exportFormat').value;
            const content = document.getElementById('exportPreview').value;
            const date = new Date().toISOString().split('T')[0];
            const filename = `sites-export-${date}.${format}`;

            const blob = new Blob([content], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            showNotification(`File "${filename}" downloaded successfully!`, 'success');
        }

        // ========== Bulk Selection & Toggle Functions ==========

        // Состояние выбора
        let selectedSiteIds = new Set();

        // Toggle одного поля сайта
        async function toggleSiteField(siteId, field, value) {
            try {
                const data = {};
                data[field] = value;

                await SitesAPI.update(siteId, data);

                // Обновляем локальные данные
                const site = window.sites.find(s => s.id === siteId);
                if (site) site[field] = value;

                // Обновляем цвет строки
                updateRowStyle(siteId);

                const fieldNames = {
                    'allow_articles': 'Статьи',
                    'is_public': 'Публичность',
                    'available_for_purchase': 'Доступность'
                };
                showNotification(`${fieldNames[field]} ${value ? 'включено' : 'отключено'}`, 'success');
            } catch (error) {
                // Откатываем переключатель
                const fieldId = field === 'allow_articles' ? 'allowArticles' :
                               field === 'is_public' ? 'isPublic' : 'available';
                const checkbox = document.getElementById(`${fieldId}_${siteId}`);
                if (checkbox) checkbox.checked = !value;
                showNotification('Ошибка обновления: ' + error.message, 'error');
            }
        }

        // Обновить стиль строки на основе данных
        function updateRowStyle(siteId) {
            const site = window.sites.find(s => s.id === siteId);
            if (!site) return;

            const row = document.querySelector(`tr[data-site-id="${siteId}"]`);
            if (!row) return;

            row.classList.remove('table-danger');
            if (site.available_for_purchase === false) {
                row.classList.add('table-danger');
            }
        }

        // Выбрать/снять выбор со всех
        function toggleSelectAll() {
            const selectAll = document.getElementById('selectAllSites');
            const checkboxes = document.querySelectorAll('.site-checkbox');

            selectedSiteIds.clear();
            checkboxes.forEach(cb => {
                cb.checked = selectAll.checked;
                if (selectAll.checked) {
                    selectedSiteIds.add(parseInt(cb.dataset.siteId));
                }
            });

            updateBulkActionsBar();
        }

        // Переключить выбор строки при клике
        function toggleRowSelection(event, siteId) {
            // Не переключать если клик был на price-cell (редактирование цены)
            if (event.target.closest('.price-cell')) {
                return;
            }

            const checkbox = document.querySelector(`.site-checkbox[data-site-id="${siteId}"]`);
            if (checkbox) {
                checkbox.checked = !checkbox.checked;
                updateBulkSelection();
            }
        }

        // Обновить состояние выбора
        function updateBulkSelection() {
            selectedSiteIds.clear();
            document.querySelectorAll('.site-checkbox:checked').forEach(cb => {
                selectedSiteIds.add(parseInt(cb.dataset.siteId));
            });

            // Обновить "Select All" чекбокс
            const allCheckboxes = document.querySelectorAll('.site-checkbox');
            const selectAll = document.getElementById('selectAllSites');
            selectAll.checked = allCheckboxes.length > 0 &&
                                selectedSiteIds.size === allCheckboxes.length;
            selectAll.indeterminate = selectedSiteIds.size > 0 &&
                                      selectedSiteIds.size < allCheckboxes.length;

            updateBulkActionsBar();
        }

        // Показать/скрыть панель массового редактирования
        function updateBulkActionsBar() {
            const bar = document.getElementById('bulkActionsBar');
            const count = document.getElementById('selectedCount');

            if (selectedSiteIds.size > 0) {
                bar.classList.remove('d-none');
                count.textContent = selectedSiteIds.size;
            } else {
                bar.classList.add('d-none');
            }
        }

        // Массовое изменение поля
        async function bulkSetField(field, value) {
            if (selectedSiteIds.size === 0) return;

            const fieldNames = {
                'allow_articles': 'Разрешить гест-посты',
                'is_public': 'Публичный',
                'available_for_purchase': 'Доступен для покупки'
            };

            if (!confirm(`Изменить "${fieldNames[field]}" на "${value ? 'Да' : 'Нет'}" для ${selectedSiteIds.size} сайтов?`)) {
                return;
            }

            try {
                let successCount = 0;
                let errorCount = 0;

                for (const siteId of selectedSiteIds) {
                    try {
                        const data = {};
                        data[field] = value;
                        await SitesAPI.update(siteId, data);

                        // Обновляем локальные данные
                        const site = window.sites.find(s => s.id === siteId);
                        if (site) site[field] = value;

                        successCount++;
                    } catch (e) {
                        errorCount++;
                    }
                }

                // Перерисовываем таблицу
                displaySites();
                clearBulkSelection();

                if (errorCount === 0) {
                    showNotification(`Обновлено ${successCount} сайтов`, 'success');
                } else {
                    showNotification(`Обновлено ${successCount}, ошибок: ${errorCount}`, 'warning');
                }
            } catch (error) {
                showNotification('Ошибка массового обновления: ' + error.message, 'error');
            }
        }

        // Очистить выбор
        function clearBulkSelection() {
            selectedSiteIds.clear();
            document.querySelectorAll('.site-checkbox').forEach(cb => cb.checked = false);
            document.getElementById('selectAllSites').checked = false;
            document.getElementById('selectAllSites').indeterminate = false;
            updateBulkActionsBar();
        }
    </script>

    <!-- Bulk Price Update Modal -->
    <div class="modal fade" id="bulkPriceModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Массовое изменение цены</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Изменить <strong id="bulkPriceFieldName"></strong> для <strong id="bulkPriceCount"></strong> выбранных сайтов</p>

                    <div class="mb-3">
                        <label for="bulkPriceValue" class="form-label">Новая цена (USD)</label>
                        <input type="number"
                               class="form-control"
                               id="bulkPriceValue"
                               min="5"
                               step="0.10"
                               placeholder="Минимум $5.00, шаг $0.10">
                        <small class="text-muted">Пустое значение = использовать дефолтную цену</small>
                    </div>

                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i> Изменение будет применено ко всем выбранным сайтам
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
                    <button type="button" class="btn btn-primary" id="applyBulkPriceBtn">Применить</button>
                </div>
            </div>
        </div>
    </div>
</body>
</html>
