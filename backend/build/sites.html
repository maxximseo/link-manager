<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sites - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/dashboard.html">= Link Manager</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item"><a class="nav-link" href="/dashboard.html">Dashboard</a></li>
                    <li class="nav-item"><a class="nav-link" href="/projects.html">Проекты</a></li>
                    <li class="nav-item"><a class="nav-link" href="/placements.html">Размещения</a></li>
                    <li class="nav-item"><a class="nav-link" href="/balance.html">Баланс</a></li>
                    <li class="nav-item"><a class="nav-link active" href="/sites.html">Сайты</a></li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <span class="navbar-text me-3">
                            <i class="bi bi-wallet2"></i> $<span id="navBalance">0.00</span>
                        </span>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#" onclick="logout()">Выход</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>Sites</h1>
            <button class="btn btn-primary" onclick="showCreateModal()">
                <i class="bi bi-plus-circle"></i> Add Site
            </button>
        </div>

        <div class="row mb-3">
            <div class="col-md-6">
                <input type="text" class="form-control" id="searchInput" placeholder="Search sites...">
            </div>
            <div class="col-md-3">
                <select class="form-select" id="statusFilter">
                    <option value="">All Statuses</option>
                    <option value="active">Active</option>
                    <option value="inactive">Inactive</option>
                </select>
            </div>
        </div>

        <div id="sitesList" class="row"></div>
    </div>

    <!-- Create/Edit Modal -->
    <div class="modal fade" id="siteModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="modalTitle">Add Site</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="siteForm">
                        <input type="hidden" id="siteId">

                        <!-- Site Type Selection -->
                        <div class="mb-4">
                            <label class="form-label fw-bold">Тип сайта *</label>
                            <div class="btn-group w-100" role="group">
                                <input type="radio" class="btn-check" name="siteType" id="siteTypeWordPress" value="wordpress" checked onchange="toggleSiteTypeFields()">
                                <label class="btn btn-outline-primary" for="siteTypeWordPress">
                                    <i class="bi bi-wordpress"></i> WordPress
                                </label>

                                <input type="radio" class="btn-check" name="siteType" id="siteTypeStatic" value="static_php" onchange="toggleSiteTypeFields()">
                                <label class="btn btn-outline-success" for="siteTypeStatic">
                                    <i class="bi bi-filetype-php"></i> Статичный PHP
                                </label>
                            </div>
                            <small class="form-text text-muted d-block mt-1">
                                <span id="typeHintWordPress">WordPress с установленным плагином Link Manager</span>
                                <span id="typeHintStatic" style="display:none">Статичный сайт с PHP виджетом (только ссылки)</span>
                            </small>
                        </div>

                        <div class="mb-3">
                            <label for="siteName" class="form-label">Site Name *</label>
                            <input type="text" class="form-control" id="siteName" required>
                        </div>

                        <div class="mb-3">
                            <label for="siteUrl" class="form-label">Site URL *</label>
                            <input type="url" class="form-control" id="siteUrl" required
                                   placeholder="https://example.com">
                        </div>

                        <!-- API Key field (shown for WordPress, auto-generated for static) -->
                        <div id="apiKeyField" class="mb-3">
                            <label for="apiKey" class="form-label">
                                API Token
                                <span id="apiKeyRequired">*</span>
                                <span id="apiKeyAutoNote" style="display:none;" class="badge bg-success ms-2">Auto-generated</span>
                            </label>
                            <div class="input-group">
                                <input type="text" class="form-control font-monospace" id="apiKey"
                                       placeholder="Получите токен из плагина на вашем WordPress сайте">
                                <button class="btn btn-outline-secondary" type="button" onclick="copyFieldToClipboard('apiKey')" id="copyApiKeyBtn">
                                    <i class="bi bi-clipboard"></i> Copy
                                </button>
                            </div>
                            <small class="form-text text-muted" id="apiKeyHint">
                                <i class="bi bi-info-circle"></i> <span id="apiKeyHintText">Установите плагин Link Manager на WordPress и скопируйте токен из настроек</span>
                            </small>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="maxLinks" class="form-label">Max Links *</label>
                                <input type="number" class="form-control" id="maxLinks" required min="0" value="10">
                            </div>
                            <div class="col-md-6 mb-3" id="maxArticlesField">
                                <label for="maxArticles" class="form-label">Max Articles *</label>
                                <input type="number" class="form-control" id="maxArticles" required min="0" value="10">
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="siteStatus" class="form-label">Status</label>
                            <select class="form-select" id="siteStatus">
                                <option value="active">Active</option>
                                <option value="inactive">Inactive</option>
                            </select>
                        </div>

                        <div class="mb-3">
                            <label for="notes" class="form-label">Notes</label>
                            <textarea class="form-control" id="notes" rows="3"></textarea>
                        </div>

                        <!-- WordPress Plugin Info -->
                        <div class="alert alert-info" id="wordpressPluginInfo">
                            <h6><i class="bi bi-wordpress"></i> WordPress Plugin Required</h6>
                            <p class="mb-2">To enable link placement, install the Link Manager plugin on your WordPress site:</p>
                            <a href="/link-manager-widget.zip" download="link-manager-widget.zip" class="btn btn-sm btn-success">
                                <i class="bi bi-download"></i> Download Plugin (ZIP)
                            </a>
                            <small class="d-block mt-2 text-muted">Upload and activate this plugin in your WordPress admin panel</small>
                        </div>

                        <!-- Static PHP Widget Info -->
                        <div class="alert alert-success" id="staticWidgetInfo" style="display:none">
                            <h6><i class="bi bi-filetype-php"></i> PHP Widget для статичных сайтов</h6>
                            <p class="mb-2">Скачайте виджет и установите на ваш PHP сайт:</p>
                            <div class="d-grid gap-2">
                                <a href="/static-widget.zip" download="static-widget.zip" class="btn btn-sm btn-success">
                                    <i class="bi bi-download"></i> Скачать static.php (ZIP)
                                </a>
                            </div>
                            <small class="d-block mt-2">
                                <strong>3 простых шага:</strong><br>
                                1. Разархивируйте ZIP и загрузите <code>static.php</code> в корень сайта<br>
                                2. Добавьте <code>&lt;?php include 'static.php'; ?&gt;</code> в нужное место<br>
                                3. Ссылки появятся автоматически!
                            </small>
                            <div class="alert alert-warning mt-2 mb-0">
                                <small><i class="bi bi-exclamation-triangle"></i> <strong>Важно:</strong> Статичные сайты поддерживают только ссылки, статьи недоступны.</small>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveSite()">Save</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/api.js"></script>
    <script>
        if (!isAuthenticated()) {
            window.location.href = '/index.html';
        }

        let sites = [];
        let modal;

        document.addEventListener('DOMContentLoaded', async () => {
            modal = new bootstrap.Modal(document.getElementById('siteModal'));
            await loadSites();

            document.getElementById('searchInput').addEventListener('input', displaySites);
            document.getElementById('statusFilter').addEventListener('change', displaySites);
        });

        async function loadSites() {
            try {
                sites = await SitesAPI.getAll();
                displaySites();
            } catch (error) {
                showNotification('Failed to load sites: ' + error.message, 'error');
            }
        }

        function displaySites() {
            const search = document.getElementById('searchInput').value.toLowerCase();
            const statusFilter = document.getElementById('statusFilter').value;

            const filtered = sites.filter(s => {
                const matchesSearch = s.site_name.toLowerCase().includes(search) ||
                                     s.site_url.toLowerCase().includes(search);
                const matchesStatus = !statusFilter || s.status === statusFilter;
                return matchesSearch && matchesStatus;
            });

            const list = document.getElementById('sitesList');
            list.innerHTML = filtered.map(s => {
                const siteType = s.site_type || 'wordpress';
                const typeIcon = siteType === 'wordpress' ? 'bi-wordpress' : 'bi-filetype-php';
                const typeBadge = siteType === 'wordpress'
                    ? '<span class="badge bg-primary"><i class="bi bi-wordpress"></i> WordPress</span>'
                    : '<span class="badge bg-success"><i class="bi bi-filetype-php"></i> Static PHP</span>';

                return `
                <div class="col-md-6 col-lg-4 mb-3">
                    <div class="card h-100">
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-start mb-2">
                                <h5 class="card-title mb-0">${escapeHtml(s.site_name)}</h5>
                                ${typeBadge}
                            </div>
                            <p class="card-text">
                                <a href="${escapeHtml(s.site_url)}" target="_blank" class="text-decoration-none">
                                    <i class="bi bi-globe"></i> ${escapeHtml(s.site_url)}
                                </a>
                            </p>
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-link-45deg"></i> Links: ${s.used_links || 0}/${s.max_links || 0}
                                </small>
                            </div>
                            ${siteType === 'wordpress' ? `
                            <div class="mb-2">
                                <small class="text-muted">
                                    <i class="bi bi-file-text"></i> Articles: ${s.used_articles || 0}/${s.max_articles || 0}
                                </small>
                            </div>
                            ` : ''}
                            ${s.api_key ? `
                            <div class="mb-2">
                                <small class="text-muted d-flex align-items-center gap-1">
                                    <i class="bi bi-key"></i>
                                    <span class="font-monospace" style="font-size: 0.75rem;">${s.api_key.substring(0, 20)}...</span>
                                    <button class="btn btn-sm btn-outline-secondary py-0 px-1" style="font-size: 0.7rem; line-height: 1;"
                                            onclick="copyApiKey('${s.api_key}', event)" title="Copy API Key">
                                        <i class="bi bi-clipboard"></i>
                                    </button>
                                </small>
                            </div>
                            ` : ''}
                            <div class="mb-3">
                                <span class="badge bg-${s.status === 'active' ? 'success' : 'secondary'}">
                                    ${escapeHtml(s.status || 'active')}
                                </span>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-sm btn-outline-primary" onclick="editSite(${s.id})">
                                    <i class="bi bi-pencil"></i> Edit
                                </button>
                                <button class="btn btn-sm btn-outline-danger" onclick="deleteSite(${s.id})">
                                    <i class="bi bi-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            }).join('');
        }

        // Toggle site type fields visibility
        function toggleSiteTypeFields() {
            const siteType = document.querySelector('input[name="siteType"]:checked').value;
            const isWordPress = siteType === 'wordpress';

            // Toggle fields visibility
            document.getElementById('maxArticlesField').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('wordpressPluginInfo').style.display = isWordPress ? 'block' : 'none';
            document.getElementById('staticWidgetInfo').style.display = isWordPress ? 'none' : 'block';

            // Toggle hints
            document.getElementById('typeHintWordPress').style.display = isWordPress ? 'inline' : 'none';
            document.getElementById('typeHintStatic').style.display = isWordPress ? 'none' : 'inline';

            // Update API key field
            const apiKeyInput = document.getElementById('apiKey');
            const apiKeyRequired = document.getElementById('apiKeyRequired');
            const apiKeyAutoNote = document.getElementById('apiKeyAutoNote');
            const apiKeyHintText = document.getElementById('apiKeyHintText');

            if (isWordPress) {
                apiKeyRequired.style.display = 'inline';
                apiKeyAutoNote.style.display = 'none';
                apiKeyHintText.textContent = 'Установите плагин Link Manager на WordPress и скопируйте токен из настроек';
                apiKeyInput.setAttribute('required', 'required');
            } else {
                apiKeyRequired.style.display = 'none';
                apiKeyAutoNote.style.display = 'inline';
                apiKeyHintText.textContent = 'API ключ генерируется автоматически при создании сайта';
                apiKeyInput.removeAttribute('required');
            }

            // Set max_articles to 0 for static PHP sites
            if (!isWordPress) {
                document.getElementById('maxArticles').value = '0';
            }
        }

        function showCreateModal() {
            document.getElementById('modalTitle').textContent = 'Add Site';
            document.getElementById('siteForm').reset();
            document.getElementById('siteId').value = '';
            document.getElementById('siteTypeWordPress').checked = true; // Default to WordPress
            document.getElementById('maxLinks').value = '10';
            document.getElementById('maxArticles').value = '10';
            document.getElementById('siteStatus').value = 'active';

            // Enable API key input for new sites
            document.getElementById('apiKey').removeAttribute('readonly');

            toggleSiteTypeFields(); // Initialize field visibility
            modal.show();
        }

        function editSite(id) {
            const site = sites.find(s => s.id === id);
            if (!site) return;

            document.getElementById('modalTitle').textContent = 'Edit Site';
            document.getElementById('siteId').value = site.id;
            document.getElementById('siteName').value = site.site_name;
            document.getElementById('siteUrl').value = site.site_url;
            document.getElementById('apiKey').value = site.api_key || '';
            document.getElementById('maxLinks').value = site.max_links || 10;
            document.getElementById('maxArticles').value = site.max_articles || 10;
            document.getElementById('siteStatus').value = site.status || 'active';
            document.getElementById('notes').value = site.notes || '';

            // Make API key readonly when editing
            document.getElementById('apiKey').setAttribute('readonly', 'readonly');

            // Set site type (default to wordpress if not set)
            const siteType = site.site_type || 'wordpress';
            if (siteType === 'static_php') {
                document.getElementById('siteTypeStatic').checked = true;
            } else {
                document.getElementById('siteTypeWordPress').checked = true;
            }
            toggleSiteTypeFields(); // Update field visibility

            modal.show();
        }

        async function saveSite() {
            const id = document.getElementById('siteId').value;
            const siteType = document.querySelector('input[name="siteType"]:checked').value;

            const data = {
                site_name: document.getElementById('siteName').value,
                site_url: document.getElementById('siteUrl').value,
                site_type: siteType,
                max_links: parseInt(document.getElementById('maxLinks').value),
                max_articles: parseInt(document.getElementById('maxArticles').value),
                status: document.getElementById('siteStatus').value,
                notes: document.getElementById('notes').value
            };

            // Only include API key for WordPress sites
            if (siteType === 'wordpress') {
                data.api_key = document.getElementById('apiKey').value;
            }

            try {
                if (id) {
                    await SitesAPI.update(id, data);
                    showNotification('Site updated successfully');
                } else {
                    await SitesAPI.create(data);
                    showNotification('Site created successfully');
                }
                modal.hide();
                await loadSites();
            } catch (error) {
                showNotification('Failed to save site: ' + error.message, 'error');
            }
        }

        async function deleteSite(id) {
            if (!confirm('Are you sure you want to delete this site?')) return;

            try {
                await SitesAPI.delete(id);
                showNotification('Site deleted successfully');
                await loadSites();
            } catch (error) {
                showNotification('Failed to delete site: ' + error.message, 'error');
            }
        }

        function copyApiKey(apiKey, event) {
            event.stopPropagation(); // Prevent card click
            navigator.clipboard.writeText(apiKey).then(() => {
                showNotification('API Key copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy API Key', 'error');
            });
        }

        function copyFieldToClipboard(fieldId) {
            const field = document.getElementById(fieldId);
            const text = field.value;
            if (!text) {
                showNotification('Nothing to copy', 'warning');
                return;
            }
            navigator.clipboard.writeText(text).then(() => {
                showNotification('Copied to clipboard!', 'success');
            }).catch(err => {
                console.error('Failed to copy:', err);
                showNotification('Failed to copy', 'error');
            });
        }

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }
    </script>
</body>
</html>
