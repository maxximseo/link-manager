<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="balancePageTitle">Баланс - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/modern-table.css">
    <link rel="stylesheet" href="/css/sidebar.css">
</head>
<body>
    <!-- Content will be wrapped by sidebar.js -->

    <div class="container-fluid">
        <!-- 3 Stat Cards -->
        <div class="row g-4 mb-4">
            <!-- Current Balance - Blue Gradient -->
            <div class="col-md-4">
                <div class="balance-stat-card card-blue">
                    <div class="card-circle card-circle-lg"></div>
                    <div class="card-circle card-circle-sm"></div>
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="currentBalanceLabel">Текущий баланс</span>
                            <div class="card-icon">
                                <i class="bi bi-wallet2"></i>
                            </div>
                        </div>
                        <p class="card-value">$<span id="currentBalance">0.00</span></p>
                        <button class="btn-deposit" data-bs-toggle="modal" data-bs-target="#depositModal">
                            <i class="bi bi-plus"></i> <span data-i18n="depositBtn">Пополнить</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Total Spent - White -->
            <div class="col-md-4">
                <div class="balance-stat-card card-white">
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="totalSpentLabel">Потрачено всего</span>
                            <div class="card-icon">
                                <i class="bi bi-graph-up-arrow"></i>
                            </div>
                        </div>
                        <p class="card-value">$<span id="totalSpent">0.00</span></p>
                        <span class="card-subtitle" data-i18n="allTimeSubtitle">За все время</span>
                    </div>
                </div>
            </div>

            <!-- Renewal Discount - Amber -->
            <div class="col-md-4">
                <div class="balance-stat-card card-amber">
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="renewalDiscountLabel">Скидка на продление</span>
                            <div class="card-icon">
                                <i class="bi bi-gift"></i>
                            </div>
                        </div>
                        <p class="card-value"><span id="renewalTotalDiscount">40</span>%</p>
                        <div class="card-subtitle">
                            <span><span data-i18n="baseDiscount">30% базовая</span> + <span id="renewalPersonalDiscount">10</span>%</span>
                            <span class="info-badge"><i class="bi bi-info"></i></span>
                            <span data-i18n="maxDiscount">Макс 60%</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Locked Bonus Card (shown only if user has locked bonus) -->
        <div id="lockedBonusCard" class="locked-bonus-card mb-4" style="display: none;">
            <div class="locked-bonus-icon">
                <i class="bi bi-lock-fill"></i>
            </div>
            <div class="locked-bonus-info">
                <h5 data-i18n="lockedBonus">Заблокированный бонус</h5>
                <p class="locked-bonus-amount">$<span id="lockedBonusAmount">50.00</span></p>
            </div>
            <div class="locked-bonus-hint">
                <i class="bi bi-info-circle"></i>
                <span>
                    <span data-i18n="depositToUnlock">Пополните баланс на</span>
                    <strong>$<span id="unlockAmount">100</span></strong>
                    <span data-i18n="toUnlockBonus">чтобы разблокировать бонус</span>
                </span>
            </div>
        </div>

        <!-- Discount Progress -->
        <div class="discount-progress-card">
            <h5 class="card-title"><span data-i18n="yourDiscount">Ваша скидка:</span> <span id="currentDiscount">0</span>% <span id="discountTier" data-i18n="tierStandard">Стандарт</span></h5>
            <p class="card-subtitle" id="discountProgressMessage">
                <span data-i18n="progressToNextTier">Прогресс до следующего уровня</span> •
                <span class="highlight-text"><span data-i18n="spendMore">Потратьте еще</span> $<span id="amountToNextTier">800</span> <span data-i18n="toGetDiscount">для получения скидки</span> <span id="nextTierDiscount">10</span>% (<span id="nextTierName">Bronze</span>)</span>
            </p>

            <!-- Enhanced Progress Bar -->
            <div class="progress-stats mb-2">
                <span class="progress-spent"><span class="fw-semibold text-dark" id="progressSpentValue">$0.00</span> <span data-i18n="spent">потрачено</span></span>
                <span class="progress-goal"><span data-i18n="goal">Цель:</span> <span class="fw-semibold text-amber" id="progressGoalValue">$1,000</span></span>
            </div>
            <div class="progress-modern-wrapper">
                <div class="progress-modern">
                    <div class="progress-bar-modern" id="discountProgress" style="width: 0%;"></div>
                    <!-- Progress indicator dot -->
                    <div class="progress-indicator" id="progressIndicator" style="left: 0%;">
                        <div class="progress-dot"></div>
                        <div class="progress-tooltip" id="progressTooltip">$0</div>
                    </div>
                </div>
            </div>
            <div class="progress-footer">
                <span class="progress-percent"><span id="discountProgressText">0</span>% <span data-i18n="completed">выполнено</span></span>
                <span class="progress-remaining"><span data-i18n="remaining">Осталось:</span> <span class="fw-semibold text-amber" id="progressRemainingValue">$1,000</span></span>
            </div>
        </div>

        <!-- Discount Tiers Table -->
        <div class="discount-tiers-table mb-4">
            <div class="table-header">
                <h5 data-i18n="discountTiersTitle">Уровни скидок</h5>
            </div>
            <div class="table-responsive">
                <table class="table mb-0">
                    <thead>
                        <tr>
                            <th data-i18n="tierLevel">Уровень</th>
                            <th data-i18n="tierMinAmount">Минимальная сумма</th>
                            <th data-i18n="tierDiscount">Скидка</th>
                            <th data-i18n="tierStatus">Статус</th>
                        </tr>
                    </thead>
                    <tbody id="discountTiersTable">
                        <tr>
                            <td colspan="4" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                <span data-i18n="loading">Загрузка...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Transactions History - Modern Card Style -->
        <div class="modern-card mb-4">
            <div class="modern-card-header d-flex justify-content-between align-items-center flex-wrap gap-3">
                <div>
                    <h2 data-i18n="transactionsHistory">История транзакций</h2>
                    <p data-i18n="allBalanceOperations">Все операции с вашим балансом</p>
                </div>
                <div class="d-flex gap-2">
                    <button class="btn-export btn-csv" onclick="exportTransactions('csv')">
                        <i class="bi bi-file-earmark-spreadsheet"></i> CSV
                    </button>
                    <button class="btn-export btn-json" onclick="exportTransactions('json')">
                        <i class="bi bi-filetype-json"></i> JSON
                    </button>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table1">
                    <thead>
                        <tr>
                            <th class="col-id">ID</th>
                            <th class="col-date" data-i18n="thDate">Дата</th>
                            <th data-i18n="thType">Тип</th>
                            <th class="col-money" data-i18n="thAmount">Сумма</th>
                            <th class="col-money" data-i18n="thBalance">Баланс</th>
                            <th data-i18n="thDescription">Описание</th>
                        </tr>
                    </thead>
                    <tbody id="transactionsTable">
                        <tr>
                            <td colspan="6" class="text-center text-muted py-4">
                                <div class="spinner-border spinner-border-sm text-primary me-2"></div>
                                <span data-i18n="loading">Загрузка...</span>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
            <!-- Pagination -->
            <div class="pagination-wrapper" id="transactionsPagination">
                <div class="pagination-left">
                    <span data-i18n="showLabel">Показать:</span>
                    <select id="itemsPerPage" onchange="changeItemsPerPage(this.value)">
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                        <option value="500">500</option>
                    </select>
                    <span data-i18n="recordsPerPage">записей на странице</span>
                </div>
                <div class="pagination-right">
                    <span class="pagination-info" id="paginationInfo">Показано 1–100 из 100</span>
                    <div class="pagination-buttons">
                        <button class="pagination-arrow" id="prevPage" onclick="goToPrevPage()">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <div id="pageNumbers"></div>
                        <button class="pagination-arrow" id="nextPage" onclick="goToNextPage()">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modern Deposit Modal -->
    <div class="modal fade" id="depositModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content deposit-modal-modern">
                <!-- Gradient Header -->
                <div class="deposit-modal-header">
                    <div class="deposit-header-content">
                        <div class="deposit-header-icon">
                            <i class="bi bi-wallet2"></i>
                        </div>
                        <div class="deposit-header-text">
                            <h5 class="deposit-title" data-i18n="depositModalTitle">Пополнение баланса</h5>
                            <p class="deposit-subtitle" data-i18n="depositModalSubtitle">Выберите сумму пополнения</p>
                        </div>
                    </div>
                    <button type="button" class="deposit-close-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>

                <div class="deposit-modal-body">
                    <!-- Step 1: Enter Amount -->
                    <div id="depositStep1">
                        <!-- Info Block -->
                        <div class="deposit-info-block">
                            <div class="deposit-info-icon">
                                <i class="bi bi-info-circle-fill"></i>
                            </div>
                            <div class="deposit-info-content">
                                <h6 data-i18n="cryptoPayment">Оплата криптовалютой</h6>
                                <p data-i18n="cryptoList">USDT, BTC, ETH, LTC, TRX и другие</p>
                            </div>
                        </div>

                        <!-- Amount Input -->
                        <div class="deposit-amount-section">
                            <label class="deposit-amount-label">
                                <i class="bi bi-currency-dollar"></i>
                                <span data-i18n="depositAmountLabel">Сумма пополнения</span>
                            </label>
                            <div class="deposit-amount-input-wrapper">
                                <span class="deposit-currency-symbol">$</span>
                                <input type="number" class="deposit-amount-input" id="depositAmount" min="10" max="10000" step="1" value="100" placeholder="100">
                            </div>
                            <p class="deposit-amount-hint">
                                <span data-i18n="minLabel">Минимум:</span> $<span id="minDepositAmount">10</span>, <span data-i18n="maxLabel">Максимум:</span> $<span id="maxDepositAmount">10 000</span>
                            </p>
                        </div>
                    </div>

                    <!-- Step 2: Invoice Created -->
                    <div id="depositStep2" style="display: none;">
                        <div class="deposit-success-block">
                            <div class="deposit-success-icon">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <h6 data-i18n="invoiceCreated">Счёт создан!</h6>
                        </div>
                        <div class="deposit-invoice-info">
                            <h3 class="deposit-invoice-amount">$<span id="invoiceAmount">0</span></h3>
                            <p class="deposit-invoice-expiry"><span data-i18n="validUntil">Действителен до:</span> <span id="invoiceExpiry">-</span></p>
                        </div>
                        <a href="#" target="_blank" class="deposit-pay-btn" id="paymentLink">
                            <i class="bi bi-box-arrow-up-right"></i> <span data-i18n="goToPayment">Перейти к оплате</span>
                        </a>
                        <div class="deposit-warning-block">
                            <i class="bi bi-clock"></i>
                            <span data-i18n="paymentProcessingNote">После оплаты баланс пополнится автоматически в течение 1-5 минут.</span>
                        </div>
                    </div>

                    <!-- Pending Invoices -->
                    <div id="pendingInvoicesSection" class="mt-4" style="display: none;">
                        <div class="deposit-pending-header">
                            <i class="bi bi-hourglass-split"></i>
                            <span data-i18n="pendingPayments">Ожидающие оплаты</span>
                        </div>
                        <div id="pendingInvoicesList"></div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="deposit-modal-footer">
                    <button type="button" class="deposit-btn-secondary" data-bs-dismiss="modal" id="closeDepositModal" data-i18n="closeBtn">
                        Закрыть
                    </button>
                    <button type="button" class="deposit-btn-primary" onclick="createPaymentInvoice()" id="createInvoiceBtn">
                        <i class="bi bi-credit-card"></i>
                        <span data-i18n="createInvoiceBtn">Создать счёт на оплату</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/badge-utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script src="/js/translations.js"></script>
    <script>
        // Initialize sidebar navigation with i18n support
        const lang = getLang();
        SidebarNav.init({
            activePage: 'balance',
            pageTitle: lang === 'en' ? 'Balance & Payments' : 'Баланс и платежи',
            pageSubtitle: lang === 'en' ? 'Financial management and transaction history' : 'Управление финансами и история транзакций',
            pageIcon: 'wallet2',
            pageIconGradient: 'gradient-yellow-orange'
        });
        // Apply translations after DOM is ready
        if (typeof applyTranslations === 'function') {
            applyTranslations();
        }
    </script>
    <script src="/js/balance.js"></script>
</body>
</html>
