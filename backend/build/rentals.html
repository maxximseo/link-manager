<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title data-i18n="rentalsPageTitle">Аренда слотов - Link Manager</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="/css/styles.css">
    <link rel="stylesheet" href="/css/modern-table.css">
    <link rel="stylesheet" href="/css/sidebar.css">
    <style>
        /* Custom styles for rentals table - copied from sites.html */
        .table-responsive {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        /* Card border styling */
        .card {
            border: 1px solid #e5e7eb;
            border-radius: 16px;
            overflow: hidden;
        }

        /* === SEO Metrics columns - голубой фон как в placements-manager === */
        .seo-metric-th,
        .seo-metric-td {
            background: #eff6ff !important;
        }

        .seo-metric-th {
            color: #1d4ed8 !important;
            font-weight: 600 !important;
        }

        /* Sites Table - стиль как на dashboard */
        .sites-table {
            width: 100%;
            border-collapse: collapse;
        }

        .sites-table thead {
            background: #f9fafb;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .sites-table th {
            padding: 12px 8px;
            text-align: left;
            font-size: 11px;
            font-weight: 500;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            border-bottom: 1px solid #e5e7eb;
            white-space: nowrap;
        }

        .sites-table th:first-child {
            padding-left: 16px;
        }

        .sites-table tbody tr {
            border-bottom: 1px solid #f3f4f6;
            transition: background 0.15s;
        }

        .sites-table tbody tr:hover {
            background: #f9fafb;
        }

        .sites-table td {
            padding: 10px 8px;
            font-size: 13px;
            color: #374151;
            vertical-align: middle;
        }

        .sites-table td:first-child {
            padding-left: 16px;
        }

        /* Progress bar custom styling */
        .progress {
            background-color: #e9ecef;
            border-radius: 4px;
        }

        .slots-progress {
            min-width: 60px;
            height: 6px;
        }

        /* Purple badge for rental status */
        .badge.bg-purple {
            background: linear-gradient(135deg, #8b5cf6, #6366f1) !important;
            color: white;
        }

        /* Pending approval row styling */
        .rental-pending-row {
            background-color: #fffbeb !important;
        }
        .rental-pending-row:hover {
            background-color: #fef3c7 !important;
        }

        /* Icon box styling */
        .icon-box {
            width: 48px;
            height: 48px;
            border-radius: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .icon-box.purple {
            background: linear-gradient(135deg, #f3e8ff 0%, #e0e7ff 100%);
        }

        .icon-box.purple i {
            color: #9333ea;
            font-size: 1.5rem;
        }

        /* Rejected row styling */
        .rental-rejected-row {
            background-color: #f3f4f6 !important;
            opacity: 0.7;
        }

        /* Action buttons for pending */
        .btn-approve {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }
        .btn-approve:hover {
            background: linear-gradient(135deg, #16a34a, #15803d);
            color: white;
        }
        .btn-reject {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            border: none;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
        }
        .btn-reject:hover {
            background: linear-gradient(135deg, #dc2626, #b91c1c);
            color: white;
        }

        /* Auto-renewal switch */
        .form-check.form-switch .form-check-input {
            cursor: pointer;
        }
    </style>
</head>
<body>
    <!-- Content will be wrapped by sidebar.js -->

    <div class="container-fluid">
        <!-- 3 Stat Cards -->
        <div class="row g-4 mb-4">
            <!-- Active Rentals - Blue Gradient -->
            <div class="col-md-4">
                <div class="balance-stat-card card-blue">
                    <div class="card-circle card-circle-lg"></div>
                    <div class="card-circle card-circle-sm"></div>
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="activeRentals">Активных аренд</span>
                            <div class="card-icon">
                                <i class="bi bi-key"></i>
                            </div>
                        </div>
                        <p class="card-value"><span id="activeRentalsCount">0</span></p>
                        <span class="card-subtitle" data-i18n="asATenant">Как арендатор</span>
                    </div>
                </div>
            </div>

            <!-- Available Slots - White -->
            <div class="col-md-4">
                <div class="balance-stat-card card-white">
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="availableSlots">Доступно слотов</span>
                            <div class="card-icon">
                                <i class="bi bi-boxes"></i>
                            </div>
                        </div>
                        <p class="card-value"><span id="availableSlotsCount">0</span></p>
                        <span class="card-subtitle" data-i18n="forPlacements">Для размещений</span>
                    </div>
                </div>
            </div>

            <!-- Pending Requests - Amber -->
            <div class="col-md-4">
                <div class="balance-stat-card card-amber">
                    <div class="card-content">
                        <div class="card-header-row">
                            <span class="card-label" data-i18n="pendingRequests">Ожидает подтверждения</span>
                            <div class="card-icon">
                                <i class="bi bi-hourglass-split"></i>
                            </div>
                        </div>
                        <p class="card-value"><span id="pendingCount">0</span></p>
                        <span class="card-subtitle" data-i18n="pendingApproval">Запросов на аренду</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Main Table Card -->
        <div class="card">
            <div class="card-header modern-card-header">
                <div>
                    <h2 data-i18n="myRentals">Мои аренды</h2>
                    <p data-i18n="rentalsSubtitle">Сайты, слоты которых вы арендуете</p>
                </div>
            </div>
            <div class="card-body" style="padding: 0;">
                <!-- Empty state -->
                <div class="notification-empty" id="emptyState" style="display: none;">
                    <i class="bi bi-inbox"></i>
                    <h5 data-i18n="noActiveRentals">Нет аренд</h5>
                    <p data-i18n="noActiveRentalsHint">Когда владелец сайта сдаст вам слоты в аренду, они появятся здесь</p>
                </div>

                <!-- Table -->
                <div class="table-responsive" id="tableContainer">
                    <table class="sites-table">
                        <thead>
                            <tr>
                                <th data-i18n="siteColumn">Сайт</th>
                                <th class="text-center" data-i18n="statusColumn">Статус</th>
                                <th class="text-center" data-i18n="homepageLinks">Главные</th>
                                <th class="text-center" data-i18n="guestPosts">Гест-посты</th>
                                <th class="text-center" data-i18n="expiresColumn">Истекает</th>
                                <th class="text-center" data-i18n="autoRenewal">Продление</th>
                                <th class="text-center seo-metric-th">DR</th>
                                <th class="text-center seo-metric-th">DA</th>
                                <th class="text-center seo-metric-th">TF</th>
                                <th class="text-center seo-metric-th">CF</th>
                                <th class="text-center seo-metric-th">RD</th>
                                <th class="text-center seo-metric-th">RDm</th>
                                <th class="text-center seo-metric-th">Norm</th>
                                <th class="text-center seo-metric-th">KW</th>
                                <th class="text-center seo-metric-th">Traf</th>
                                <th class="text-center">GEO</th>
                                <th class="text-center" data-i18n="typeColumn">Тип</th>
                                <th data-i18n="ownerColumn">Владелец</th>
                            </tr>
                        </thead>
                        <tbody id="rentalsTableBody">
                            <!-- Rendered by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Approve Confirmation Modal -->
    <div class="modal fade" id="approveModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content deposit-modal-modern">
                <div class="deposit-modal-header" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                    <div class="deposit-header-content">
                        <div class="deposit-header-icon">
                            <i class="bi bi-check-circle"></i>
                        </div>
                        <div class="deposit-header-text">
                            <h5 class="deposit-title" data-i18n="approveRentalTitle">Подтвердить аренду</h5>
                            <p class="deposit-subtitle" data-i18n="approveRentalSubtitle">Средства будут списаны с вашего баланса</p>
                        </div>
                    </div>
                    <button type="button" class="deposit-close-btn" data-bs-dismiss="modal">
                        <i class="bi bi-x-lg"></i>
                    </button>
                </div>
                <div class="deposit-modal-body">
                    <div class="deposit-info-block mb-3">
                        <div class="deposit-info-icon"><i class="bi bi-globe"></i></div>
                        <div class="deposit-info-content">
                            <h6 data-i18n="siteLabel">Сайт</h6>
                            <p class="fw-bold mb-0" id="approveSiteName">-</p>
                        </div>
                    </div>
                    <div class="deposit-info-block mb-3">
                        <div class="deposit-info-icon"><i class="bi bi-boxes"></i></div>
                        <div class="deposit-info-content">
                            <h6 data-i18n="slotsLabel">Количество слотов</h6>
                            <p class="fw-bold mb-0" id="approveSlotsCount">-</p>
                        </div>
                    </div>
                    <div class="deposit-amount-section">
                        <label class="deposit-amount-label">
                            <i class="bi bi-currency-dollar"></i>
                            <span data-i18n="totalCost">Стоимость</span>
                        </label>
                        <div class="d-flex align-items-baseline gap-3 mb-2">
                            <span class="fs-2 fw-bold text-success" id="approvePrice">$0.00</span>
                        </div>
                    </div>
                    <div class="alert alert-warning d-flex align-items-center gap-2 mt-3">
                        <i class="bi bi-exclamation-triangle"></i>
                        <span data-i18n="approveWarning">После подтверждения средства будут списаны с вашего баланса</span>
                    </div>
                </div>
                <div class="deposit-modal-footer">
                    <button type="button" class="deposit-btn-secondary" data-bs-dismiss="modal" data-i18n="cancelBtn">Отмена</button>
                    <button type="button" class="deposit-btn-primary" onclick="confirmApprove()" style="background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);">
                        <i class="bi bi-check-lg"></i>
                        <span data-i18n="confirmApprove">Подтвердить</span>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/js/security.js"></script>
    <script src="/js/auth.js"></script>
    <script src="/js/badge-utils.js"></script>
    <script src="/js/api.js"></script>
    <script src="/js/sidebar.js"></script>
    <script src="/js/translations.js"></script>

    <script>
        // Initialize sidebar navigation with i18n support
        const lang = getLang();
        SidebarNav.init({
            activePage: 'rentals',
            pageTitle: lang === 'en' ? 'Slot Rentals' : 'Аренда слотов',
            pageSubtitle: lang === 'en' ? 'Manage your slot rentals' : 'Управление арендой слотов',
            pageIcon: 'key-fill',
            pageIconGradient: 'gradient-purple-pink'
        });
        if (typeof applyTranslations === 'function') {
            applyTranslations();
        }
    </script>

    <script>
        // State
        let rentals = [];
        let selectedRentalId = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', async () => {
            if (!isAuthenticated()) {
                window.location.href = '/login.html';
                return;
            }
            await loadRentals();
        });

        // Load rentals from API
        async function loadRentals() {
            try {
                const token = getToken();
                const response = await fetch('/api/rentals?role=tenant', {
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                if (response.ok) {
                    const result = await response.json();
                    rentals = result.data || [];
                    renderTable();
                    updateStats();
                }
            } catch (error) {
                console.error('Error loading rentals:', error);
                showAlert('Ошибка загрузки аренд', 'danger');
            }
        }

        // Update stats cards
        function updateStats() {
            const activeRentals = rentals.filter(r => r.status === 'active');
            const pendingRentals = rentals.filter(r => r.status === 'pending_approval');
            const availableSlots = activeRentals.reduce((sum, r) => sum + (r.slots_count - r.slots_used), 0);

            document.getElementById('activeRentalsCount').textContent = activeRentals.length;
            document.getElementById('availableSlotsCount').textContent = availableSlots;
            document.getElementById('pendingCount').textContent = pendingRentals.length;
        }

        // Format number with K/M suffix
        function formatNumber(num) {
            if (num >= 1000000) return (num / 1000000).toFixed(1) + 'M';
            if (num >= 1000) return (num / 1000).toFixed(1) + 'K';
            return num || 0;
        }

        // Get progress bar color
        function getProgressColor(percent) {
            if (percent >= 90) return 'bg-danger';
            if (percent >= 70) return 'bg-warning';
            return 'bg-success';
        }

        // Get site type badge
        function getSiteTypeBadgeLocal(siteType) {
            if (siteType === 'static_php') {
                return '<span class="badge bg-secondary">Static</span>';
            }
            return '<span class="badge bg-primary">WordPress</span>';
        }

        // Render single rental row
        function renderRentalRow(rental) {
            const slotsUsed = rental.slots_used || 0;
            const slotsTotal = rental.slots_count || 0;
            const slotsPercent = slotsTotal > 0 ? Math.round((slotsUsed / slotsTotal) * 100) : 0;
            const expiresDate = formatDate(rental.expires_at);

            // Row class based on status
            let rowClass = '';
            if (rental.status === 'pending_approval') rowClass = 'rental-pending-row';
            else if (rental.status === 'rejected') rowClass = 'rental-rejected-row';

            // Status cell
            let statusCell = '';
            if (rental.status === 'pending_approval') {
                statusCell = `
                    <td class="text-center">
                        <div class="d-flex gap-1 justify-content-center">
                            <button class="btn-approve" onclick="openApproveModal(${rental.id})" title="Подтвердить">
                                <i class="bi bi-check-lg"></i>
                            </button>
                            <button class="btn-reject" onclick="rejectRental(${rental.id})" title="Отклонить">
                                <i class="bi bi-x-lg"></i>
                            </button>
                        </div>
                    </td>
                `;
            } else if (rental.status === 'active') {
                statusCell = `<td class="text-center"><span class="badge bg-purple">Аренда</span></td>`;
            } else if (rental.status === 'rejected') {
                statusCell = `<td class="text-center"><span class="badge bg-secondary">Отклонено</span></td>`;
            } else if (rental.status === 'expired') {
                statusCell = `<td class="text-center"><span class="badge bg-danger">Истекла</span></td>`;
            } else {
                statusCell = `<td class="text-center"><span class="badge bg-secondary">${escapeHtml(rental.status)}</span></td>`;
            }

            // Auto-renewal toggle (only for active rentals)
            let renewalCell = '';
            if (rental.status === 'active') {
                renewalCell = `
                    <td class="text-center">
                        <div class="form-check form-switch d-flex justify-content-center">
                            <input class="form-check-input" type="checkbox" id="autoRenewal${rental.id}"
                                   ${rental.auto_renewal ? 'checked' : ''}
                                   onchange="toggleAutoRenewal(${rental.id}, this.checked)">
                        </div>
                    </td>
                `;
            } else {
                renewalCell = `<td class="text-center"><span class="text-muted">—</span></td>`;
            }

            // Guest posts info
            const maxArticles = rental.max_articles || 0;
            const guestPostsCell = maxArticles > 0
                ? `<span class="text-muted">0/${maxArticles}</span>`
                : '<span class="text-muted">—</span>';

            return `
                <tr class="${rowClass}">
                    <td>
                        <a href="${escapeHtml(rental.site_url || '#')}" target="_blank" class="text-decoration-none fw-medium">
                            ${escapeHtml(rental.site_name || extractDomain(rental.site_url))}
                            <i class="bi bi-box-arrow-up-right ms-1" style="font-size: 0.7rem; opacity: 0.5;"></i>
                        </a>
                    </td>
                    ${statusCell}
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <span class="fw-semibold">${slotsUsed}/${slotsTotal}</span>
                            <div class="progress slots-progress flex-grow-1">
                                <div class="progress-bar ${getProgressColor(slotsPercent)}" style="width: ${slotsPercent}%"></div>
                            </div>
                        </div>
                    </td>
                    <td>${guestPostsCell}</td>
                    <td><span class="date-text">${expiresDate}</span></td>
                    ${renewalCell}
                    <td class="text-center seo-metric-td">${rental.dr || 0}</td>
                    <td class="text-center seo-metric-td">${rental.da || 0}</td>
                    <td class="text-center seo-metric-td">${rental.tf || 0}</td>
                    <td class="text-center seo-metric-td">${rental.cf || 0}</td>
                    <td class="text-center seo-metric-td">${formatNumber(rental.ref_domains || 0)}</td>
                    <td class="text-center seo-metric-td">${formatNumber(rental.rd_main || 0)}</td>
                    <td class="text-center seo-metric-td">${formatNumber(rental.norm || 0)}</td>
                    <td class="text-center seo-metric-td">${formatNumber(rental.keywords || 0)}</td>
                    <td class="text-center seo-metric-td">${formatNumber(rental.traffic || 0)}</td>
                    <td class="text-center">${escapeHtml(rental.geo || '—')}</td>
                    <td class="text-center">${getSiteTypeBadgeLocal(rental.site_type)}</td>
                    <td>${escapeHtml(rental.owner_username || '—')}</td>
                </tr>
            `;
        }

        // Extract domain from URL
        function extractDomain(url) {
            if (!url) return 'N/A';
            try {
                const hostname = new URL(url).hostname;
                return hostname.replace('www.', '');
            } catch {
                return url;
            }
        }

        // Render table
        function renderTable() {
            const tbody = document.getElementById('rentalsTableBody');
            const tableContainer = document.getElementById('tableContainer');
            const emptyState = document.getElementById('emptyState');

            if (rentals.length === 0) {
                tableContainer.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }

            tableContainer.style.display = 'block';
            emptyState.style.display = 'none';

            // Sort: pending_approval first, then active, then others
            const sorted = [...rentals].sort((a, b) => {
                const order = { 'pending_approval': 0, 'active': 1, 'expired': 2, 'rejected': 3, 'cancelled': 4 };
                return (order[a.status] || 5) - (order[b.status] || 5);
            });

            tbody.innerHTML = sorted.map(renderRentalRow).join('');
        }

        // Toggle auto-renewal
        async function toggleAutoRenewal(rentalId, enabled) {
            try {
                const token = getToken();
                const response = await fetch(`/api/rentals/${rentalId}/auto-renewal`, {
                    method: 'PATCH',
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ enabled })
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    if (enabled) {
                        const renewalPrice = result.data.renewal_price || 0;
                        showAlert(`Авто-продление включено. Стоимость продления: $${renewalPrice.toFixed(2)} (скидка 30%)`, 'success');
                    } else {
                        showAlert('Авто-продление отключено', 'info');
                    }
                } else {
                    showAlert(result.error || 'Ошибка', 'danger');
                    // Revert checkbox
                    document.getElementById(`autoRenewal${rentalId}`).checked = !enabled;
                }
            } catch (error) {
                console.error('Error toggling auto-renewal:', error);
                showAlert('Ошибка при изменении настройки', 'danger');
                document.getElementById(`autoRenewal${rentalId}`).checked = !enabled;
            }
        }

        // Open approve modal
        function openApproveModal(rentalId) {
            const rental = rentals.find(r => r.id === rentalId);
            if (!rental) return;

            selectedRentalId = rentalId;

            document.getElementById('approveSiteName').textContent = rental.site_name || extractDomain(rental.site_url);
            document.getElementById('approveSlotsCount').textContent = rental.slots_count + ' слотов';
            document.getElementById('approvePrice').textContent = '$' + parseFloat(rental.total_price || 0).toFixed(2);

            const modal = new bootstrap.Modal(document.getElementById('approveModal'));
            modal.show();
        }

        // Confirm approve
        async function confirmApprove() {
            if (!selectedRentalId) return;

            try {
                const token = getToken();
                const response = await fetch(`/api/rentals/${selectedRentalId}/approve`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert('Аренда подтверждена!', 'success');
                    bootstrap.Modal.getInstance(document.getElementById('approveModal')).hide();
                    await loadRentals();
                } else {
                    showAlert(result.error || 'Ошибка при подтверждении', 'danger');
                }
            } catch (error) {
                console.error('Error approving rental:', error);
                showAlert('Ошибка при подтверждении аренды', 'danger');
            }
        }

        // Reject rental
        async function rejectRental(rentalId) {
            if (!confirm('Отклонить запрос на аренду?')) return;

            try {
                const token = getToken();
                const response = await fetch(`/api/rentals/${rentalId}/reject`, {
                    method: 'POST',
                    headers: { 'Authorization': `Bearer ${token}` }
                });

                const result = await response.json();

                if (response.ok && result.success) {
                    showAlert('Запрос отклонён', 'info');
                    await loadRentals();
                } else {
                    showAlert(result.error || 'Ошибка при отклонении', 'danger');
                }
            } catch (error) {
                console.error('Error rejecting rental:', error);
                showAlert('Ошибка при отклонении', 'danger');
            }
        }
    </script>
</body>
</html>
